<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>ELIMINATOR</title>

  <style>
    /* =========================================================
       THEME ‚Äî vitre / futuriste soft (2 th√®mes uniquement)
       ========================================================= */
    :root{
      --bg:#0b0f17;
      --fg:#eaf0ff;
      --muted:#a7b0c6;

      --line: rgba(255,255,255,.12);
      --glass: rgba(18,22,36,.62);
      --glass2: rgba(18,22,36,.38);

      --shadow: 0 18px 70px rgba(0,0,0,.50);
      --blur: blur(16px);

      --accent: #7db9ff;   /* bleu doux */
      --accent2:#7cffc7;   /* mint doux */

      --radius: 22px;
      --radius2: 30px;

      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;

      --centerMax: 980px;

      --barH: 58px;
      --ethH: 18px;
    }

    [data-theme="light"]{
      --bg:#f4f7ff;
      --fg:#0b1324;
      --muted:#5b667d;

      --line: rgba(11,19,36,.12);
      --glass: rgba(255,255,255,.72);
      --glass2: rgba(255,255,255,.46);

      --shadow: 0 16px 60px rgba(15,25,45,.18);

      --accent:#2a67ff;
      --accent2:#16c784;
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      font-family: var(--sans);
      color: var(--fg);
      background:
        radial-gradient(1000px 700px at 10% -10%, rgba(125,185,255,.10), transparent 60%),
        radial-gradient(900px 650px at 90% 0%, rgba(124,255,199,.08), transparent 55%),
        var(--bg);
      overflow-x:hidden;
    }

    /* =========================================================
       CENTERED LAYOUT (vertical center)
       ========================================================= */
    .wrap{
      min-height: 100vh;
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;   /* <<< centrage vertical r√©el */
      gap: 18px;
      max-width: var(--centerMax);
      margin: 0 auto;
      padding: 24px 14px 38px;
    }

    .topRow{
      width:100%;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
    }

    .group{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; }

    .btn{
      border:1px solid var(--line);
      background: var(--glass);
      backdrop-filter: var(--blur);
      -webkit-backdrop-filter: var(--blur);
      color: var(--fg);
      border-radius: 999px;
      padding: 10px 12px;
      font-weight: 900;
      cursor:pointer;
      user-select:none;
      box-shadow: 0 10px 30px rgba(0,0,0,.08);
      transition: transform .08s ease, background .2s ease, border-color .2s ease;
    }
    .btn:active{ transform: translateY(1px) scale(.99); }
    .btn.small{ padding: 8px 10px; background: var(--glass2); box-shadow:none; }
    .btn.ghost{ background:transparent; box-shadow:none; }
    .btn.primary{
      border-color: color-mix(in oklab, var(--accent) 55%, var(--line));
      background: color-mix(in oklab, var(--accent) 10%, var(--glass));
    }

    .toggle{
      display:inline-flex;
      border:1px solid var(--line);
      border-radius:999px;
      overflow:hidden;
      background:var(--glass);
      backdrop-filter: var(--blur);
      -webkit-backdrop-filter: var(--blur);
      box-shadow: 0 10px 30px rgba(0,0,0,.08);
    }
    .toggle button{
      border:0;
      background:transparent;
      color:var(--muted);
      padding: 9px 12px;
      cursor:pointer;
      font-weight: 950;
      font-family: var(--mono);
      letter-spacing:.4px;
    }
    .toggle button.active{
      color:var(--fg);
      background: color-mix(in oklab, var(--accent) 12%, transparent);
    }

    .hud{
      border:1px solid var(--line);
      background:var(--glass);
      backdrop-filter: var(--blur);
      -webkit-backdrop-filter: var(--blur);
      border-radius:999px;
      padding: 9px 12px;
      box-shadow: 0 10px 30px rgba(0,0,0,.08);
      display:flex;
      gap: 14px;
      align-items:center;
      font-family: var(--mono);
      font-size: 12px;
      color: var(--muted);
      white-space:nowrap;
    }
    .hud b{ color: var(--fg); font-weight: 950; }

    .titleBlock{
      width:100%;
      display:flex;
      flex-direction:column;
      align-items:center;
      text-align:center;
      gap: 8px;
      margin-top: 2px;
    }
    .title{
      margin:0;
      font-weight: 980;
      letter-spacing: .6px;
      font-size: clamp(44px, 6vw, 86px);
      line-height: .96;
      text-shadow: 0 18px 50px rgba(0,0,0,.14);
    }
    .subtitle{
      margin:0;
      color: var(--muted);
      font-weight: 900;
      letter-spacing: .2px;
      font-size: 14px;
    }

    .block{
      width:100%;
      border:1px solid var(--line);
      border-radius: var(--radius2);
      background: var(--glass);
      backdrop-filter: var(--blur);
      -webkit-backdrop-filter: var(--blur);
      box-shadow: var(--shadow);
      padding: 16px;
    }

    /* Progress block is distinct, and we add spacing below */
    .progressBlock{ margin-top: 6px; }
    .gapAfterProgress{ margin-top: 22px; } /* <<< plus d‚Äôespace */

    .barTrack{
      height: var(--barH);
      border-radius: 999px;
      border:1px solid color-mix(in oklab, var(--line) 90%, transparent);
      background: color-mix(in oklab, var(--line) 20%, transparent);
      overflow:hidden;
      position:relative;
    }
    .barFill{
      height:100%;
      transform-origin:left center;
      transform: scaleX(1);
      background: linear-gradient(90deg,
        color-mix(in oklab, var(--accent) 70%, transparent),
        color-mix(in oklab, var(--accent2) 55%, transparent)
      );
      transition: transform .18s ease;
    }
    .barPct{
      position:absolute;
      inset:0;
      display:flex;
      align-items:center;
      justify-content:center;
      font-family: var(--mono);
      font-weight: 980;
      letter-spacing: .6px;
      color: rgba(255,255,255,.92);
      text-shadow: 0 10px 30px rgba(0,0,0,.35);
      pointer-events:none;
    }
    [data-theme="light"] .barPct{
      color: rgba(255,255,255,.96);
      text-shadow: 0 12px 30px rgba(0,0,0,.34);
    }

    .taskName{
      margin: 0;
      text-align:center;
      font-size: clamp(18px, 2.8vw, 28px);
      font-weight: 980;
      letter-spacing: .2px;
    }

    /* Etherions */
    .ethBox{
      margin-top: 16px;
      border:1px solid var(--line);
      border-radius: var(--radius);
      background: var(--glass2);
      padding: 12px;
    }
    .ethTop{
      display:flex;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
      margin-bottom: 10px;
      font-family: var(--mono);
      font-size: 12px;
      color: var(--muted);
    }
    .ethTop b{ color: var(--fg); }
    .ethTrack{
      height: var(--ethH);
      border-radius: 999px;
      border:1px solid color-mix(in oklab, var(--line) 90%, transparent);
      background: color-mix(in oklab, var(--line) 18%, transparent);
      overflow:hidden;
      position:relative;
    }
    .ethFill{
      height:100%;
      transform-origin:left center;
      transform: scaleX(1);
      background: linear-gradient(90deg,
        color-mix(in oklab, var(--accent) 55%, transparent),
        color-mix(in oklab, var(--accent2) 45%, transparent)
      );
      transition: transform .18s ease;
    }
    .ethTicks{
      position:absolute;
      inset:0;
      display:flex;
      opacity:.6;
      pointer-events:none;
    }
    .ethTicks span{
      flex:1;
      border-right:1px dashed rgba(255,255,255,.20);
    }
    [data-theme="light"] .ethTicks span{
      border-right:1px dashed rgba(11,19,36,.14);
    }

    /* Actions */
    .actionRow{
      margin-top: 18px;
      display:flex;
      gap: 16px;
      justify-content:center;
      align-items:center;
      flex-wrap:wrap;
    }

    /* Roulette bigger */
    .rouletteBtn{
      width: 156px;
      height: 156px;
      border-radius: 30px;
      border:1px solid var(--line);
      background: var(--glass);
      backdrop-filter: var(--blur);
      -webkit-backdrop-filter: var(--blur);
      box-shadow: 0 18px 60px rgba(0,0,0,.18);
      cursor:pointer;
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      gap: 10px;
      user-select:none;
    }
    .rouletteWheel{
      width: 96px;
      height: 96px;
      border-radius: 999px;
      border:2px solid color-mix(in oklab, var(--accent) 55%, var(--line));
      background:
        conic-gradient(
          from 0deg,
          color-mix(in oklab, var(--accent) 22%, transparent),
          color-mix(in oklab, var(--accent2) 20%, transparent),
          color-mix(in oklab, var(--accent) 22%, transparent)
        );
      box-shadow: inset 0 0 0 2px rgba(255,255,255,.10);
      transform: rotate(0deg);
      position:relative;
      display:grid;
      place-items:center;
    }
    .rouletteWheel span{
      font-family: var(--mono);
      font-weight: 980;
      letter-spacing: .9px;
      font-size: 12px;
      color: rgba(255,255,255,.92);
      text-shadow: 0 10px 26px rgba(0,0,0,.35);
      text-transform: uppercase;
      user-select:none;
    }
    [data-theme="light"] .rouletteWheel span{
      color: rgba(255,255,255,.96);
      text-shadow: 0 10px 26px rgba(0,0,0,.35);
    }
    .rouletteBtn.spinning .rouletteWheel{
      animation: spin 900ms cubic-bezier(.2,.8,.2,1);
    }
    @keyframes spin{
      0%{ transform: rotate(0deg); }
      100%{ transform: rotate(1080deg); }
    }

    /* Smash button */
    .smashBtn{
      border:1px solid color-mix(in oklab, var(--accent) 55%, var(--line));
      background: color-mix(in oklab, var(--accent) 8%, var(--glass));
      border-radius: 30px;
      padding: 18px 22px;
      font-weight: 980;
      letter-spacing: .2px;
      cursor:pointer;
      box-shadow: 0 18px 60px rgba(0,0,0,.18);
      user-select:none;
      display:flex;
      align-items:center;
      gap: 10px;
      font-size: 18px;
    }
    .smashBtn:active{ transform: translateY(1px); }

    .bottomBar{
      margin-top: 16px;
      display:flex;
      justify-content:center;
      gap: 10px;
      flex-wrap:wrap;
    }

    /* =========================================================
       Drawer (wider)
       ========================================================= */
    .drawerOverlay{
      position:fixed;
      inset:0;
      background: rgba(0,0,0,.26);
      display:none;
      z-index:60;
    }
    [data-theme="light"] .drawerOverlay{ background: rgba(0,0,0,.12); }
    .drawerOverlay.show{ display:block; }

    .drawer{
      position:fixed;
      top:0;
      left:0;
      height:100%;
      width: min(560px, 94vw); /* <<< plus large */
      background: var(--glass);
      backdrop-filter: var(--blur);
      -webkit-backdrop-filter: var(--blur);
      border-right:1px solid var(--line);
      box-shadow: var(--shadow);
      transform: translateX(-102%);
      transition: transform .22s ease;
      z-index:70;
      display:flex;
      flex-direction:column;
    }
    .drawerOverlay.show .drawer{ transform: translateX(0); }

    .drawerTop{
      padding: 14px 14px 10px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      border-bottom:1px solid var(--line);
    }

    .drawerTabs{
      padding: 10px 14px 0;
      display:flex;
      gap:8px;
      flex-wrap:wrap;
    }
    .tab{
      border:1px solid var(--line);
      background: var(--glass2);
      border-radius: 999px;
      padding: 8px 10px;
      font-weight: 980;
      color: var(--muted);
      cursor:pointer;
      user-select:none;
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: .6px;
      font-family: var(--mono);
    }
    .tab.active{
      color: var(--fg);
      border-color: color-mix(in oklab, var(--accent) 55%, var(--line));
      background: color-mix(in oklab, var(--accent) 10%, var(--glass2));
    }

    .drawerBody{
      padding: 12px 14px 16px;
      overflow:auto;
    }

    .card{
      border:1px solid var(--line);
      border-radius: var(--radius);
      background: var(--glass2);
      padding: 12px;
      margin-bottom: 12px;
    }
    .cardTitle{
      margin:0 0 10px;
      font-weight: 980;
      letter-spacing:.2px;
    }

    textarea, input, select{
      width:100%;
      border:1px solid var(--line);
      background: color-mix(in oklab, var(--glass) 70%, transparent);
      color: var(--fg);
      border-radius: 16px;
      padding: 10px 12px;
      outline:none;
      font-family: var(--sans);
    }
    textarea{ min-height: 130px; resize: vertical; }

    .row{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
    }
    .row > *{ flex:1; min-width: 160px; }

    .help{
      color: var(--muted);
      font-size: 12px;
      line-height: 1.35;
      font-family: var(--mono);
    }

    /* Task list items */
    .taskItem{
      border:1px solid var(--line);
      background: color-mix(in oklab, var(--glass) 60%, transparent);
      border-radius: 18px;
      padding: 10px 10px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      margin-bottom: 8px;
    }
    .taskLeft .name{ font-weight: 980; line-height: 1.15; }
    .taskLeft .sub{
      margin-top: 3px;
      font-family: var(--mono);
      font-size: 12px;
      color: var(--muted);
    }
    .taskAct{ display:flex; gap: 8px; align-items:center; flex-wrap:wrap; }
    .iconBtn{
      border:1px solid var(--line);
      background: var(--glass2);
      border-radius: 14px;
      padding: 8px 10px;
      cursor:pointer;
      font-weight: 980;
      font-family: var(--mono);
      font-size: 12px;
      color: var(--fg);
      user-select:none;
    }
    .iconBtn:active{ transform: translateY(1px); }

    /* =========================================================
       Celebration (auto-hide 15s)
       ========================================================= */
    .celebrateOverlay{
      position:fixed;
      inset:0;
      display:none;
      z-index:90;
      background: rgba(0,0,0,.24);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
    }
    [data-theme="light"] .celebrateOverlay{ background: rgba(0,0,0,.10); }
    .celebrateOverlay.show{ display:block; }

    .celebrateBox{
      position:absolute;
      inset: 0;
      display:flex;
      align-items:center;
      justify-content:center;
      padding: 18px;
    }
    .celebrateCard{
      width: min(820px, 92vw);
      border:1px solid var(--line);
      border-radius: 34px;
      background: var(--glass);
      backdrop-filter: var(--blur);
      -webkit-backdrop-filter: var(--blur);
      box-shadow: var(--shadow);
      padding: 28px 22px;
      text-align:center;
    }
    .celebrateTitle{
      margin:0;
      font-size: clamp(28px, 4.2vw, 52px);
      font-weight: 990;
      letter-spacing: .7px;
      line-height: 1.02;
    }
    .celebrateSub{
      margin: 12px 0 0;
      font-family: var(--mono);
      color: var(--muted);
      font-size: 14px;
      font-weight: 900;
      letter-spacing: .3px;
    }
    .celebrateHint{
      margin: 18px 0 0;
      font-family: var(--mono);
      color: var(--muted);
      font-size: 12px;
    }

    /* =========================================================
       Notes modal (central, not in menu)
       ========================================================= */
    .modalOverlay{
      position:fixed;
      inset:0;
      display:none;
      z-index:88;
      background: rgba(0,0,0,.22);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
    }
    [data-theme="light"] .modalOverlay{ background: rgba(0,0,0,.10); }
    .modalOverlay.show{ display:block; }

    .modalBox{
      position:absolute;
      inset: 0;
      display:flex;
      align-items:center;
      justify-content:center;
      padding: 18px;
    }
    .modalCard{
      width: min(860px, 92vw);
      border:1px solid var(--line);
      border-radius: 34px;
      background: var(--glass);
      backdrop-filter: var(--blur);
      -webkit-backdrop-filter: var(--blur);
      box-shadow: var(--shadow);
      padding: 18px 18px 16px;
    }
    .modalTop{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      margin-bottom: 10px;
    }
    .modalTop h3{
      margin:0;
      font-weight: 980;
      letter-spacing:.3px;
    }
    .noteGrid{
      margin-top: 12px;
      display:grid;
      grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
      gap: 10px;
    }
    .note{
      border:1px solid var(--line);
      border-radius: 18px;
      background: color-mix(in oklab, var(--glass2) 85%, transparent);
      padding: 12px;
    }
    .note .stamp{
      font-family: var(--mono);
      font-size: 11px;
      color: var(--muted);
      margin-bottom: 8px;
    }
    .note .txt{ white-space: pre-wrap; font-weight: 850; }

    /* =========================================================
       Habits ‚Äî single line layout
       ========================================================= */
    .habitLine{
      border:1px solid var(--line);
      border-radius: 18px;
      background: color-mix(in oklab, var(--glass) 60%, transparent);
      padding: 10px;
      margin-bottom: 10px;

      display:flex;
      align-items:center;
      gap: 10px;
      overflow-x:auto;
    }
    .habitName{
      font-weight: 980;
      white-space:nowrap;
      min-width: 220px;
    }
    .habitChecks{
      display:flex;
      gap: 8px;
      align-items:center;
      flex-wrap:nowrap;
    }
    .check{
      width: 22px;
      height: 22px;
      border-radius: 6px;
      border:1px solid var(--line);
      background: var(--glass2);
      cursor:pointer;
      display:grid;
      place-items:center;
      user-select:none;
      font-family: var(--mono);
      font-weight: 980;
      color: var(--fg);
      flex:0 0 auto;
    }
    .check.on{
      background: color-mix(in oklab, var(--accent) 12%, var(--glass2));
      border-color: color-mix(in oklab, var(--accent) 40%, var(--line));
    }
    .habitBtns{
      margin-left:auto;
      display:flex;
      gap:8px;
      flex:0 0 auto;
    }

    /* =========================================================
       Calendar view
       ========================================================= */
    .calWrap{
      display:grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 8px;
    }
    .calCell{
      border:1px solid var(--line);
      border-radius: 16px;
      background: color-mix(in oklab, var(--glass) 55%, transparent);
      padding: 10px;
      min-height: 76px;
      display:flex;
      flex-direction:column;
      gap: 6px;
    }
    .calDay{
      font-family: var(--mono);
      color: var(--muted);
      font-size: 12px;
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:8px;
    }
    .calStats{
      font-family: var(--mono);
      font-size: 12px;
      color: var(--muted);
      line-height:1.35;
    }
    .calBadge{
      font-family: var(--mono);
      font-size: 11px;
      padding: 4px 8px;
      border-radius: 999px;
      border:1px solid var(--line);
      background: var(--glass2);
      color: var(--fg);
      white-space:nowrap;
    }

    /* =========================================================
       Focus mode: keep HUD (your request)
       ========================================================= */
    [data-focus="1"] .subtitle{ display:none; }
    [data-focus="1"] .bottomBar{ display:none; }
    [data-focus="1"] .drawerOverlay.show{ display:none; } /* optional safety */
    [data-focus="1"] .focusExit{ display:flex; justify-content:center; margin-top: 14px; }
    .focusExit{ display:none; }

    /* Mobile tightening */
    @media (max-width: 520px){
      :root{ --barH: 52px; }
      .rouletteBtn{ width: 148px; height: 148px; }
      .rouletteWheel{ width: 90px; height: 90px; }
      .smashBtn{ width:100%; justify-content:center; }
      .topRow{ justify-content:center; }
      .hud{ gap: 10px; }
      .habitName{ min-width: 180px; }
    }
  </style>
</head>

<body data-theme="light" data-focus="0">

  <!-- Celebration -->
  <div class="celebrateOverlay" id="celebrateOverlay" aria-hidden="true">
    <div class="celebrateBox">
      <div class="celebrateCard">
        <h2 class="celebrateTitle" id="celebrateTitle">VICTOIRE</h2>
        <p class="celebrateSub" id="celebrateSub">+1 √©thorion</p>
        <p class="celebrateHint">Clique pour fermer (auto: 15s).</p>
      </div>
    </div>
  </div>

  <!-- Notes modal -->
  <div class="modalOverlay" id="notesOverlay" aria-hidden="true">
    <div class="modalBox">
      <div class="modalCard">
        <div class="modalTop">
          <h3>Notes</h3>
          <div class="group">
            <button class="btn small" id="btnExportNotes">Exporter</button>
            <button class="btn small" id="btnCloseNotes">Fermer</button>
          </div>
        </div>
        <textarea id="noteText" placeholder="√âcris ici. (Persistant : ne dispara√Æt pas au reset)"></textarea>
        <div class="row" style="margin-top:10px;">
          <button class="btn primary" id="btnAddNote">Ajouter</button>
          <button class="btn" id="btnClearNotes">Effacer toutes</button>
        </div>
        <div class="noteGrid" id="notesGrid"></div>
      </div>
    </div>
  </div>

  <!-- Drawer -->
  <div class="drawerOverlay" id="drawerOverlay">
    <aside class="drawer" role="dialog" aria-modal="true">
      <div class="drawerTop">
        <button class="btn small" id="btnDrawerClose">Fermer</button>
        <div class="toggle" title="Th√®me">
          <button id="themeLight" class="active">Clair</button>
          <button id="themeDark">Sombre</button>
        </div>
      </div>

      <div class="drawerTabs" id="drawerTabs"></div>

      <div class="drawerBody">
        <div id="drawerPanels"></div>
      </div>
    </aside>
  </div>

  <div class="wrap">
    <div class="topRow">
      <div class="group">
        <button class="btn" id="btnMenu">Menu</button>
        <button class="btn" id="btnReset">Reset</button>
        <button class="btn" id="btnFocus">Focus</button>
      </div>

      <div class="group">
        <div class="hud" id="hud">
          <span>T√¢ches <b id="hudTasks">0/0</b></span>
          <span>√âthorions <b id="hudEth">0/0</b></span>
          <span>Faits <b id="hudDone">0</b></span>
          <span>Temps <b id="hudTimer">00:00</b></span>
        </div>
      </div>
    </div>

    <div class="titleBlock">
      <h1 class="title">ELIMINATOR</h1>
      <p class="subtitle">D√©gomme toutes les t√¢ches ‚Ä¢ D√©gomme tous les √©thorions en cours</p>
    </div>

    <section class="block progressBlock" aria-label="Barre de progression globale">
      <div class="barTrack">
        <div class="barFill" id="bigFill"></div>
        <div class="barPct" id="bigPct">100%</div>
      </div>
    </section>

    <div class="gapAfterProgress"></div>

    <section class="block" aria-label="T√¢che en cours">
      <h2 class="taskName" id="taskName">Aucune t√¢che</h2>

      <div class="ethBox" id="ethBox">
        <div class="ethTop">
          <div>√âthorions <b id="ethNow">0</b>/<b id="ethStart">0</b></div>
          <div>Temps restant <b id="ethMinutes">0</b> min</div>
        </div>
        <div class="ethTrack">
          <div class="ethFill" id="ethFill"></div>
          <div class="ethTicks" id="ethTicks"></div>
        </div>
      </div>

      <div class="actionRow">
        <button class="rouletteBtn" id="btnRoulette" aria-label="Roulette">
          <div class="rouletteWheel" id="rouletteWheel"><span>ROULETTE</span></div>
        </button>

        <button class="smashBtn" id="btnSmash" aria-label="D√©gommer un √©thorion">
          <span>üß®</span>
          <span>D√©gommer 1 √©thorion</span>
        </button>
      </div>

      <div class="bottomBar">
        <button class="btn small" id="btnBottomMenu">Menu</button>
        <button class="btn small" id="btnBottomNote">Note</button>
        <button class="btn small ghost" id="btnBottomFocus">Focus</button>
      </div>

      <div class="focusExit" id="focusExit">
        <button class="btn primary" id="btnExitFocus">Quitter Focus</button>
      </div>
    </section>
  </div>

  <script>
  (() => {
    /* =========================
       Storage keys
       ========================= */
    const K = {
      state: "ELIMINATOR_STATE_V4",
      settings: "ELIMINATOR_SETTINGS_V4",
      notes: "ELIMINATOR_NOTES_V4",
      history: "ELIMINATOR_HISTORY_V4",
      habits: "ELIMINATOR_HABITS_V4",
      qf: "ELIMINATOR_QUI_FONCE_V4"
    };

    /* =========================
       Tabs (drawer) ‚Äî regrouped
       ========================= */
    const TAB_DEFS = [
      { key:"inbox",   label:"Inbox" },
      { key:"liste",   label:"Liste" },
      { key:"qf",      label:"Qui fonce" },
      { key:"habits",  label:"Habitudes" },
      { key:"hist",    label:"Hist" },
      { key:"rapport", label:"Rapport" },
      { key:"params",  label:"Param" }
    ];

    /* =========================
       Defaults
       ========================= */
    const DEFAULTS = {
      theme: "light",
      focus: 0,
      ethMinutesPer: 5,
      sortMode: "roulette",      // roulette | order | alpha | chrono
      activeCats: null
    };

    const DEFAULT_HABITS = {
      slots: 8,
      habits: [],
      marksByDay: {}
    };

    /* =========================
       Qui fonce ‚Äî preloaded bank + user additions
       - preloaded is "hidden": UI shows only rotating suggestions.
       ========================= */
    const PRELOADED_QF = {
      now: [
        {t:"Boire un verre d‚Äôeau", e:1},
        {t:"Respirer 60 secondes", e:1},
        {t:"Ouvrir la fen√™tre 2 minutes", e:1},
        {t:"Ranger 10 objets visibles", e:2},
        {t:"√âcrire 1 phrase de plan", e:1},
        {t:"Mettre un minuteur 5 min et d√©marrer", e:1},
        {t:"Supprimer 5 notifications", e:1},
        {t:"Nettoyer l‚Äô√©cran (micro-rituel)", e:1}
      ],
      today: [
        {t:"Pr√©parer un mail important (brouillon)", e:3},
        {t:"Appeler une personne cl√©", e:2},
        {t:"Faire 10 minutes de tri (docs / bureau)", e:2},
        {t:"Planifier 3 blocs de 20 minutes", e:2},
        {t:"Remplir une t√¢che administrative rapide", e:2},
        {t:"Pr√©parer une micro-liste de demain", e:2}
      ],
      week: [
        {t:"D√©finir 1 objectif clair de la semaine", e:2},
        {t:"Bloquer 2 cr√©neaux focus calendrier", e:2},
        {t:"Faire un nettoyage de liste (supprimer/archiver)", e:3},
        {t:"Mettre √† jour un document central (r√©sum√©)", e:3}
      ],
      month: [
        {t:"Choisir 1 projet et 1 anti-projet (ce mois)", e:3},
        {t:"Faire une r√©trospective 15 minutes", e:3},
        {t:"Pr√©parer une am√©lioration de ton workflow", e:3}
      ]
    };

    const DEFAULT_CELEBRATIONS = [
      "TRIOMPHE ABSURDE. L‚ÄôHISTOIRE TE REGARDE.",
      "VICTOIRE IMP√âRIALE. LA LISTE A PEUR.",
      "CONQU√äTE TOTALE. LA PRODUCTIVIT√â PLEURE DE JOIE.",
      "TU ES UN CONQUISTADOR DU QUOTIDIEN.",
      "R√àGNE ABSOLU. LES T√ÇCHES SE RENDENT SANS CONDITIONS.",
      "D√âMOLITION NOBLE. ON T‚ÄôINSCRIT DANS LA L√âGENDE.",
      "GLOIRE. HONNEUR. ET UN BRIN DE D√âMESURE.",
      "C‚ÄôEST TROP EFFICACE POUR √äTRE L√âGAL (MAIS ON NE DIT RIEN).",
      "LE CHAOS RECULE. TU AVANCES. MAGISTRAL.",
      "TON NOM SERA CHUCHOT√â PAR LES CHECKLISTS ANCIENNES."
    ];

    /* =========================
       Utils
       ========================= */
    const uid = () => Math.random().toString(16).slice(2) + "-" + Date.now().toString(16);
    const nowISO = () => new Date().toISOString();
    const todayKey = () => new Date().toISOString().slice(0,10);
    const clamp = (n,a,b) => Math.max(a, Math.min(b, n));
    const fmtMMSS = (ms) => {
      const s = Math.floor(ms/1000);
      const m = Math.floor(s/60);
      const r = s % 60;
      return String(m).padStart(2,"0")+":"+String(r).padStart(2,"0");
    };
    const escapeHTML = (s)=>String(s).replace(/[&<>"']/g, m=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;" }[m]));

    function loadJSON(key, fallback){
      try{
        const raw = localStorage.getItem(key);
        if(!raw) return fallback;
        return JSON.parse(raw);
      }catch(e){ return fallback; }
    }
    function saveJSON(key, val){ localStorage.setItem(key, JSON.stringify(val)); }

    function shuffle(arr){
      const a = [...arr];
      for(let i=a.length-1;i>0;i--){
        const j = Math.floor(Math.random()*(i+1));
        [a[i],a[j]] = [a[j],a[i]];
      }
      return a;
    }

    /* =========================
       State
       ========================= */
    let settings = { ...DEFAULTS, ...(loadJSON(K.settings, null) || {}) };

    // task: {id,title,cat,ethStart,ethLeft,createdAt,pinned,doneAt?}
    let state = loadJSON(K.state, null);
    if(!state){
      state = {
        tasks: [],
        done: [],
        currentId: null,
        startCounts: { tasks: 0, eth: 0 },
        timer: { taskId: null, elapsedMs: 0, running: false }
      };
    }

    let notes = loadJSON(K.notes, []);
    let history = loadJSON(K.history, {});
    let habits = { ...DEFAULT_HABITS, ...(loadJSON(K.habits, null) || {}) };

    // Qui fonce additions (user can add, but preloaded exists anyway)
    let qfUser = loadJSON(K.qf, null);
    if(!qfUser){
      qfUser = { now:[], today:[], week:[], month:[] };
    }

    function ensureDay(){
      const k = todayKey();
      if(!history[k]) history[k] = { ethSmashed:0, tasksDone:0, msWorked:0 };
      if(!habits.marksByDay[k]) habits.marksByDay[k] = {};
    }

    /* =========================
       DOM
       ========================= */
    const body = document.body;

    const btnMenu = document.getElementById("btnMenu");
    const btnBottomMenu = document.getElementById("btnBottomMenu");
    const btnBottomNote = document.getElementById("btnBottomNote");
    const btnBottomFocus = document.getElementById("btnBottomFocus");

    const btnReset = document.getElementById("btnReset");
    const btnFocus = document.getElementById("btnFocus");
    const btnExitFocus = document.getElementById("btnExitFocus");

    const hudTasks = document.getElementById("hudTasks");
    const hudEth = document.getElementById("hudEth");
    const hudDone = document.getElementById("hudDone");
    const hudTimer = document.getElementById("hudTimer");

    const bigFill = document.getElementById("bigFill");
    const bigPct = document.getElementById("bigPct");

    const taskNameEl = document.getElementById("taskName");

    const ethNowEl = document.getElementById("ethNow");
    const ethStartEl = document.getElementById("ethStart");
    const ethMinutesEl = document.getElementById("ethMinutes");
    const ethFill = document.getElementById("ethFill");
    const ethTicks = document.getElementById("ethTicks");

    const btnRoulette = document.getElementById("btnRoulette");
    const rouletteWheel = document.getElementById("rouletteWheel");
    const btnSmash = document.getElementById("btnSmash");

    const drawerOverlay = document.getElementById("drawerOverlay");
    const btnDrawerClose = document.getElementById("btnDrawerClose");
    const drawerTabs = document.getElementById("drawerTabs");
    const drawerPanels = document.getElementById("drawerPanels");

    const themeLight = document.getElementById("themeLight");
    const themeDark = document.getElementById("themeDark");

    // Celebration
    const celebrateOverlay = document.getElementById("celebrateOverlay");
    const celebrateTitle = document.getElementById("celebrateTitle");
    const celebrateSub = document.getElementById("celebrateSub");
    let celebrateTimer = null;

    // Notes modal
    const notesOverlay = document.getElementById("notesOverlay");
    const btnCloseNotes = document.getElementById("btnCloseNotes");
    const btnAddNote = document.getElementById("btnAddNote");
    const btnClearNotes = document.getElementById("btnClearNotes");
    const btnExportNotes = document.getElementById("btnExportNotes");
    const noteText = document.getElementById("noteText");
    const notesGrid = document.getElementById("notesGrid");

    /* =========================
       Theme / Focus
       ========================= */
    function setTheme(theme){
      settings.theme = theme;
      body.setAttribute("data-theme", theme);
      themeLight.classList.toggle("active", theme==="light");
      themeDark.classList.toggle("active", theme==="dark");
      saveJSON(K.settings, settings);
    }
    function setFocus(on){
      settings.focus = on ? 1 : 0;
      body.setAttribute("data-focus", settings.focus);
      saveJSON(K.settings, settings);
    }

    /* =========================
       Drawer
       ========================= */
    function buildDrawer(){
      drawerTabs.innerHTML = "";
      drawerPanels.innerHTML = "";

      for(const t of TAB_DEFS){
        const tab = document.createElement("div");
        tab.className = "tab";
        tab.textContent = t.label;
        tab.dataset.key = t.key;
        tab.onclick = () => selectDrawerTab(t.key);
        drawerTabs.appendChild(tab);

        const panel = document.createElement("div");
        panel.id = "panel-"+t.key;
        panel.style.display = "none";
        drawerPanels.appendChild(panel);
      }
      selectDrawerTab("inbox");
    }

    function selectDrawerTab(key){
      [...drawerTabs.children].forEach(el => el.classList.toggle("active", el.dataset.key===key));
      [...drawerPanels.children].forEach(p => p.style.display = (p.id==="panel-"+key) ? "" : "none");
      renderDrawerPanel(key);
    }

    function openDrawer(tabKey="inbox"){
      drawerOverlay.classList.add("show");
      selectDrawerTab(tabKey);
    }
    function closeDrawer(){
      drawerOverlay.classList.remove("show");
    }
    drawerOverlay.addEventListener("click", (e)=>{ if(e.target===drawerOverlay) closeDrawer(); });

    /* =========================
       Notes modal
       ========================= */
    function openNotes(){
      notesOverlay.classList.add("show");
      notesOverlay.setAttribute("aria-hidden","false");
      renderNotes();
      setTimeout(()=>noteText.focus(), 50);
    }
    function closeNotes(){
      notesOverlay.classList.remove("show");
      notesOverlay.setAttribute("aria-hidden","true");
    }
    notesOverlay.addEventListener("click",(e)=>{ if(e.target===notesOverlay) closeNotes(); });

    function renderNotes(){
      const arr = [...notes].sort((a,b)=>new Date(b.at)-new Date(a.at));
      notesGrid.innerHTML = "";
      for(const n of arr){
        const d = document.createElement("div");
        d.className = "note";
        d.innerHTML = `
          <div class="stamp">${escapeHTML(new Date(n.at).toLocaleString())}</div>
          <div class="txt">${escapeHTML(n.text)}</div>
        `;
        notesGrid.appendChild(d);
      }
      if(arr.length===0){
        const empty = document.createElement("div");
        empty.className = "help";
        empty.textContent = "Aucune note.";
        notesGrid.appendChild(empty);
      }
    }

    /* =========================
       Celebration ‚Äî only on smash/finish + auto 15s
       ========================= */
    function showCelebration(subText){
      const phrase = DEFAULT_CELEBRATIONS[Math.floor(Math.random()*DEFAULT_CELEBRATIONS.length)] || "VICTOIRE";
      celebrateTitle.textContent = phrase;
      celebrateSub.textContent = subText || "";
      celebrateOverlay.classList.add("show");
      celebrateOverlay.setAttribute("aria-hidden","false");

      if(celebrateTimer) clearTimeout(celebrateTimer);
      celebrateTimer = setTimeout(() => hideCelebration(), 15000);
    }
    function hideCelebration(){
      if(celebrateTimer) clearTimeout(celebrateTimer);
      celebrateTimer = null;
      celebrateOverlay.classList.remove("show");
      celebrateOverlay.setAttribute("aria-hidden","true");
    }
    celebrateOverlay.addEventListener("click", hideCelebration);

    /* =========================
       Parsing Inbox: MAJ = cat√©gorie, "t√¢che - 3" ou "t√¢che 3"
       ========================= */
    function isAllCapsHeading(line){
      const s = line.trim();
      if(!s) return false;
      const hasLetter = /[A-Z√Ä-√ñ√ò-√û]/.test(s);
      const hasLower = /[a-z√†-√∂√∏-√ø]/.test(s);
      return hasLetter && !hasLower && s.length >= 3;
    }

    function normalizeCat(s){
      const x = String(s || "").trim();
      if(!x) return "Sans cat√©gorie";
      return x.replace(/\s{2,}/g, " ").replace(/^#+\s*/,"").trim();
    }

    function parseTaskLine(line, currentCat, ethDefault=1){
      let s = line.trim();
      if(!s) return null;
      s = s.replace(/^[-‚Ä¢*\u2022]\s+/, "").trim();
      if(!s) return null;

      let eth = null;
      const mDash = s.match(/\s*-\s*(\d+)\s*$/);
      if(mDash) eth = parseInt(mDash[1],10);
      if(eth === null){
        const mEnd = s.match(/\s+(\d+)\s*$/);
        if(mEnd) eth = parseInt(mEnd[1],10);
      }
      if(mDash) s = s.replace(/\s*-\s*\d+\s*$/,"").trim();
      else if(eth !== null) s = s.replace(/\s+\d+\s*$/,"").trim();
      if(!s) return null;

      const finalEth = clamp((Number.isFinite(eth) ? eth : ethDefault), 1, 999);

      return {
        id: uid(),
        title: s,
        cat: normalizeCat(currentCat),
        ethStart: finalEth,
        ethLeft: finalEth,
        pinned: false,
        createdAt: nowISO()
      };
    }

    /* =========================
       Core tasks
       ========================= */
    function recalcStartCounts(){
      state.startCounts.tasks = state.tasks.length + state.done.length;
      state.startCounts.eth =
        state.tasks.reduce((a,t)=>a+t.ethStart,0) + state.done.reduce((a,t)=>a+t.ethStart,0);
    }

    function getActiveCatsSet(){
      const cats = [...new Set(state.tasks.map(t=>t.cat || "Sans cat√©gorie"))];
      if(!settings.activeCats || settings.activeCats.length===0) return new Set(cats);
      return new Set(settings.activeCats);
    }

    function currentTask(){
      return state.tasks.find(t=>t.id===state.currentId) || null;
    }

    function pickNextTask(){
      const active = getActiveCatsSet();
      const pool = state.tasks.filter(t => active.has(t.cat || "Sans cat√©gorie"));
      if(pool.length===0) return state.tasks[0] || null;

      if(settings.sortMode==="alpha"){
        return [...pool].sort((a,b)=>a.title.localeCompare(b.title))[0];
      }
      if(settings.sortMode==="chrono"){
        return [...pool].sort((a,b)=>new Date(a.createdAt)-new Date(b.createdAt))[0];
      }
      if(settings.sortMode==="order"){
        return pool[0];
      }

      // roulette
      return pool[Math.floor(Math.random()*pool.length)];
    }

    function ensureCurrent(){
      if(state.tasks.length===0){
        state.currentId = null;
        state.timer = { taskId:null, elapsedMs:0, running:false };
        return;
      }
      if(!state.currentId || !currentTask()){
        const t = pickNextTask();
        if(t){
          state.currentId = t.id;
          state.timer = { taskId: t.id, elapsedMs:0, running:true };
        }
      }
    }

    /* =========================
       Render
       ========================= */
    function renderHUD(){
      const totalTasksStart = state.startCounts.tasks || (state.tasks.length + state.done.length);
      const totalEthStart = state.startCounts.eth || (state.tasks.reduce((a,t)=>a+t.ethStart,0) + state.done.reduce((a,t)=>a+t.ethStart,0));

      const tasksLeft = state.tasks.length;
      const ethLeft = state.tasks.reduce((a,t)=>a+t.ethLeft,0);
      const done = state.done.length;

      hudTasks.textContent = `${tasksLeft}/${totalTasksStart}`;
      hudEth.textContent = `${ethLeft}/${totalEthStart}`;
      hudDone.textContent = `${done}`;
    }

    function renderCurrent(){
      ensureCurrent();
      const t = currentTask();

      if(!t){
        taskNameEl.textContent = "Aucune t√¢che (Menu ‚Üí Inbox / Qui fonce)";
        bigFill.style.transform = "scaleX(1)";
        bigPct.textContent = "100%";

        ethNowEl.textContent = "0";
        ethStartEl.textContent = "0";
        ethMinutesEl.textContent = "0";
        ethFill.style.transform = "scaleX(1)";
        ethTicks.innerHTML = "";
        return;
      }

      taskNameEl.textContent = t.title;

      const frac = (t.ethStart > 0) ? (t.ethLeft / t.ethStart) : 1;
      const f = clamp(frac, 0, 1);

      bigFill.style.transform = `scaleX(${f})`;
      bigPct.textContent = `${Math.round(f*100)}%`;

      const minPer = settings.ethMinutesPer || 5;
      ethNowEl.textContent = `${t.ethLeft}`;
      ethStartEl.textContent = `${t.ethStart}`;
      ethMinutesEl.textContent = `${t.ethLeft * minPer}`;

      ethFill.style.transform = `scaleX(${f})`;

      ethTicks.innerHTML = "";
      const n = clamp(t.ethStart, 1, 60);
      for(let i=0;i<n;i++){
        const sp = document.createElement("span");
        ethTicks.appendChild(sp);
      }
    }

    function persistAll(){
      saveJSON(K.settings, settings);
      saveJSON(K.state, state);
      saveJSON(K.notes, notes);
      saveJSON(K.history, history);
      saveJSON(K.habits, habits);
      saveJSON(K.qf, qfUser);
    }

    function renderAll(){
      ensureDay();
      ensureCurrent();
      renderHUD();
      renderCurrent();
      persistAll();
    }

    /* =========================
       Timer
       ========================= */
    let lastTick = Date.now();
    function tick(){
      const now = Date.now();
      const dt = now - lastTick;
      lastTick = now;

      const t = currentTask();
      if(t && state.timer && state.timer.taskId===t.id && state.timer.running){
        state.timer.elapsedMs += dt;
        history[todayKey()].msWorked += dt;
        hudTimer.textContent = fmtMMSS(state.timer.elapsedMs);
      }else{
        hudTimer.textContent = "00:00";
      }

      renderHUD();
      requestAnimationFrame(tick);
    }

    /* =========================
       Actions
       ========================= */
    function roulettePick(){
      btnRoulette.classList.add("spinning");
      setTimeout(()=>btnRoulette.classList.remove("spinning"), 920);

      const t = pickNextTask();
      if(!t) return;
      state.currentId = t.id;
      state.timer = { taskId: t.id, elapsedMs:0, running:true };
      renderAll();
    }

    function smashOne(){
      const t = currentTask();
      if(!t) return;

      if(t.ethLeft > 0){
        t.ethLeft -= 1;
        history[todayKey()].ethSmashed += 1;

        if(t.ethLeft <= 0){
          t.ethLeft = 0;
          t.doneAt = nowISO();
          state.done.push(t);
          state.tasks = state.tasks.filter(x=>x.id!==t.id);
          history[todayKey()].tasksDone += 1;

          state.currentId = null;
          state.timer = { taskId:null, elapsedMs:0, running:false };
          ensureCurrent();

          showCelebration("T√¢che termin√©e. L‚Äôennemi recule.");
        }else{
          showCelebration("+1 √©thorion d√©gomm√©");
        }

        renderAll();
      }
    }

    function resetRun(){
      if(!confirm("Reset du run (remet 'Faits' √† z√©ro). T√¢ches restent. Notes restent.")) return;
      state.done = [];
      recalcStartCounts();
      const t = currentTask();
      state.timer = t ? { taskId:t.id, elapsedMs:0, running:true } : { taskId:null, elapsedMs:0, running:false };
      renderAll();
    }

    function deleteTask(id){
      state.tasks = state.tasks.filter(x=>x.id!==id);
      if(state.currentId===id){
        state.currentId = null;
        state.timer = { taskId:null, elapsedMs:0, running:false };
        ensureCurrent();
      }
    }

    function moveTask(id, dir){
      const idx = state.tasks.findIndex(x=>x.id===id);
      if(idx<0) return;
      const newIdx = clamp(idx + dir, 0, state.tasks.length-1);
      if(newIdx===idx) return;
      const [x] = state.tasks.splice(idx,1);
      state.tasks.splice(newIdx,0,x);
    }

    /* =========================
       Drawer panels
       ========================= */
    function renderDrawerPanel(key){
      const panel = document.getElementById("panel-"+key);
      panel.innerHTML = "";

      if(key==="inbox") panel.appendChild(buildInboxPanel());
      if(key==="liste") panel.appendChild(buildListPanel());
      if(key==="qf") panel.appendChild(buildQuiFoncePanel());
      if(key==="habits") panel.appendChild(buildHabitsPanel());
      if(key==="hist") panel.appendChild(buildHistPanel());
      if(key==="rapport") panel.appendChild(buildRapportPanel());
      if(key==="params") panel.appendChild(buildParamsPanel());
    }

    function mkCard(title, innerHTML){
      const c = document.createElement("div");
      c.className = "card";
      c.innerHTML = `<p class="cardTitle">${escapeHTML(title)}</p>` + innerHTML;
      return c;
    }

    /* --- Inbox panel --- */
    function buildInboxPanel(){
      const wrap = document.createElement("div");

      const c1 = mkCard("Importer / coller une liste", `
        <textarea id="inboxText" placeholder="R√®gles :
- TITRE EN MAJUSCULE = cat√©gorie
- T√¢che - 3   => 3 √©thorions
- T√¢che 3     => 3 √©thorions
"></textarea>

        <div class="row" style="margin-top:10px;">
          <input id="inboxDefaultEth" type="number" min="1" value="1" />
          <select id="inboxSortMode">
            <option value="roulette">Mode s√©lection: roulette</option>
            <option value="order">Mode s√©lection: ordre</option>
            <option value="alpha">Mode s√©lection: alpha</option>
            <option value="chrono">Mode s√©lection: chrono</option>
          </select>
        </div>

        <div class="row" style="margin-top:10px;">
          <button class="btn primary" id="btnImport">Importer</button>
          <button class="btn" id="btnClearInbox">Vider</button>
        </div>

        <div class="help" style="margin-top:10px;">
          Pas de c√©l√©bration ici. La gloire est r√©serv√©e au champ de bataille (üß®).
        </div>
      `);

      wrap.appendChild(c1);

      setTimeout(() => {
        const inboxText = document.getElementById("inboxText");
        const inboxDefaultEth = document.getElementById("inboxDefaultEth");
        const inboxSortMode = document.getElementById("inboxSortMode");
        const btnImport = document.getElementById("btnImport");
        const btnClearInbox = document.getElementById("btnClearInbox");

        inboxSortMode.value = settings.sortMode;

        btnClearInbox.onclick = () => { inboxText.value = ""; };

        btnImport.onclick = () => {
          const raw = inboxText.value || "";
          const lines = raw.split(/\r?\n/);
          let currentCat = "Sans cat√©gorie";
          const ethDef = parseInt(inboxDefaultEth.value,10);
          const ethDefaultSafe = Number.isFinite(ethDef) && ethDef>0 ? ethDef : 1;

          const added = [];
          for(const line0 of lines){
            const line = line0.trim();
            if(!line) continue;
            if(isAllCapsHeading(line)){
              currentCat = normalizeCat(line);
              continue;
            }
            const t = parseTaskLine(line, currentCat, ethDefaultSafe);
            if(t) added.push(t);
          }

          if(added.length===0) return;

          state.tasks.push(...added);
          recalcStartCounts();
          settings.sortMode = inboxSortMode.value;

          ensureCurrent();
          renderAll();
        };
      }, 0);

      return wrap;
    }

    /* --- Liste panel --- */
    function buildListPanel(){
      const wrap = document.createElement("div");

      const cats = [...new Set(state.tasks.map(t=>t.cat || "Sans cat√©gorie"))].sort((a,b)=>a.localeCompare(b));
      const active = getActiveCatsSet();

      const cFilter = mkCard("Cat√©gories actives", `
        <div id="catFilterRow" class="row"></div>
        <div class="help" style="margin-top:10px;">
          Les cat√©gories inactives ne sont pas tir√©es par la roulette.
        </div>
      `);

      const cList = mkCard("T√¢ches", `<div id="taskList"></div>`);

      wrap.appendChild(cFilter);
      wrap.appendChild(cList);

      setTimeout(() => {
        const row = document.getElementById("catFilterRow");
        row.innerHTML = "";
        for(const c of cats){
          const b = document.createElement("button");
          b.className = "btn small";
          const on = active.has(c);
          b.textContent = (on ? "[x] " : "[ ] ") + c;
          b.onclick = () => {
            let next = settings.activeCats;
            if(!next || next.length===0) next = [...cats];
            else next = [...next];

            if(next.includes(c)) next = next.filter(x=>x!==c);
            else next.push(c);

            settings.activeCats = next;
            persistAll();
            renderDrawerPanel("liste");
          };
          row.appendChild(b);
        }

        const list = document.getElementById("taskList");
        list.innerHTML = "";

        for(const t of state.tasks){
          const item = document.createElement("div");
          item.className = "taskItem";

          const left = document.createElement("div");
          left.className = "taskLeft";
          left.innerHTML = `
            <div class="name">${escapeHTML(t.title)}</div>
            <div class="sub">${escapeHTML(t.cat)} ¬∑ eth ${t.ethLeft}/${t.ethStart}</div>
          `;

          const act = document.createElement("div");
          act.className = "taskAct";

          const up = document.createElement("button");
          up.className = "iconBtn";
          up.textContent = "‚Üë";
          up.onclick = () => { moveTask(t.id, -1); renderDrawerPanel("liste"); renderAll(); };

          const down = document.createElement("button");
          down.className = "iconBtn";
          down.textContent = "‚Üì";
          down.onclick = () => { moveTask(t.id, +1); renderDrawerPanel("liste"); renderAll(); };

          const edit = document.createElement("button");
          edit.className = "iconBtn";
          edit.textContent = "edit";
          edit.onclick = () => {
            const nv = prompt("Modifier le titre :", t.title);
            if(nv===null) return;
            const cleaned = nv.trim();
            if(!cleaned) return;
            t.title = cleaned;
            renderDrawerPanel("liste");
            renderAll();
          };

          const del = document.createElement("button");
          del.className = "iconBtn";
          del.textContent = "del";
          del.onclick = () => {
            if(!confirm("Supprimer cette t√¢che ?")) return;
            deleteTask(t.id);
            renderDrawerPanel("liste");
            renderAll();
          };

          act.appendChild(up);
          act.appendChild(down);
          act.appendChild(edit);
          act.appendChild(del);

          item.appendChild(left);
          item.appendChild(act);
          list.appendChild(item);
        }

        if(state.tasks.length===0){
          const empty = document.createElement("div");
          empty.className = "help";
          empty.textContent = "Liste vide. Inbox ou Qui fonce pour injecter des t√¢ches.";
          list.appendChild(empty);
        }
      }, 0);

      return wrap;
    }

    /* --- Qui fonce panel (preloaded, rotating suggestions) --- */
    function getQuiFoncePool(bucket){
      const base = PRELOADED_QF[bucket] || [];
      const extra = qfUser[bucket] || [];
      return [...base, ...extra];
    }

    function buildQuiFoncePanel(){
      const wrap = document.createElement("div");

      const c1 = mkCard("Qui fonce (pr√©-enregistr√©)", `
        <div class="help">
          Banque pr√©existante. Tu peux ajouter des items, mais tu n‚Äôas pas √† ‚Äúpenser‚Äù la liste.
          Clique ‚ÄúRafra√Æchir‚Äù pour faire appara√Ætre d‚Äôautres suggestions.
        </div>

        <div class="row" style="margin-top:10px;">
          <select id="qfBucket">
            <option value="now">Maintenant</option>
            <option value="today">Aujourd‚Äôhui</option>
            <option value="week">Cette semaine</option>
            <option value="month">Ce mois</option>
          </select>
          <button class="btn" id="qfRefresh">Rafra√Æchir</button>
        </div>

        <div id="qfSuggestions" style="margin-top:12px;"></div>

        <div class="row" style="margin-top:12px;">
          <input id="qfNewText" placeholder="Ajouter un item perso (optionnel)" />
          <input id="qfNewEth" type="number" min="1" value="1" />
        </div>
        <div class="row" style="margin-top:10px;">
          <button class="btn primary" id="qfAdd">Ajouter √† la banque</button>
          <button class="btn" id="qfInjectAll">Ajouter les suggestions √† ma liste</button>
        </div>
      `);

      wrap.appendChild(c1);

      setTimeout(() => {
        const bucketSel = document.getElementById("qfBucket");
        const sugDiv = document.getElementById("qfSuggestions");

        let lastSuggestions = [];

        function renderSuggestions(){
          const bucket = bucketSel.value;
          const pool = getQuiFoncePool(bucket);
          const take = (bucket==="now") ? 6 : 5;
          lastSuggestions = shuffle(pool).slice(0, take);

          sugDiv.innerHTML = "";
          for(const s of lastSuggestions){
            const item = document.createElement("div");
            item.className = "taskItem";
            item.innerHTML = `
              <div class="taskLeft">
                <div class="name">${escapeHTML(s.t)}</div>
                <div class="sub">cat QUI FONCE ¬∑ eth ${s.e}</div>
              </div>
              <div class="taskAct">
                <button class="iconBtn" data-add="1">add</button>
              </div>
            `;
            item.querySelector('[data-add="1"]').onclick = () => {
              injectQuiFonce([s]);
              renderAll();
            };
            sugDiv.appendChild(item);
          }
        }

        function injectQuiFonce(list){
          const added = list.map(s => ({
            id: uid(),
            title: s.t,
            cat: "QUI FONCE",
            ethStart: clamp(parseInt(s.e,10)||1,1,999),
            ethLeft: clamp(parseInt(s.e,10)||1,1,999),
            pinned: false,
            createdAt: nowISO()
          }));
          state.tasks.push(...added);
          recalcStartCounts();
          ensureCurrent();
        }

        document.getElementById("qfRefresh").onclick = renderSuggestions;

        document.getElementById("qfAdd").onclick = () => {
          const bucket = bucketSel.value;
          const txt = (document.getElementById("qfNewText").value || "").trim();
          const eth = clamp(parseInt(document.getElementById("qfNewEth").value,10)||1,1,999);
          if(!txt) return;

          qfUser[bucket] = qfUser[bucket] || [];
          qfUser[bucket].push({ t: txt, e: eth });
          saveJSON(K.qf, qfUser);

          document.getElementById("qfNewText").value = "";
          // Pas de c√©l√©bration ici (comme demand√©)
          renderSuggestions();
        };

        document.getElementById("qfInjectAll").onclick = () => {
          if(lastSuggestions.length===0) return;
          injectQuiFonce(lastSuggestions);
          renderAll();
        };

        bucketSel.onchange = renderSuggestions;

        renderSuggestions();
      }, 0);

      return wrap;
    }

    /* --- Habits panel (single line, no celebrations on add) --- */
    function buildHabitsPanel(){
      const wrap = document.createElement("div");

      const c1 = mkCard("Param√®tres habitudes", `
        <div class="row">
          <input id="habitSlots" type="number" min="3" max="20" />
          <button class="btn primary" id="btnSaveHabitSlots">Enregistrer</button>
        </div>
        <div class="help" style="margin-top:10px;">
          Nombre de cases par habitude et par jour.
        </div>
      `);

      const c2 = mkCard("Ajouter une habitude", `
        <div class="row">
          <input id="habitName" placeholder="Ex: boire des verres d‚Äôeau" />
          <button class="btn primary" id="btnAddHabit">Ajouter</button>
        </div>
      `);

      const c3 = mkCard("Aujourd‚Äôhui", `<div id="habitsList"></div>`);

      wrap.appendChild(c1);
      wrap.appendChild(c2);
      wrap.appendChild(c3);

      setTimeout(() => {
        ensureDay();

        const slotsInput = document.getElementById("habitSlots");
        slotsInput.value = String(habits.slots || 8);

        document.getElementById("btnSaveHabitSlots").onclick = () => {
          const n = parseInt(slotsInput.value,10);
          habits.slots = clamp(Number.isFinite(n)?n:8, 3, 20);
          saveJSON(K.habits, habits);
          renderDrawerPanel("habits");
        };

        document.getElementById("btnAddHabit").onclick = () => {
          const nm = (document.getElementById("habitName").value||"").trim();
          if(!nm) return;
          habits.habits.push({ id: uid(), name: nm, createdAt: nowISO() });
          saveJSON(K.habits, habits);
          renderDrawerPanel("habits");
        };

        const list = document.getElementById("habitsList");
        list.innerHTML = "";

        const day = todayKey();
        const marks = habits.marksByDay[day] || (habits.marksByDay[day] = {});
        const slots = habits.slots || 8;

        for(const h of habits.habits){
          if(!marks[h.id]) marks[h.id] = Array.from({length: slots}, ()=>0);

          const line = document.createElement("div");
          line.className = "habitLine";

          const name = document.createElement("div");
          name.className = "habitName";
          name.textContent = h.name;

          const checks = document.createElement("div");
          checks.className = "habitChecks";

          for(let i=0;i<slots;i++){
            const c = document.createElement("div");
            c.className = "check" + (marks[h.id][i] ? " on" : "");
            c.textContent = marks[h.id][i] ? "x" : "";
            c.onclick = () => {
              marks[h.id][i] = marks[h.id][i] ? 0 : 1;
              habits.marksByDay[day] = marks;
              saveJSON(K.habits, habits);
              renderDrawerPanel("habits");
            };
            checks.appendChild(c);
          }

          const btns = document.createElement("div");
          btns.className = "habitBtns";

          const r = document.createElement("button");
          r.className = "iconBtn";
          r.textContent = "reset";
          r.onclick = () => {
            marks[h.id] = Array.from({length: slots}, ()=>0);
            saveJSON(K.habits, habits);
            renderDrawerPanel("habits");
          };

          const d = document.createElement("button");
          d.className = "iconBtn";
          d.textContent = "del";
          d.onclick = () => {
            if(!confirm("Supprimer cette habitude ?")) return;
            habits.habits = habits.habits.filter(x=>x.id!==h.id);
            for(const dayKey of Object.keys(habits.marksByDay)){
              if(habits.marksByDay[dayKey] && habits.marksByDay[dayKey][h.id]){
                delete habits.marksByDay[dayKey][h.id];
              }
            }
            saveJSON(K.habits, habits);
            renderDrawerPanel("habits");
          };

          btns.appendChild(r);
          btns.appendChild(d);

          line.appendChild(name);
          line.appendChild(checks);
          line.appendChild(btns);

          list.appendChild(line);
        }

        if(habits.habits.length===0){
          const empty = document.createElement("div");
          empty.className = "help";
          empty.textContent = "Aucune habitude. Ajoute-en une ci-dessus.";
          list.appendChild(empty);
        }
      }, 0);

      return wrap;
    }

    /* --- Historique: Calendar + Timeline --- */
    function summarizeHabitsDay(day){
      const slots = habits.slots || 8;
      const marks = (habits.marksByDay && habits.marksByDay[day]) ? habits.marksByDay[day] : {};
      if(!habits.habits || habits.habits.length===0){
        return [];
      }
      const items = [];
      for(const h of habits.habits){
        const arr = marks[h.id] || Array.from({length: slots}, ()=>0);
        const done = arr.reduce((a,x)=>a+(x?1:0),0);
        const pct = Math.round((done/slots)*100);
        items.push({ name:h.name, done, slots, pct });
      }
      return items;
    }

    function buildHistPanel(){
      const wrap = document.createElement("div");

      const c1 = mkCard("Vue calendrier (mois)", `
        <div class="help">Chaque jour affiche t√¢ches / √©thorions. (C‚Äôest volontairement minimal.)</div>
        <div class="row" style="margin-top:10px;">
          <button class="btn" id="calPrev">‚Üê</button>
          <div class="help" id="calLabel" style="text-align:center;"></div>
          <button class="btn" id="calNext">‚Üí</button>
        </div>
        <div style="margin-top:12px;" class="calWrap" id="calGrid"></div>
      `);

      const c2 = mkCard("Ligne du temps (30 jours)", `<div id="timeline"></div>`);

      wrap.appendChild(c1);
      wrap.appendChild(c2);

      setTimeout(() => {
        let viewDate = new Date();
        viewDate.setDate(1);

        function monthLabel(d){
          return d.toLocaleDateString(undefined, { month:"long", year:"numeric" });
        }

        function dayKeyFromDate(d){
          return d.toISOString().slice(0,10);
        }

        function renderCalendar(){
          const calLabel = document.getElementById("calLabel");
          const grid = document.getElementById("calGrid");
          calLabel.textContent = monthLabel(viewDate);

          grid.innerHTML = "";
          const year = viewDate.getFullYear();
          const month = viewDate.getMonth();

          const first = new Date(year, month, 1);
          const startDow = (first.getDay() + 6) % 7; // monday=0
          const daysInMonth = new Date(year, month+1, 0).getDate();

          // add blanks
          for(let i=0;i<startDow;i++){
            const blank = document.createElement("div");
            blank.className = "calCell";
            blank.style.opacity = ".35";
            blank.innerHTML = `<div class="calDay"><span> </span><span></span></div>`;
            grid.appendChild(blank);
          }

          for(let day=1; day<=daysInMonth; day++){
            const d = new Date(year, month, day);
            const key = dayKeyFromDate(d);
            const h = history[key] || { ethSmashed:0, tasksDone:0, msWorked:0 };

            const cell = document.createElement("div");
            cell.className = "calCell";
            cell.innerHTML = `
              <div class="calDay">
                <span>${day}</span>
                <span class="calBadge">T ${h.tasksDone} ¬∑ E ${h.ethSmashed}</span>
              </div>
              <div class="calStats">Temps ${fmtMMSS(h.msWorked||0)}</div>
            `;
            grid.appendChild(cell);
          }
        }

        function renderTimeline(){
          const tdiv = document.getElementById("timeline");
          tdiv.innerHTML = "";

          for(let i=0;i<30;i++){
            const d = new Date();
            d.setDate(d.getDate()-i);
            const key = d.toISOString().slice(0,10);
            const h = history[key] || null;
            if(!h) continue;

            const row = document.createElement("div");
            row.className = "taskItem";
            row.innerHTML = `
              <div class="taskLeft">
                <div class="name">${escapeHTML(key)}</div>
                <div class="sub">T ${h.tasksDone} ¬∑ E ${h.ethSmashed} ¬∑ Temps ${fmtMMSS(h.msWorked||0)}</div>
              </div>
              <div class="taskAct">
                <button class="iconBtn" data-exp="1">export</button>
              </div>
            `;
            row.querySelector('[data-exp="1"]').onclick = () => {
              exportJSON(buildDailyReport(key), `eliminator_journal_${key}.json`);
            };
            tdiv.appendChild(row);
          }

          if(tdiv.children.length===0){
            const empty = document.createElement("div");
            empty.className = "help";
            empty.textContent = "Pas de donn√©es historiques pour l‚Äôinstant.";
            tdiv.appendChild(empty);
          }
        }

        document.getElementById("calPrev").onclick = () => {
          viewDate = new Date(viewDate.getFullYear(), viewDate.getMonth()-1, 1);
          renderCalendar();
        };
        document.getElementById("calNext").onclick = () => {
          viewDate = new Date(viewDate.getFullYear(), viewDate.getMonth()+1, 1);
          renderCalendar();
        };

        renderCalendar();
        renderTimeline();
      }, 0);

      return wrap;
    }

    /* --- Rapport --- */
    function buildDailyReport(day){
      const h = history[day] || { ethSmashed:0, tasksDone:0, msWorked:0 };
      const hab = summarizeHabitsDay(day);
      return {
        day,
        stats: h,
        habits: hab,
        run_export: buildRunExport()
      };
    }

    function buildRunExport(){
      const doneTasks = [...state.done].map(t => ({
        title: t.title, cat: t.cat, ethStart: t.ethStart, doneAt: t.doneAt || null
      }));
      const remainingTasks = [...state.tasks].map(t => ({
        title: t.title, cat: t.cat, ethStart: t.ethStart, ethLeft: t.ethLeft, createdAt: t.createdAt
      }));

      return {
        exportedAt: nowISO(),
        tasks_done_count: state.done.length,
        tasks_remaining_count: state.tasks.length,
        tasks_done: doneTasks,
        tasks_remaining: remainingTasks
      };
    }

    function buildReportText(days){
      const lines = [];
      lines.push(`ELIMINATOR ‚Äî RAPPORT (${days.length} jour(s))`);
      lines.push(`G√©n√©r√©: ${new Date().toLocaleString()}`);
      lines.push("");

      let eth=0, tasks=0, ms=0;
      for(const d of days){
        const h = history[d];
        if(!h) continue;
        eth += (h.ethSmashed||0);
        tasks += (h.tasksDone||0);
        ms += (h.msWorked||0);
      }

      lines.push(`Total √©thorions d√©gomm√©s: ${eth}`);
      lines.push(`Total t√¢ches termin√©es: ${tasks}`);
      lines.push(`Temps cumul√© (approx): ${fmtMMSS(ms)}`);
      lines.push("");

      const today = todayKey();
      const h0 = history[today] || {ethSmashed:0,tasksDone:0,msWorked:0};
      lines.push(`D√©tail du jour (${today}):`);
      lines.push(`- √âthorions: ${h0.ethSmashed}`);
      lines.push(`- T√¢ches: ${h0.tasksDone}`);
      lines.push(`- Temps: ${fmtMMSS(h0.msWorked)}`);

      const habToday = summarizeHabitsDay(today);
      if(habToday.length){
        lines.push(`- Habitudes:`);
        for(const it of habToday){
          lines.push(`  - ${it.name}: ${it.done}/${it.slots} (${it.pct}%)`);
        }
      }else{
        lines.push(`- Habitudes: aucune`);
      }

      lines.push("");
      lines.push("Run actuel:");
      lines.push(`- T√¢ches restantes: ${state.tasks.length}`);
      lines.push(`- T√¢ches faites: ${state.done.length}`);
      lines.push(`- √âthorions restants: ${state.tasks.reduce((a,t)=>a+t.ethLeft,0)}`);
      lines.push("");

      return lines.join("\n");
    }

    function lastNDays(n){
      const out = [];
      for(let i=0;i<n;i++){
        const d = new Date();
        d.setDate(d.getDate()-i);
        out.push(d.toISOString().slice(0,10));
      }
      return out;
    }

    function buildRapportPanel(){
      const wrap = document.createElement("div");

      const c1 = mkCard("Rapport (texte)", `
        <div class="row">
          <select id="repRange">
            <option value="day">Journalier</option>
            <option value="week">Hebdomadaire</option>
            <option value="month">Mensuel</option>
          </select>
          <button class="btn primary" id="btnGenRep">G√©n√©rer</button>
          <button class="btn" id="btnExportRep">Exporter</button>
        </div>
        <textarea id="repText" style="margin-top:10px; min-height:240px;"></textarea>
      `);

      wrap.appendChild(c1);

      setTimeout(() => {
        const repRange = document.getElementById("repRange");
        const repText = document.getElementById("repText");

        function gen(){
          const r = repRange.value;
          if(r==="day") repText.value = buildReportText([todayKey()]);
          else if(r==="week") repText.value = buildReportText(lastNDays(7));
          else repText.value = buildReportText(lastNDays(30));
        }

        document.getElementById("btnGenRep").onclick = gen;
        document.getElementById("btnExportRep").onclick = () => {
          const r = repRange.value;
          const name = r==="day" ? "journal" : (r==="week" ? "semaine" : "mois");
          exportText(repText.value || "", `eliminator_rapport_${name}_${todayKey()}.txt`);
        };

        gen();
      }, 0);

      return wrap;
    }

    /* --- Params panel: more settings access, but hidden from main UI --- */
    function buildParamsPanel(){
      const wrap = document.createElement("div");

      const c1 = mkCard("S√©lection & temps", `
        <div class="row">
          <select id="sortMode">
            <option value="roulette">S√©lection: roulette</option>
            <option value="order">S√©lection: ordre</option>
            <option value="alpha">S√©lection: alpha</option>
            <option value="chrono">S√©lection: chrono</option>
          </select>
          <select id="ethMinutesPer">
            <option value="5">1 √©thorion = 5 min</option>
            <option value="10">1 √©thorion = 10 min</option>
            <option value="15">1 √©thorion = 15 min</option>
          </select>
        </div>
        <div class="help" style="margin-top:10px;">
          Ici tu ajustes les param√®tres sans polluer l‚Äô√©cran principal.
        </div>
      `);

      const c2 = mkCard("Nettoyage", `
        <div class="row">
          <button class="btn" id="btnResetRun">Reset run</button>
          <button class="btn" id="btnNukeTasks">Tout effacer (t√¢ches + stats) (notes conserv√©es)</button>
        </div>
      `);

      wrap.appendChild(c1);
      wrap.appendChild(c2);

      setTimeout(() => {
        const sortMode = document.getElementById("sortMode");
        const ethMinutesPer = document.getElementById("ethMinutesPer");

        sortMode.value = settings.sortMode;
        ethMinutesPer.value = String(settings.ethMinutesPer || 5);

        sortMode.onchange = () => {
          settings.sortMode = sortMode.value;
          persistAll();
        };
        ethMinutesPer.onchange = () => {
          settings.ethMinutesPer = parseInt(ethMinutesPer.value,10) || 5;
          persistAll();
          renderAll();
        };

        document.getElementById("btnResetRun").onclick = resetRun;
        document.getElementById("btnNukeTasks").onclick = () => {
          if(!confirm("Effacer t√¢ches + stats (notes conserv√©es) ?")) return;
          state = {
            tasks: [],
            done: [],
            currentId: null,
            startCounts: { tasks: 0, eth: 0 },
            timer: { taskId:null, elapsedMs:0, running:false }
          };
          history = {};
          persistAll();
          renderAll();
        };
      }, 0);

      return wrap;
    }

    /* =========================
       Export helpers
       ========================= */
    function exportJSON(obj, filename){
      const blob = new Blob([JSON.stringify(obj,null,2)], {type:"application/json"});
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    }

    function exportText(text, filename){
      const blob = new Blob([text], {type:"text/plain"});
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    }

    /* =========================
       Wiring main buttons
       ========================= */
    btnMenu.onclick = () => openDrawer("inbox");
    btnBottomMenu.onclick = () => openDrawer("inbox");
    btnDrawerClose.onclick = closeDrawer;

    themeLight.onclick = () => setTheme("light");
    themeDark.onclick = () => setTheme("dark");

    btnReset.onclick = resetRun;

    btnFocus.onclick = () => setFocus(!(settings.focus===1));
    btnBottomFocus.onclick = () => setFocus(!(settings.focus===1));
    btnExitFocus.onclick = () => setFocus(0);

    btnBottomNote.onclick = openNotes;

    btnRoulette.onclick = roulettePick;
    btnSmash.onclick = smashOne;

    // Notes wiring
    btnCloseNotes.onclick = closeNotes;
    btnAddNote.onclick = () => {
      const txt = (noteText.value||"").trim();
      if(!txt) return;
      notes.push({ id: uid(), at: nowISO(), text: txt });
      saveJSON(K.notes, notes);
      noteText.value = "";
      renderNotes();
    };
    btnClearNotes.onclick = () => {
      if(!confirm("Effacer toutes les notes ?")) return;
      notes = [];
      saveJSON(K.notes, notes);
      renderNotes();
    };
    btnExportNotes.onclick = () => {
      exportJSON({ exportedAt: nowISO(), notes }, `eliminator_notes_${todayKey()}.json`);
    };

    /* =========================
       Init
       ========================= */
    function applySettings(){
      setTheme(settings.theme || "light");
      setFocus(settings.focus===1);
    }

    ensureDay();
    buildDrawer();
    applySettings();

    // start counts if missing
    if(!state.startCounts || (!state.startCounts.tasks && !state.startCounts.eth)){
      recalcStartCounts();
    }

    ensureCurrent();
    renderAll();
    tick();

  })();
  </script>
</body>
</html>
