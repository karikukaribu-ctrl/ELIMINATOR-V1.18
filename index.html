<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>ELIMINATOR</title>

  <style>
    /* =========================
       ELIMINATOR ‚Äî v2.3 (monochrome glass, fewer tabs, fixed logic)
       - Th√®me clair par d√©faut
       - Barre globale = 100% remplie puis diminue
       - Timer fiable
       - Roulette ronde avec "ROULETTE" qui tourne
       - Micro-actions = ic√¥nes minimalistes
       - Habitudes restaur√©es
       - Kiffance banque beaucoup plus riche
       - Sets panel √† droite (ind√©pendant) masquable
       ========================= */

    :root{
      --bg:#f4f6fb;
      --fg:#0f1218;
      --muted:#5e6776;

      --glass: rgba(255,255,255,.62);
      --glass2: rgba(255,255,255,.78);
      --stroke: rgba(16,18,24,.12);
      --stroke2: rgba(16,18,24,.08);

      --shadow: 0 12px 34px rgba(16,18,24,.12);
      --shadow2: 0 8px 22px rgba(16,18,24,.10);

      --radius: 20px;
      --radius2: 16px;

      --barbg: rgba(16,18,24,.10);
      --barfg: rgba(16,18,24,.65);

      --focusRing: rgba(80,120,255,.18); /* tr√®s discret */
    }

    [data-theme="dark"]{
      --bg:#0f1115;
      --fg:#e9edf5;
      --muted:#a8b0bd;

      --glass: rgba(255,255,255,.06);
      --glass2: rgba(255,255,255,.09);
      --stroke: rgba(255,255,255,.12);
      --stroke2: rgba(255,255,255,.08);

      --shadow: 0 14px 34px rgba(0,0,0,.38);
      --shadow2: 0 10px 24px rgba(0,0,0,.30);

      --barbg: rgba(255,255,255,.12);
      --barfg: rgba(255,255,255,.62);

      --focusRing: rgba(120,170,255,.16);
    }

    *{ box-sizing:border-box }
    html,body{ height:100% }
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      color: var(--fg);
      background:
        radial-gradient(1100px 700px at 15% -10%, var(--focusRing), transparent 60%),
        radial-gradient(900px 600px at 105% 0%, rgba(255,255,255,.06), transparent 55%),
        var(--bg);
      overflow-x:hidden;
    }

    /* ===== Layout ===== */
    .shell{
      width:min(980px,100%);
      margin:0 auto;
      padding: 12px 14px 96px;
    }

    .topbar{
      position: sticky;
      top:0;
      z-index:40;
      padding: 10px 0 12px;
      backdrop-filter: blur(16px);
      -webkit-backdrop-filter: blur(16px);
    }

    .topRow{
      display:flex;
      flex-wrap:wrap;
      gap: 10px 12px;
      align-items:center;
      justify-content:space-between;
    }

    .leftGroup, .rightGroup{
      display:flex;
      flex-wrap:wrap;
      gap: 8px;
      align-items:center;
    }

    .hud{
      display:flex;
      flex-wrap:wrap;
      gap: 8px;
      align-items:center;
      justify-content:flex-end;
      color: var(--muted);
      font-size: 13px;
      white-space:nowrap;
    }
    .pill{
      padding: 7px 10px;
      border-radius: 999px;
      border: 1px solid var(--stroke);
      background: var(--glass);
      box-shadow: var(--shadow2);
    }

    /* ===== Buttons (monochrome, glass) ===== */
    .btn{
      border: 1px solid var(--stroke);
      background: var(--glass);
      color: var(--fg);
      padding: 10px 12px;
      border-radius: 14px;
      box-shadow: var(--shadow2);
      cursor:pointer;
      user-select:none;
      font-weight: 760;
      letter-spacing:.01em;
      transition: transform .08s ease, box-shadow .2s ease, border-color .2s ease;
      line-height: 1;
    }
    .btn:active{ transform: translateY(1px) }
    .btn.pressed{
      box-shadow: 0 0 0 4px var(--focusRing), var(--shadow2);
    }
    .btn.ghost{
      background: transparent;
      box-shadow:none;
    }

    /* icon-only buttons */
    .iconBtn{
      width: 36px;
      height: 36px;
      display:grid;
      place-items:center;
      border-radius: 14px;
      border: 1px solid var(--stroke);
      background: var(--glass);
      box-shadow: var(--shadow2);
      cursor:pointer;
      font-weight: 920;
      line-height:1;
      user-select:none;
    }
    .iconBtn:active{ transform: translateY(1px) }
    .iconBtn.pressed{ box-shadow: 0 0 0 4px var(--focusRing), var(--shadow2); }

    /* ===== Main card ===== */
    .card{
      border-radius: var(--radius);
      border: 1px solid var(--stroke);
      background: var(--glass2);
      box-shadow: var(--shadow);
      backdrop-filter: blur(18px);
      -webkit-backdrop-filter: blur(18px);
      padding: 18px 18px 16px;
      margin-top: 8px;
    }

    .brand{
      text-align:center;
      margin: 8px 0 16px;
    }
    .brand h1{
      margin:0;
      font-size: clamp(40px, 4.6vw, 68px);
      letter-spacing: -0.035em;
      font-weight: 950;
    }
    .brand .tag{
      margin-top: 8px;
      color: var(--muted);
      font-size: 14px;
      letter-spacing:.02em;
    }

    /* ===== Progress zone isolated (visually separated) ===== */
    .progressZone{
      width: min(780px, 100%);
      margin: 18px auto 18px;
      padding: 18px 16px 14px;
      border-radius: var(--radius);
      border: 1px solid var(--stroke);
      background: var(--glass);
      box-shadow: var(--shadow);
    }

    .bigbar{
      position:relative;
      height: 40px;
      border-radius: 999px;
      background: var(--barbg);
      overflow:hidden;
    }
    .bigbar .fill{
      height:100%;
      width:100%;
      background: var(--barfg);
      transition: width .25s ease;
    }
    .bigbar .pct{
      position:absolute;
      inset:0;
      display:flex;
      align-items:center;
      justify-content:center;
      font-weight: 900;
      letter-spacing:.02em;
      font-size: 14px;
      color: var(--fg);
      pointer-events:none;
      text-shadow: 0 1px 0 rgba(0,0,0,.06);
    }

    .spacer{
      height: 18px;
    }

    .targetWrap{
      width: min(780px, 100%);
      margin: 0 auto;
      text-align:center;
    }
    .targetName{
      margin: 0 0 12px;
      font-size: clamp(22px, 2.3vw, 32px);
      font-weight: 880;
      letter-spacing: -0.012em;
    }

    .ethRow{
      display:flex;
      flex-direction:column;
      gap: 10px;
      align-items:center;
    }

    .ethBar{
      width: min(560px, 100%);
      height: 14px;
      border-radius: 999px;
      background: var(--barbg);
      overflow:hidden;
      position:relative;
    }
    .ethBar .fill{
      height:100%;
      width:100%;
      background: rgba(255,255,255,.0); /* set by theme below */
      transition: width .25s ease;
    }
    [data-theme="dark"] .ethBar .fill{ background: rgba(255,255,255,.42); }
    [data-theme="light"] .ethBar .fill{ background: rgba(16,18,24,.42); }

    .ethTicks{
      width: min(560px, 100%);
      display:flex;
      justify-content:center;
      gap: 6px;
      flex-wrap:wrap;
      opacity:.95;
    }
    .tick{
      width: 14px;
      height: 7px;
      border-radius: 999px;
      border: 1px dashed var(--stroke);
      background: transparent;
    }
    .tick.on{
      border-style: solid;
      border-color: transparent;
      background: rgba(255,255,255,.0);
    }
    [data-theme="dark"] .tick.on{ background: rgba(255,255,255,.32); }
    [data-theme="light"] .tick.on{ background: rgba(16,18,24,.28); }

    /* ===== Micro actions under target (icons only) ===== */
    .micro{
      width:min(780px,100%);
      margin: 14px auto 0;
      display:flex;
      justify-content:center;
      gap: 8px;
      flex-wrap:wrap;
    }

    /* ===== Primary actions row ===== */
    .actions{
      width:min(780px,100%);
      margin: 16px auto 0;
      display:flex;
      justify-content:center;
      gap: 12px;
      flex-wrap:wrap;
      align-items:center;
    }

    /* Roulette as circle */
    .roulette{
      width: 96px;
      height: 96px;
      border-radius: 999px;
      display:grid;
      place-items:center;
      border: 1px solid var(--stroke);
      background: var(--glass);
      box-shadow: var(--shadow);
      cursor:pointer;
      user-select:none;
      position:relative;
      overflow:hidden;
    }
    .roulette .ring{
      position:absolute;
      inset: 10px;
      border-radius: 999px;
      border: 2px solid var(--stroke);
      opacity:.9;
    }
    .roulette .txt{
      font-weight: 920;
      letter-spacing:.14em;
      font-size: 12px;
      color: var(--fg);
      text-transform: uppercase;
    }
    .roulette.spin{
      animation: rouletteSpin .65s ease;
    }
    @keyframes rouletteSpin{
      0%{ transform: rotate(0deg) scale(1); }
      55%{ transform: rotate(290deg) scale(1.04); }
      100%{ transform: rotate(360deg) scale(1); }
    }

    .bombBtn{
      min-width: 260px;
      padding: 16px 18px;
      border-radius: 18px;
      font-size: 16px;
    }

    /* ===== Inline list (masquable, m√™me en focus) ===== */
    .inlineListWrap{
      width: min(780px, 100%);
      margin: 18px auto 0;
      padding: 12px;
      border-radius: var(--radius);
      border: 1px solid var(--stroke);
      background: var(--glass);
      box-shadow: var(--shadow);
      backdrop-filter: blur(16px);
      -webkit-backdrop-filter: blur(16px);
    }
    .inlineHead{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap: 10px;
      margin-bottom: 10px;
    }
    .inlineTitle{
      font-weight: 900;
      letter-spacing: -0.01em;
    }

    .list{
      display:flex;
      flex-direction:column;
      gap: 8px;
    }
    .item{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      padding: 10px 12px;
      border-radius: 16px;
      border: 1px solid var(--stroke2);
      background: rgba(255,255,255,.04);
    }
    [data-theme="light"] .item{ background: rgba(16,18,24,.03); }

    .t{
      flex:1;
      min-width:0;
    }
    .name{
      font-weight: 820;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
    }
    .sub{
      margin-top: 2px;
      font-size: 12px;
      color: var(--muted);
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
    }

    /* ===== Drawer ===== */
    .drawerBack{
      position:fixed;
      inset:0;
      background: rgba(0,0,0,.35);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      display:none;
      z-index:60;
    }
    [data-theme="light"] .drawerBack{ background: rgba(10,12,16,.16); }

    .drawer{
      position:fixed;
      top:0; bottom:0; left:0;
      width: min(520px, 94vw); /* plus large */
      background: var(--glass2);
      border-right: 1px solid var(--stroke);
      box-shadow: var(--shadow);
      backdrop-filter: blur(18px);
      -webkit-backdrop-filter: blur(18px);
      transform: translateX(-105%);
      transition: transform .22s ease;
      z-index:70;
      padding: 14px;
      display:flex;
      flex-direction:column;
      gap: 12px;
    }
    .drawer.open{ transform: translateX(0) }

    .drawerTop{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
    }
    .drawerTitle{
      font-weight: 950;
      letter-spacing: -0.02em;
    }

    .tabs{
      display:flex;
      gap: 8px;
      flex-wrap:wrap;
    }
    .tab{
      padding: 10px 12px;
      border-radius: 999px;
      border: 1px solid var(--stroke);
      background: var(--glass);
      box-shadow: var(--shadow2);
      cursor:pointer;
      font-weight: 820;
      font-size: 13px;
      user-select:none;
    }
    .tab.active{
      box-shadow: 0 0 0 4px var(--focusRing), var(--shadow2);
    }

    .view{
      flex:1;
      overflow:auto;
      padding-right: 4px;
    }

    .section{
      border: 1px solid var(--stroke);
      background: var(--glass);
      border-radius: var(--radius2);
      padding: 12px;
      box-shadow: var(--shadow2);
      margin-bottom: 10px;
    }
    .section h3{
      margin: 0 0 10px;
      font-size: 14px;
      letter-spacing:.01em;
    }
    .help{
      color: var(--muted);
      font-size: 13px;
      line-height: 1.45;
      margin: 8px 0 0;
    }

    textarea, input, select{
      width:100%;
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.04);
      color: var(--fg);
      border-radius: 14px;
      padding: 10px 12px;
      font: inherit;
      outline:none;
    }
    [data-theme="light"] textarea,
    [data-theme="light"] input,
    [data-theme="light"] select{
      background: rgba(16,18,24,.03);
    }

    .row{
      display:flex;
      gap: 8px;
      flex-wrap:wrap;
      align-items:center;
    }
    .row > *{ flex: 1 }
    .row .btn, .row .iconBtn{ flex: 0 0 auto }

    /* ===== Notes modal ===== */
    .modalBack{
      position:fixed;
      inset:0;
      background: rgba(0,0,0,.35);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      display:none;
      z-index:80;
    }
    [data-theme="light"] .modalBack{ background: rgba(10,12,16,.16); }

    .modal{
      position:fixed;
      inset: 10% 50% auto 50%;
      transform: translateX(-50%);
      width: min(760px, 94vw);
      background: var(--glass2);
      border:1px solid var(--stroke);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 14px;
      display:none;
      z-index:90;
    }
    .modalTop{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap: 10px;
      margin-bottom: 10px;
    }

    /* ===== Celebration overlay (bigger, previous vibe) ===== */
    .celeBack{
      position:fixed;
      inset:0;
      background: rgba(0,0,0,.38);
      backdrop-filter: blur(14px);
      -webkit-backdrop-filter: blur(14px);
      display:none;
      z-index:95;
    }
    [data-theme="light"] .celeBack{ background: rgba(10,12,16,.18); }

    .cele{
      position:fixed;
      inset: 16% 50% auto 50%;
      transform: translateX(-50%);
      width: min(860px, 94vw);
      border-radius: 24px;
      border:1px solid var(--stroke);
      background: var(--glass2);
      box-shadow: var(--shadow);
      padding: 22px 18px 18px;
      display:none;
      z-index:96;
      text-align:center;
    }
    .celeTitle{
      margin: 0 0 10px;
      font-weight: 980;
      letter-spacing: -0.02em;
      font-size: clamp(26px, 2.6vw, 38px);
    }
    .celeMsg{
      margin: 0 auto 14px;
      width: min(720px, 100%);
      color: var(--muted);
      font-size: 15px;
      line-height: 1.55;
    }

    /* ===== Confetti canvas ===== */
    #confetti{
      position:fixed;
      inset:0;
      pointer-events:none;
      z-index:120;
      display:none;
    }

    /* ===== Sets panel (right, independent) ===== */
    .setsPanel{
      position: fixed;
      top: 88px;
      right: 14px;
      width: min(360px, 92vw);
      max-height: calc(100vh - 110px);
      overflow:auto;
      border-radius: 20px;
      border: 1px solid var(--stroke);
      background: var(--glass2);
      box-shadow: var(--shadow);
      backdrop-filter: blur(18px);
      -webkit-backdrop-filter: blur(18px);
      padding: 12px;
      z-index:55;
      display:none;
    }
    .setsPanel.open{ display:block; }

    .setsHead{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      margin-bottom: 8px;
    }
    .setsHead .ttl{
      font-weight: 950;
      letter-spacing: -0.02em;
    }

    .chkRow{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding: 10px 10px;
      border-radius: 16px;
      border: 1px solid var(--stroke2);
      background: rgba(255,255,255,.04);
      margin-bottom: 8px;
    }
    [data-theme="light"] .chkRow{ background: rgba(16,18,24,.03); }
    .chkLeft{ min-width:0; flex:1; }
    .chkName{
      font-weight: 820;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
    }
    .chkSub{
      margin-top:2px;
      font-size: 12px;
      color: var(--muted);
    }
    .check{
      width: 22px; height: 22px;
      border-radius: 8px;
      border: 1px solid var(--stroke);
      background: transparent;
      cursor:pointer;
      display:grid;
      place-items:center;
      user-select:none;
      font-weight: 950;
    }
    .check.on{
      background: rgba(255,255,255,.18);
    }
    [data-theme="light"] .check.on{
      background: rgba(16,18,24,.10);
    }

    /* ===== Focus mode: keep HUD + main + inline list, hide drawer + sets panel ===== */
    .focus .drawerBack,
    .focus .drawer,
    .focus .setsPanel{
      display:none !important;
    }

    @media (max-width: 520px){
      .roulette{ width: 88px; height: 88px; }
      .bombBtn{ min-width: 220px; }
      .setsPanel{ right: 8px; }
    }
  </style>
</head>

<body data-theme="light">
  <canvas id="confetti"></canvas>

  <!-- Drawer -->
  <div class="drawerBack" id="drawerBack"></div>
  <aside class="drawer" id="drawer">
    <div class="drawerTop">
      <div class="drawerTitle">Menu</div>
      <button class="btn" id="btnCloseDrawer">Fermer</button>
    </div>

    <div class="tabs" id="tabs"></div>
    <div class="view" id="drawerView"></div>
  </aside>

  <!-- Notes modal -->
  <div class="modalBack" id="notesBack"></div>
  <div class="modal" id="notesModal">
    <div class="modalTop">
      <div style="font-weight:950;letter-spacing:-0.02em;">Notes</div>
      <button class="btn" id="btnCloseNotes">Fermer</button>
    </div>

    <div class="section">
      <h3>Nouvelle note</h3>
      <textarea id="noteInput" rows="3" placeholder="√âcris. √áa reste. M√™me apr√®s reset."></textarea>
      <div class="row" style="margin-top:10px;">
        <button class="btn" id="btnAddNote">Ajouter</button>
        <button class="btn ghost" id="btnClearNotes">Vider</button>
      </div>
      <p class="help">Sauvegarde locale (persistant).</p>
    </div>

    <div class="section">
      <h3>Historique des notes</h3>
      <div class="list" id="notesList"></div>
    </div>
  </div>

  <!-- Celebration -->
  <div class="celeBack" id="celeBack"></div>
  <div class="cele" id="celeModal">
    <div class="celeTitle" id="celeTitle">Victoire</div>
    <div class="celeMsg" id="celeMsg">...</div>
    <button class="btn" id="btnCloseCele">OK</button>
    <p class="help" id="celeHint" style="margin-top:10px;">(Surprise. Dispara√Æt aussi toute seule.)</p>
  </div>

  <!-- Sets panel (right) -->
  <aside class="setsPanel" id="setsPanel">
    <div class="setsHead">
      <div class="ttl">Sets</div>
      <button class="btn" id="btnCloseSets">Fermer</button>
    </div>

    <div class="section">
      <h3>G√©n√©rateur (ind√©pendant)</h3>
      <div class="row">
        <select id="setsType">
          <option value="hospital">H√¥pital</option>
          <option value="consult">Consult</option>
        </select>
        <input id="setsN" type="number" min="1" max="20" value="4" />
        <button class="btn" id="btnGenSets">G√©n√©rer</button>
      </div>
      <p class="help">Ces checklists ne touchent pas ta liste de t√¢ches. Elles vivent √† part, √† droite.</p>
    </div>

    <div class="section">
      <h3>Checklist</h3>
      <div id="setsChecklist"></div>
    </div>
  </aside>

  <div class="shell">
    <div class="topbar">
      <div class="topRow">
        <div class="leftGroup">
          <button class="btn" id="btnMenu">Menu</button>
          <button class="btn" id="btnTheme">Th√®me</button>
          <button class="btn" id="btnFocus">Focus</button>
          <button class="btn" id="btnToggleList">Liste</button>
          <button class="btn" id="btnSets">Sets</button>
          <button class="btn" id="btnReset">Reset</button>
        </div>
        <div class="rightGroup">
          <div class="hud" id="hud"></div>
        </div>
      </div>
    </div>

    <div class="card" id="card">
      <div class="brand">
        <h1>ELIMINATOR</h1>
        <div class="tag">D√©gomme toutes les t√¢ches. D√©gomme tous les √©torions en cours.</div>
      </div>

      <div class="progressZone">
        <div class="bigbar" aria-label="progression globale">
          <div class="fill" id="taskFill"></div>
          <div class="pct" id="taskPct">0%</div>
        </div>
      </div>

      <div class="spacer"></div>

      <div class="targetWrap">
        <div class="targetName" id="currentTitle">Aucune t√¢che</div>

        <div class="ethRow">
          <div class="ethBar" aria-label="progression √©torions">
            <div class="fill" id="ethFill"></div>
          </div>
          <div class="ethTicks" id="ethTicks"></div>
        </div>
      </div>

      <div class="micro" id="microActions" aria-label="actions t√¢che">
        <button class="iconBtn" id="btnPin" title="√âpingler">‚üê</button>
        <button class="iconBtn" id="btnEdit" title="√âditer">‚úé</button>
        <button class="iconBtn" id="btnDown" title="Descendre">‚Üì</button>
        <button class="iconBtn" id="btnDone" title="Marquer d√©gomm√©e">‚úì</button>
        <button class="iconBtn" id="btnDel" title="Supprimer">‚úï</button>
      </div>

      <div class="actions">
        <div class="roulette" id="btnRoulette" title="Roulette">
          <div class="ring"></div>
          <div class="txt">ROULETTE</div>
        </div>

        <button class="btn bombBtn" id="btnDegomme">üí£ D√©gommer 1 √©torion</button>
        <button class="btn" id="btnNotes">Notes</button>
      </div>

      <div class="inlineListWrap" id="inlineListWrap" style="display:none;">
        <div class="inlineHead">
          <div class="inlineTitle">T√¢ches en cours</div>
          <button class="btn" id="btnHideList">Masquer</button>
        </div>
        <div class="list" id="inlineTaskList"></div>
      </div>
    </div>
  </div>

  <script>
    // =========================
    // Storage keys
    // =========================
    const KEY_STATE    = "elim_state_v23";
    const KEY_SETTINGS = "elim_settings_v23";
    const KEY_NOTES    = "elim_notes_v23";
    const KEY_KIFF     = "elim_kiffbank_v23";
    const KEY_HABITS   = "elim_habits_v23";
    const KEY_SETS     = "elim_sets_v23";

    // =========================
    // Helpers
    // =========================
    const el = (id)=>document.getElementById(id);
    const clamp = (x,a,b)=>Math.max(a,Math.min(b,x));
    const pad2 = (n)=>String(n).padStart(2,"0");
    const nowISO = ()=>new Date().toISOString();
    const dayKey = (d=new Date())=>`${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`;
    const uniq = ()=>Math.random().toString(16).slice(2)+Date.now().toString(16);
    const fmtTime = (ms)=>{
      const s = Math.floor(ms/1000);
      const m = Math.floor(s/60);
      const r = s%60;
      return `${m}:${pad2(r)}`;
    };
    const rand = (n)=>Math.floor(Math.random()*n);
    function downloadText(filename, text){
      const blob = new Blob([text], {type:"text/plain;charset=utf-8"});
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    }

    function load(key, fallback){
      try{
        const raw = localStorage.getItem(key);
        if(!raw) return structuredClone(fallback);
        const obj = JSON.parse(raw);
        // shallow merge fallback -> obj
        return Object.assign(structuredClone(fallback), obj);
      }catch{
        return structuredClone(fallback);
      }
    }
    function save(key, obj){
      localStorage.setItem(key, JSON.stringify(obj));
    }

    // =========================
    // Defaults (IMPORTANT: no preloaded tasks)
    // =========================
    const DEFAULT_SETTINGS = {
      theme: "light",
      focus: 0,
      listVisible: 0,
      setsVisible: 0,

      // Surprise celebrations
      fatigue: 2,           // 0..4
      motivation: 2,        // 0..4
      celeChanceBase: 0.20, // base prob per completed task
      celeAutoCloseSec: 10,

      // Filtering
      activeCats: [],       // [] => all

      // Roulette mode
      rouletteMode: "random", // random | ordered
      orderedStrategy: "pinnedFirst" // pinnedFirst | alpha | chrono
    };

    const DEFAULT_STATE = {
      tasks: [],
      done: [],
      currentId: null,

      // baseline for the current "session" (to make bar decrease correctly)
      baseline: {
        setAt: "",
        totalEth: 0
      },

      // timer
      timer: {
        taskId: null,
        elapsedMs: 0,
        running: false,
        lastTick: 0
      },

      // streak for celebration gating
      streak: { completedSinceCele: 0 }
    };

    // Right-side sets (independent)
    const DEFAULT_SETS = {
      type: "hospital",
      n: 4,
      items: [] // {id, label, sub, done}
    };

    // =========================
    // State
    // =========================
    let settings = load(KEY_SETTINGS, DEFAULT_SETTINGS);
    let state    = load(KEY_STATE, DEFAULT_STATE);
    let notes    = load(KEY_NOTES, []);
    let habits   = load(KEY_HABITS, []);
    let sets     = load(KEY_SETS, DEFAULT_SETS);

    // Kiff bank: big + 4 buckets
    function initKiffBank(){
      return {
        v: 1,
        buckets: {
          "5m": [
            "Boire un verre d‚Äôeau comme si tu scellais un trait√© de paix.",
            "Respiration 4-4-4-4 pendant 2 minutes.",
            "√âtirement nuque + √©paules 90 secondes.",
            "Nettoyer une surface (une seule) : bureau / √©vier / table.",
            "Fermer 5 onglets inutiles. Ex√©cution chirurgicale.",
            "Mettre un timer 5 min et faire le ¬´ d√©but moche ¬ª.",
            "√âcrire une phrase : ¬´ L√†, je fais X. ¬ª",
            "200 pas dans la pi√®ce, sans t√©l√©phone.",
            "Ranger 10 objets : jeter / classer / ranger.",
            "Regarder la prochaine micro-√©tape uniquement (pas le monde entier).",
            "D√©crisper les mains : ouvrir/fermer 20 fois.",
            "Regarder au loin 30 secondes (repos oculaire).",
            "Mettre le t√©l√©phone face cach√©e. 5 minutes de silence tactique.",
            "Micro-scan corporel : front, m√¢choire, √©paules, ventre (rel√¢cher).",
            "Aligner 3 objets. Oui. C‚Äôest b√™te. Oui. √áa marche."
          ],
          "10m": [
            "Marche rapide 8 min + 2 min retour calme.",
            "Ranger un tiroir (un seul) pendant 10 min puis stop.",
            "Pr√©parer eau + snack simple. Pas d‚Äô≈ìuvre d‚Äôart.",
            "Faire un mini plan : 3 puces max.",
            "Relire une page difficile et noter 3 mots-cl√©s.",
            "√âtirement dos + hanches 10 minutes.",
            "Nettoyer la zone ¬´ entr√©e ¬ª (chaussures, manteaux) 10 min.",
            "Trier 10 mails/notes: supprimer / archiver / r√©pondre plus tard.",
            "Pr√©parer ¬´ kit reprise ¬ª : doc ouvert + stylo + eau + timer.",
            "Faire 10 min de ‚Äúbrouillon‚Äù sur un document p√©nible.",
            "S‚Äôasseoir droit 2 min, puis reprendre doucement.",
            "Mettre √† jour une seule section d‚Äôun dossier.",
            "D√©sencombrer le bureau: 1 pile max.",
            "Ranger le sac / la poche / le badge : 10 min.",
            "√âcrire 5 lignes de d√©charge mentale puis reprendre."
          ],
          "15m": [
            "Marche 12 min + 3 min respiration lente.",
            "Mobilit√© compl√®te (cou/√©paules/hanches) 15 min.",
            "Pr√©parer une mini to-do pour demain (5 lignes max).",
            "Lecture plaisir 10 min + 5 min retour t√¢che.",
            "Nettoyage express 15 min d‚Äôune zone (timer strict).",
            "Pr√©parer 2 repas simples (version minimaliste).",
            "Batch administratif: 15 minutes de ¬´ tri / classer / envoyer ¬ª.",
            "√âcrire une page brouillon, puis extraire 3 actions.",
            "Revoir une t√¢che compliqu√©e en 3 √©tapes et s‚Äôarr√™ter l√†.",
            "√âtirements + respiration : 10 + 5.",
            "Ranger les documents d‚Äôaujourd‚Äôhui (pile unique).",
            "Mettre une pause sensorielle : lumi√®re douce, silence, 15 min.",
            "R√©organiser l‚Äôordre de 5 t√¢ches (juste 5).",
            "Petit rangement des v√™tements (une seule cat√©gorie).",
            "Pr√©parer un espace ‚Äúflow‚Äù : distractions dehors."
          ],
          "25m+": [
            "Marche dehors 25‚Äì35 min (sans scroll).",
            "S√©ance sport douce/mod√©r√©e 30‚Äì40 min.",
            "Deep-clean zone (25 min) puis arr√™t net.",
            "Cuisine simple pour 2 repas (batch minimaliste).",
            "Revue hebdo 30 min: ce qui compte / ce qui part / ce qui reste.",
            "Lecture cibl√©e 25 min + notes 5 min.",
            "Session ¬´ admin lourde ¬ª 25 min puis stop net.",
            "Organisation du lendemain: agenda + 3 priorit√©s (30 min).",
            "R√©arranger ton poste de travail (c√¢bles / documents) 25 min.",
            "T√¢che de fond: 25 min de concentration, puis pause.",
            "Faire une lessive + pliage minimaliste (pas parfait).",
            "√âcrire un plan structur√© (25 min) pour un gros dossier.",
            "Pr√©parer ton tour de salle (structure + check) 30 min.",
            "Vis√©e ‚Äúflow‚Äù: musique off, notif off, 25 min d‚Äôaction pure.",
            "Faire une vraie pause (sieste 20 min + retour)."
          ]
        }
      };
    }
    let kiffBank = load(KEY_KIFF, null);
    if(!kiffBank || !kiffBank.buckets){
      kiffBank = initKiffBank();
      save(KEY_KIFF, kiffBank);
    }

    function persist(){
      save(KEY_SETTINGS, settings);
      save(KEY_STATE, state);
      save(KEY_NOTES, notes);
      save(KEY_HABITS, habits);
      save(KEY_KIFF, kiffBank);
      save(KEY_SETS, sets);
    }

    // =========================
    // UI refs
    // =========================
    const btnMenu       = el("btnMenu");
    const btnTheme      = el("btnTheme");
    const btnFocus      = el("btnFocus");
    const btnToggleList = el("btnToggleList");
    const btnSets       = el("btnSets");
    const btnReset      = el("btnReset");

    const hud        = el("hud");
    const taskFill   = el("taskFill");
    const taskPct    = el("taskPct");
    const currentTitle = el("currentTitle");
    const ethFill    = el("ethFill");
    const ethTicks   = el("ethTicks");

    const btnRoulette = el("btnRoulette");
    const btnDegomme  = el("btnDegomme");
    const btnNotes    = el("btnNotes");

    const btnPin = el("btnPin");
    const btnEdit = el("btnEdit");
    const btnDown = el("btnDown");
    const btnDone = el("btnDone");
    const btnDel  = el("btnDel");

    const inlineListWrap = el("inlineListWrap");
    const inlineTaskList = el("inlineTaskList");
    const btnHideList = el("btnHideList");

    const drawerBack = el("drawerBack");
    const drawer = el("drawer");
    const btnCloseDrawer = el("btnCloseDrawer");
    const tabsEl = el("tabs");
    const drawerView = el("drawerView");

    const notesBack = el("notesBack");
    const notesModal = el("notesModal");
    const btnCloseNotes = el("btnCloseNotes");
    const noteInput = el("noteInput");
    const btnAddNote = el("btnAddNote");
    const btnClearNotes = el("btnClearNotes");
    const notesList = el("notesList");

    const celeBack = el("celeBack");
    const celeModal = el("celeModal");
    const celeTitle = el("celeTitle");
    const celeMsg = el("celeMsg");
    const btnCloseCele = el("btnCloseCele");

    const confettiCanvas = el("confetti");
    const ctx = confettiCanvas.getContext("2d");

    const setsPanel = el("setsPanel");
    const btnCloseSets = el("btnCloseSets");
    const setsType = el("setsType");
    const setsN = el("setsN");
    const btnGenSets = el("btnGenSets");
    const setsChecklist = el("setsChecklist");

    // =========================
    // Tabs (fewer, merged)
    // =========================
    const TAB_DEFS = [
      { key:"import", label:"Importer" },
      { key:"tasks",  label:"T√¢ches" },
      { key:"kiff",   label:"Kiffance" },
      { key:"habits", label:"Habitudes" },
      { key:"stats",  label:"Stats/Export" },
      { key:"settings", label:"R√©glages" }
    ];
    let activeTab = "import";

    // =========================
    // Theme / focus / toggles
    // =========================
    function applyTheme(){
      document.body.setAttribute("data-theme", settings.theme);
      btnTheme.classList.toggle("pressed", settings.theme === "light");
    }
    function applyFocus(){
      document.body.classList.toggle("focus", !!settings.focus);
      btnFocus.classList.toggle("pressed", !!settings.focus);
    }
    function applyListVisible(){
      inlineListWrap.style.display = settings.listVisible ? "" : "none";
      btnToggleList.classList.toggle("pressed", !!settings.listVisible);
      if(settings.listVisible) renderInlineList();
    }
    function applySetsVisible(){
      setsPanel.classList.toggle("open", !!settings.setsVisible);
      btnSets.classList.toggle("pressed", !!settings.setsVisible);
      if(settings.setsVisible) renderSetsPanel();
    }

    // =========================
    // Baseline logic (fix progress bar)
    // - baseline.totalEth set when:
    //   * first task added
    //   * reset baseline explicitly in settings
    //   * if baseline missing/invalid
    // Progress bar fill = ethLeft / baseline.totalEth
    // =========================
    function totalEthLeft(){
      return state.tasks.reduce((a,t)=>a+(t.ethLeft||0),0);
    }
    function totalEthAllStart(){
      // start eth across active tasks + done (original ethStart)
      const doneEth = state.done.reduce((a,t)=>a+(t.ethStart||0),0);
      return totalEthLeft() + doneEth;
    }

    function ensureBaseline(){
      const today = dayKey();
      const left = totalEthLeft();
      // baseline should reflect the "start of the session" for the global bar
      // If tasks are empty => baseline resets to 0.
      if(state.tasks.length === 0){
        state.baseline = { setAt: today, totalEth: 0 };
        return;
      }
      if(!state.baseline || !state.baseline.totalEth || state.baseline.totalEth < left){
        // set baseline to current total remaining + done to avoid weird jumps
        const base = totalEthAllStart();
        state.baseline = { setAt: today, totalEth: base };
      }
      // if new import increases total above baseline, expand baseline to match:
      const currentAll = totalEthAllStart();
      if(currentAll > state.baseline.totalEth){
        state.baseline.totalEth = currentAll;
        state.baseline.setAt = today;
      }
    }

    // =========================
    // Current task + timer (fix not starting)
    // =========================
    function currentTask(){
      return state.tasks.find(t=>t.id===state.currentId) || null;
    }

    function ensureCurrent(){
      if(state.currentId && state.tasks.some(t=>t.id===state.currentId)) return;
      // prefer pinned
      const pinned = state.tasks.find(t=>t.pinned);
      state.currentId = (pinned || state.tasks[0] || null)?.id || null;
      // reset timer for new current
      if(state.currentId){
        state.timer = { taskId: state.currentId, elapsedMs: 0, running: true, lastTick: Date.now() };
      }else{
        state.timer = { taskId: null, elapsedMs: 0, running: false, lastTick: 0 };
      }
    }

    function setCurrent(id){
      state.currentId = id;
      state.timer = { taskId: id, elapsedMs: 0, running: true, lastTick: Date.now() };
      persist();
      renderAll();
    }

    function tickTimer(){
      const t = state.timer;
      if(!t || !t.running || !t.taskId) return;
      const now = Date.now();
      if(!t.lastTick) t.lastTick = now;
      const delta = now - t.lastTick;
      t.elapsedMs += Math.max(0, delta);
      t.lastTick = now;
    }

    // =========================
    // Task model
    // =========================
    function makeTask(title, cat="INBOX", eth=1, prio=0){
      const e = clamp(parseInt(eth||1,10) || 1, 1, 999);
      return {
        id: uniq(),
        title: (title||"").trim(),
        cat: (cat||"INBOX").trim() || "INBOX",
        ethStart: e,
        ethLeft: e,
        prio: prio ? 1 : 0,
        pinned: false,
        createdAt: nowISO(),
        updatedAt: nowISO()
      };
    }

    function deleteTask(id){
      const idx = state.tasks.findIndex(t=>t.id===id);
      if(idx<0) return;
      const wasCurrent = state.currentId===id;
      state.tasks.splice(idx,1);
      if(wasCurrent) state.currentId = null;
      ensureBaseline();
      ensureCurrent();
      persist();
      renderAll();
    }

    function editTaskTitle(id, newTitle){
      const t = state.tasks.find(x=>x.id===id);
      if(!t) return;
      const nt = (newTitle||"").trim();
      if(!nt) return;
      t.title = nt;
      t.updatedAt = nowISO();
      persist();
      renderAll();
      renderDrawer(); // keep sync
    }

    function moveTask(id, delta){
      const i = state.tasks.findIndex(x=>x.id===id);
      const j = i + delta;
      if(i<0 || j<0 || j>=state.tasks.length) return;
      const tmp = state.tasks[j];
      state.tasks[j] = state.tasks[i];
      state.tasks[i] = tmp;
      persist();
      renderAll();
      renderDrawer();
    }

    function pushDownCurrent(){
      const t = currentTask();
      if(!t) return;
      const i = state.tasks.findIndex(x=>x.id===t.id);
      if(i<0) return;
      state.tasks.splice(i,1);
      state.tasks.push(t);
      persist();
      renderAll();
    }

    function pinToggle(){
      const t = currentTask();
      if(!t) return;
      t.pinned = !t.pinned;
      t.updatedAt = nowISO();
      persist();
      renderAll();
    }

    function markDone(id){
      const idx = state.tasks.findIndex(t=>t.id===id);
      if(idx<0) return;
      const t = state.tasks[idx];
      t.doneAt = nowISO();
      state.done.push(t);
      state.tasks.splice(idx,1);

      // confetti always on task completion
      burstConfetti();

      // celebration surprise occasionally
      state.streak.completedSinceCele = (state.streak.completedSinceCele||0) + 1;
      maybeCelebrate();

      if(state.currentId===id) state.currentId = null;
      ensureBaseline();
      ensureCurrent();
      persist();
      renderAll();
    }

    function degommeOneEth(){
      const t = currentTask();
      if(!t) return;

      tickTimer();

      t.ethLeft = Math.max(0, (t.ethLeft||0) - 1);
      t.updatedAt = nowISO();

      if(t.ethLeft===0){
        markDone(t.id);
        return;
      }
      ensureBaseline();
      persist();
      renderAll();
    }

    // =========================
    // Parsing inbox (FIXED format)
    // - UPPERCASE line = category header
    // - task line: "Nom - 3" OR "Nom 3" at end => eth=3
    // - optional priority marker "!" (kept, not displayed by default)
    // =========================
    function isCategoryHeader(line){
      if(!line || line.length < 3 || line.length > 46) return false;
      if(/\d/.test(line)) return false;
      const hasLetter = /[A-Z√Ä-√ñ√ò-√ù]/.test(line);
      if(!hasLetter) return false;
      return line === line.toUpperCase();
    }
    function normalizeCat(s){
      return (s||"").trim().toUpperCase();
    }

    function parseInbox(text){
      const lines = (text||"")
        .split(/\r?\n/)
        .map(s=>s.trim())
        .filter(Boolean);

      let cat = "INBOX";
      const out = [];

      for(const lineRaw of lines){
        if(isCategoryHeader(lineRaw)){
          cat = normalizeCat(lineRaw);
          continue;
        }
        let line = lineRaw;
        let prio = 0;
        if(line.includes("!")){
          prio = 1;
          line = line.replace(/!/g,"").trim();
        }

        let title = line;
        let eth = 1;

        const m1 = title.match(/^(.*?)(?:\s*[-‚Äì‚Äî]\s*)(\d{1,3})$/);
        const m2 = title.match(/^(.*?)(?:\s+)(\d{1,3})$/);

        if(m1){
          title = m1[1].trim();
          eth = parseInt(m1[2],10);
        }else if(m2){
          if(m2[1].trim()){
            title = m2[1].trim();
            eth = parseInt(m2[2],10);
          }
        }

        if(!title) continue;
        out.push(makeTask(title, cat, eth, prio));
      }
      return out;
    }

    // =========================
    // Roulette pick
    // =========================
    function filteredTasks(){
      if(!settings.activeCats || settings.activeCats.length===0) return state.tasks;
      return state.tasks.filter(t => settings.activeCats.includes(t.cat||"INBOX"));
    }

    function pickRoulette(){
      const pool = filteredTasks();
      if(!pool.length) return null;

      if(settings.rouletteMode === "ordered"){
        const ordered = [...pool];
        if(settings.orderedStrategy === "pinnedFirst"){
          ordered.sort((a,b)=>(b.pinned?1:0)-(a.pinned?1:0) || (a.createdAt||"").localeCompare(b.createdAt||""));
        }else if(settings.orderedStrategy === "alpha"){
          ordered.sort((a,b)=>(a.title||"").localeCompare(b.title||"", "fr", {sensitivity:"base"}));
        }else{
          ordered.sort((a,b)=>(a.createdAt||"").localeCompare(b.createdAt||""));
        }
        return ordered[0];
      }else{
        return pool[rand(pool.length)];
      }
    }

    // =========================
    // HUD (minimal) + rendering
    // =========================
    function renderHUD(){
      // make sure timer keeps moving
      const t = state.timer;
      let elapsed = "0:00";
      if(t && t.taskId === state.currentId) elapsed = fmtTime(t.elapsedMs||0);

      const tasksLeft = state.tasks.length;
      const tasksDone = state.done.length;
      const tasksStart = tasksLeft + tasksDone; // session-based, always consistent

      const ethLeft = totalEthLeft();
      const ethStart = Math.max(0, (state.baseline?.totalEth||0));

      hud.innerHTML = `
        <div class="pill">${tasksLeft}/${Math.max(0,tasksStart)} t√¢ches</div>
        <div class="pill">${ethLeft}/${ethStart} √©torions</div>
        <div class="pill">${tasksDone} fait</div>
        <div class="pill">${elapsed}</div>
      `;
    }

    function renderProgress(){
      ensureBaseline();

      const base = Math.max(0, state.baseline.totalEth||0);
      const left = totalEthLeft();

      // If base==0 => show 0% done, bar full? better: show 0% with empty? We choose neutral:
      if(base === 0){
        taskFill.style.width = "100%";
        taskPct.textContent = "0%";
        return;
      }

      // bar fill should represent "remaining": left/base
      const remaining = clamp((left / base) * 100, 0, 100);
      const donePct = 100 - remaining;

      taskFill.style.width = `${remaining}%`;
      taskPct.textContent = `${Math.round(donePct)}%`;
    }

    function renderCurrent(){
      ensureCurrent();
      const t = currentTask();

      currentTitle.textContent = t ? t.title : "Aucune t√¢che";

      // micro actions state
      btnPin.classList.toggle("pressed", !!t?.pinned);

      // eth bar + ticks
      ethTicks.innerHTML = "";
      if(!t){
        ethFill.style.width = "0%";
        return;
      }

      const start = Math.max(1, t.ethStart||1);
      const left = clamp(t.ethLeft||0, 0, start);
      const pct = (left/start)*100;
      ethFill.style.width = `${pct}%`;

      for(let i=0;i<start;i++){
        const dot = document.createElement("div");
        dot.className = "tick " + (i < left ? "on" : "");
        ethTicks.appendChild(dot);
      }
    }

    function renderInlineList(){
      inlineTaskList.innerHTML = "";
      const tasks = filteredTasks();
      if(!tasks.length){
        const p = document.createElement("p");
        p.className="help";
        p.textContent="Aucune t√¢che dans la s√©lection.";
        inlineTaskList.appendChild(p);
        return;
      }

      for(const t of tasks){
        const row = document.createElement("div");
        row.className="item";

        const left = document.createElement("div");
        left.className="t";

        const nm = document.createElement("div");
        nm.className="name";
        nm.textContent = t.title + (t.id===state.currentId ? " (en cours)" : "");

        const sb = document.createElement("div");
        sb.className="sub";
        sb.textContent = `${t.cat||"INBOX"} ¬∑ ${t.ethLeft}/${t.ethStart}` + (t.pinned ? " ¬∑ √©pingl√©e" : "");

        left.appendChild(nm);
        left.appendChild(sb);

        const up = document.createElement("button");
        up.className="iconBtn";
        up.textContent="‚Üë";
        up.title="Monter";
        up.onclick = ()=>moveTask(t.id, -1);

        const down = document.createElement("button");
        down.className="iconBtn";
        down.textContent="‚Üì";
        down.title="Descendre";
        down.onclick = ()=>moveTask(t.id, +1);

        row.onclick = (ev)=>{
          if(ev.target && ev.target.closest && ev.target.closest("button")) return;
          setCurrent(t.id);
        };

        row.appendChild(left);
        row.appendChild(up);
        row.appendChild(down);
        inlineTaskList.appendChild(row);
      }
    }

    function renderAll(){
      applyTheme();
      applyFocus();
      ensureBaseline();
      renderHUD();
      renderProgress();
      renderCurrent();
      applyListVisible();
      applySetsVisible();
    }

    // =========================
    // Drawer: open/close/render
    // =========================
    function openDrawer(){
      drawerBack.style.display="block";
      drawer.classList.add("open");
      renderDrawer();
    }
    function closeDrawer(){
      drawerBack.style.display="none";
      drawer.classList.remove("open");
    }

    function renderTabs(){
      tabsEl.innerHTML = "";
      for(const t of TAB_DEFS){
        const b = document.createElement("button");
        b.className = "tab" + (t.key===activeTab ? " active" : "");
        b.textContent = t.label;
        b.onclick = ()=>{ activeTab = t.key; renderTabs(); renderDrawer(); };
        tabsEl.appendChild(b);
      }
    }

    function renderDrawer(){
      drawerView.innerHTML = "";
      if(activeTab==="import") drawerView.appendChild(viewImport());
      else if(activeTab==="tasks") drawerView.appendChild(viewTasks());
      else if(activeTab==="kiff") drawerView.appendChild(viewKiff());
      else if(activeTab==="habits") drawerView.appendChild(viewHabits());
      else if(activeTab==="stats") drawerView.appendChild(viewStats());
      else if(activeTab==="settings") drawerView.appendChild(viewSettings());
    }

    function section(title){
      const s = document.createElement("div");
      s.className="section";
      const h = document.createElement("h3");
      h.textContent = title;
      s.appendChild(h);
      return s;
    }

    // =========================
    // Views
    // =========================
    function viewImport(){
      const wrap = document.createElement("div");

      const s = section("Importer une liste");
      const ta = document.createElement("textarea");
      ta.rows = 9;
      ta.placeholder =
`CATEGORIE
T√¢che A - 3
T√¢che B 2
AUTRE CATEGORIE
T√¢che C - 1
T√¢che D ! - 4`;
      s.appendChild(ta);

      const row = document.createElement("div");
      row.className="row";
      row.style.marginTop="10px";

      const add = document.createElement("button");
      add.className="btn";
      add.textContent="Ajouter";
      add.onclick = ()=>{
        const added = parseInbox(ta.value);
        if(!added.length) return;
        state.tasks.push(...added);

        // baseline expands automatically in ensureBaseline()
        ensureCurrent();
        ensureBaseline();

        // categories list (for filter tab)
        const cats = Array.from(new Set(state.tasks.map(t=>t.cat||"INBOX")));
        // if user had activeCats, keep; else none => all. Don't force INBOX.

        persist();
        renderAll();
        renderDrawer();
      };

      const clear = document.createElement("button");
      clear.className="btn ghost";
      clear.textContent="Vider";
      clear.onclick = ()=>ta.value="";

      row.appendChild(add);
      row.appendChild(clear);
      s.appendChild(row);

      const help = document.createElement("p");
      help.className="help";
      help.textContent = "MAJUSCULES = cat√©gorie. ‚Äú- 3‚Äù ou ‚Äú 3‚Äù en fin = √©torions. ‚Äú!‚Äù = priorit√© (optionnel).";
      s.appendChild(help);

      wrap.appendChild(s);
      return wrap;
    }

    function viewTasks(){
      const wrap = document.createElement("div");

      // Task list (minimal actions)
      const s = section("Liste (actions minimales)");
      const lst = document.createElement("div");
      lst.className="list";

      if(!state.tasks.length){
        const p = document.createElement("p");
        p.className="help";
        p.textContent="Aucune t√¢che.";
        s.appendChild(p);
      }else{
        for(const t of state.tasks){
          const row = document.createElement("div");
          row.className="item";

          const left = document.createElement("div");
          left.className="t";

          const nm = document.createElement("div");
          nm.className="name";
          nm.textContent = t.title + (t.id===state.currentId ? " (en cours)" : "");

          const sb = document.createElement("div");
          sb.className="sub";
          sb.textContent = `${t.cat||"INBOX"} ¬∑ ${t.ethLeft}/${t.ethStart}` + (t.pinned ? " ¬∑ √©pingl√©e" : "");

          left.appendChild(nm);
          left.appendChild(sb);

          const up = document.createElement("button");
          up.className="iconBtn";
          up.textContent="‚Üë";
          up.title="Monter";
          up.onclick = ()=>moveTask(t.id, -1);

          const down = document.createElement("button");
          down.className="iconBtn";
          down.textContent="‚Üì";
          down.title="Descendre";
          down.onclick = ()=>moveTask(t.id, +1);

          const edit = document.createElement("button");
          edit.className="iconBtn";
          edit.textContent="‚úé";
          edit.title="√âditer";
          edit.onclick = ()=>{
            const nt = prompt("Nouveau titre", t.title);
            if(nt!==null) editTaskTitle(t.id, nt);
          };

          const del = document.createElement("button");
          del.className="iconBtn";
          del.textContent="‚úï";
          del.title="Supprimer";
          del.onclick = ()=>deleteTask(t.id);

          row.onclick = (ev)=>{
            if(ev.target && ev.target.closest && ev.target.closest("button")) return;
            setCurrent(t.id);
          };

          row.appendChild(left);
          row.appendChild(up);
          row.appendChild(down);
          row.appendChild(edit);
          row.appendChild(del);
          lst.appendChild(row);
        }
        s.appendChild(lst);
      }

      wrap.appendChild(s);

      // Category filter (merged here)
      const s2 = section("Cat√©gories actives");
      const cats = Array.from(new Set(state.tasks.map(t=>t.cat||"INBOX"))).sort();
      if(!cats.length){
        const p = document.createElement("p");
        p.className="help";
        p.textContent="Aucune cat√©gorie (importe des t√¢ches).";
        s2.appendChild(p);
      }else{
        for(const c of cats){
          const row = document.createElement("div");
          row.className="row";
          row.style.justifyContent="space-between";

          const label = document.createElement("div");
          label.textContent = c;

          const cb = document.createElement("input");
          cb.type="checkbox";
          cb.style.width="18px";
          cb.style.height="18px";
          cb.checked = settings.activeCats.length ? settings.activeCats.includes(c) : true;
          cb.onchange = ()=>{
            if(settings.activeCats.length===0){
              // if previously "all", start from all and then remove
              settings.activeCats = [...cats];
            }
            if(cb.checked){
              if(!settings.activeCats.includes(c)) settings.activeCats.push(c);
            }else{
              settings.activeCats = settings.activeCats.filter(x=>x!==c);
              // if user unchecked all, interpret as "all" (less annoying)
              if(settings.activeCats.length===0){
                settings.activeCats = [];
              }
            }
            persist();
            renderAll();
            renderDrawer();
          };

          row.appendChild(label);
          row.appendChild(cb);
          s2.appendChild(row);
        }

        const row2 = document.createElement("div");
        row2.className="row";
        row2.style.marginTop="10px";

        const all = document.createElement("button");
        all.className="btn";
        all.textContent="Tout";
        all.onclick = ()=>{
          settings.activeCats = [];
          persist();
          renderAll();
          renderDrawer();
        };

        const none = document.createElement("button");
        none.className="btn ghost";
        none.textContent="S√©lectionner";
        none.onclick = ()=>{
          // switch to explicit selection mode (all checked)
          settings.activeCats = [...cats];
          persist();
          renderAll();
          renderDrawer();
        };

        row2.appendChild(all);
        row2.appendChild(none);
        s2.appendChild(row2);

        const help = document.createElement("p");
        help.className="help";
        help.textContent="Si aucune cat√©gorie n‚Äôest coch√©e, √ßa veut dire: tout (pour √©viter le pi√®ge du vide).";
        s2.appendChild(help);
      }
      wrap.appendChild(s2);

      // Quick mode (merged)
      const s3 = section("Roulette");
      const row3 = document.createElement("div");
      row3.className="row";

      const mode = document.createElement("select");
      mode.innerHTML = `
        <option value="random">Al√©atoire</option>
        <option value="ordered">Dans l‚Äôordre</option>
      `;
      mode.value = settings.rouletteMode;
      mode.onchange = ()=>{ settings.rouletteMode = mode.value; persist(); };

      const strat = document.createElement("select");
      strat.innerHTML = `
        <option value="pinnedFirst">√âpingl√©es d‚Äôabord</option>
        <option value="alpha">Alphabetique</option>
        <option value="chrono">Chronologique</option>
      `;
      strat.value = settings.orderedStrategy;
      strat.onchange = ()=>{ settings.orderedStrategy = strat.value; persist(); };

      row3.appendChild(mode);
      row3.appendChild(strat);
      s3.appendChild(row3);

      wrap.appendChild(s3);

      return wrap;
    }

    function viewKiff(){
      const wrap = document.createElement("div");

      const s = section("Kiffance (banque + suggestion)");
      const row = document.createElement("div");
      row.className="row";

      const sel = document.createElement("select");
      sel.innerHTML = `
        <option value="5m">5 min</option>
        <option value="10m">10 min</option>
        <option value="15m">15 min</option>
        <option value="25m+">25 min+</option>
      `;

      const out = document.createElement("textarea");
      out.rows = 3;
      out.readOnly = true;
      out.placeholder = "Suggestion‚Ä¶";

      function refresh(){
        const key = sel.value;
        const arr = kiffBank.buckets[key] || [];
        out.value = arr.length ? arr[rand(arr.length)] : "Banque vide.";
      }
      refresh();

      sel.onchange = refresh;

      const refreshBtn = document.createElement("button");
      refreshBtn.className="btn";
      refreshBtn.textContent="Rafra√Æchir";
      refreshBtn.onclick = refresh;

      const addTaskBtn = document.createElement("button");
      addTaskBtn.className="btn";
      addTaskBtn.textContent="Ajouter en t√¢che";
      addTaskBtn.onclick = ()=>{
        const txt = (out.value||"").trim();
        if(!txt) return;
        const eth = (sel.value==="5m") ? 1 : (sel.value==="10m") ? 2 : (sel.value==="15m") ? 3 : 5;
        state.tasks.unshift(makeTask(txt, "KIFFANCE", eth));
        ensureCurrent();
        ensureBaseline();
        persist();
        renderAll();
        renderDrawer();
      };

      row.appendChild(sel);
      row.appendChild(refreshBtn);
      row.appendChild(addTaskBtn);
      s.appendChild(row);
      s.appendChild(out);

      const help = document.createElement("p");
      help.className="help";
      help.textContent="Pas de c√©l√©bration √† l‚Äôajout. La c√©l√©bration est un animal sauvage: elle appara√Æt quand elle veut.";
      s.appendChild(help);

      wrap.appendChild(s);

      // Add to bank
      const s2 = section("Ajouter √† la banque");
      const txt = document.createElement("input");
      txt.placeholder = "Nouvelle kiffance (texte)";
      const row2 = document.createElement("div");
      row2.className="row";
      const sel2 = document.createElement("select");
      sel2.innerHTML = sel.innerHTML;

      const addBankBtn = document.createElement("button");
      addBankBtn.className="btn";
      addBankBtn.textContent="Ajouter";
      addBankBtn.onclick = ()=>{
        const v = (txt.value||"").trim();
        if(!v) return;
        const key = sel2.value;
        kiffBank.buckets[key] = kiffBank.buckets[key] || [];
        kiffBank.buckets[key].push(v);
        txt.value="";
        persist();
        renderDrawer();
      };

      row2.appendChild(sel2);
      row2.appendChild(addBankBtn);
      s2.appendChild(txt);
      s2.appendChild(row2);

      wrap.appendChild(s2);
      return wrap;
    }

    function viewHabits(){
      const wrap = document.createElement("div");

      const s = section("Suivi des habitudes");
      const row = document.createElement("div");
      row.className="row";

      const name = document.createElement("input");
      name.placeholder = "Nom d‚Äôhabitude";
      const total = document.createElement("input");
      total.type="number"; total.min="1"; total.max="30"; total.value="10";

      const add = document.createElement("button");
      add.className="btn";
      add.textContent="Ajouter";
      add.onclick = ()=>{
        const n = (name.value||"").trim();
        if(!n) return;
        const t = clamp(parseInt(total.value,10)||10, 1, 30);
        habits.push({ id: uniq(), name:n, total:t, checked:0, createdAt: nowISO() });
        name.value="";
        persist();
        renderDrawer();
      };

      row.appendChild(name);
      row.appendChild(total);
      row.appendChild(add);
      s.appendChild(row);

      const lst = document.createElement("div");
      lst.className="list";
      lst.style.marginTop="10px";

      if(!habits.length){
        const p = document.createElement("p");
        p.className="help";
        p.textContent="Aucune habitude.";
        lst.appendChild(p);
      }else{
        for(const h of habits){
          const r = document.createElement("div");
          r.className="item";

          const left = document.createElement("div");
          left.className="t";
          const nm = document.createElement("div");
          nm.className="name";
          nm.textContent = h.name;
          left.appendChild(nm);

          const boxes = document.createElement("div");
          boxes.style.display="flex";
          boxes.style.gap="6px";
          boxes.style.alignItems="center";
          boxes.style.flexWrap="nowrap";

          for(let i=0;i<h.total;i++){
            const b = document.createElement("div");
            b.className = "tick " + (i < (h.checked||0) ? "on" : "");
            b.style.width="14px";
            b.style.height="8px";
            b.style.cursor="pointer";
            b.title = `${i+1}/${h.total}`;
            b.onclick = ()=>{
              const target = i+1;
              // toggle count logic: clicking same target decreases by 1
              h.checked = (h.checked === target) ? i : target;
              h.checked = clamp(h.checked, 0, h.total);
              persist();
              renderDrawer();
            };
            boxes.appendChild(b);
          }

          const reset = document.createElement("button");
          reset.className="iconBtn";
          reset.textContent="‚Ü∫";
          reset.title="Reset";
          reset.onclick = ()=>{
            h.checked = 0;
            persist();
            renderDrawer();
          };

          const del = document.createElement("button");
          del.className="iconBtn";
          del.textContent="‚úï";
          del.title="Supprimer";
          del.onclick = ()=>{
            habits = habits.filter(x=>x.id!==h.id);
            persist();
            renderDrawer();
          };

          r.appendChild(left);
          r.appendChild(boxes);
          r.appendChild(reset);
          r.appendChild(del);
          lst.appendChild(r);
        }
      }

      s.appendChild(lst);

      const help = document.createElement("p");
      help.className="help";
      help.textContent="Les habitudes apparaissent aussi dans le rapport export.";
      s.appendChild(help);

      wrap.appendChild(s);
      return wrap;
    }

    function buildReportText(){
      const today = dayKey();
      const doneToday = state.done
        .filter(t => (t.doneAt||"").startsWith(today))
        .map(t=>`- ${t.title} (${t.cat||"INBOX"} ¬∑ ${t.ethStart})`).join("\n") || "- (aucune)";

      const remaining = state.tasks
        .map(t=>`- ${t.title} (${t.cat||"INBOX"} ¬∑ ${t.ethLeft}/${t.ethStart})`).join("\n") || "- (aucune)";

      const hab = habits
        .map(h=>`- ${h.name} : ${h.checked}/${h.total}`).join("\n") || "- (aucune)";

      const lastNotes = notes.slice(0,6)
        .map(n=>`- ${new Date(n.at).toLocaleString()} : ${n.text}`).join("\n") || "- (aucune)";

      const base = state.baseline?.totalEth||0;

      return [
        `ELIMINATOR ‚Äî Rapport du ${today}`,
        ``,
        `Fait (aujourd‚Äôhui):`,
        doneToday,
        ``,
        `Reste (actif):`,
        remaining,
        ``,
        `Habitudes:`,
        hab,
        ``,
        `Stats:`,
        `- t√¢ches restantes: ${state.tasks.length}`,
        `- t√¢ches faites (total): ${state.done.length}`,
        `- √©torions restants: ${totalEthLeft()}`,
        `- baseline (session): ${base}`,
        ``,
        `Notes (dernieres):`,
        lastNotes
      ].join("\n");
    }

    function viewStats(){
      const wrap = document.createElement("div");

      const s = section("Export");
      const row = document.createElement("div");
      row.className="row";

      const expReport = document.createElement("button");
      expReport.className="btn";
      expReport.textContent="Exporter rapport (TXT)";
      expReport.onclick = ()=>downloadText(`eliminator_rapport_${dayKey()}.txt`, buildReportText());

      const expJson = document.createElement("button");
      expJson.className="btn";
      expJson.textContent="Exporter (JSON complet)";
      expJson.onclick = ()=>{
        const payload = { settings, state, notes, habits, kiffBank, sets, exportedAt: nowISO() };
        downloadText(`eliminator_export_${dayKey()}.json`, JSON.stringify(payload, null, 2));
      };

      row.appendChild(expReport);
      row.appendChild(expJson);
      s.appendChild(row);

      const pre = document.createElement("textarea");
      pre.rows = 14;
      pre.value = buildReportText();
      pre.style.marginTop = "10px";
      s.appendChild(pre);

      const s2 = section("Baseline (progression globale)");
      const bRow = document.createElement("div");
      bRow.className="row";

      const recal = document.createElement("button");
      recal.className="btn";
      recal.textContent="Recalibrer baseline maintenant";
      recal.onclick = ()=>{
        // set baseline to current total (left+done), to avoid weird decreases
        state.baseline.totalEth = totalEthAllStart();
        state.baseline.setAt = dayKey();
        persist();
        renderAll();
        renderDrawer();
      };

      const note = document.createElement("p");
      note.className="help";
      note.textContent="Si tu ajoutes beaucoup de t√¢ches en cours de route, la baseline peut s‚Äôagrandir automatiquement. Recalibrer = figer la nouvelle baseline proprement.";
      s2.appendChild(recal);
      s2.appendChild(note);

      wrap.appendChild(s);
      wrap.appendChild(s2);
      return wrap;
    }

    function viewSettings(){
      const wrap = document.createElement("div");

      const s = section("Affichage");
      const row = document.createElement("div");
      row.className="row";

      const theme = document.createElement("select");
      theme.innerHTML = `
        <option value="light">Th√®me clair</option>
        <option value="dark">Th√®me sombre</option>
      `;
      theme.value = settings.theme;
      theme.onchange = ()=>{
        settings.theme = theme.value;
        persist();
        renderAll();
        renderDrawer();
      };

      const focus = document.createElement("select");
      focus.innerHTML = `
        <option value="0">Focus: non</option>
        <option value="1">Focus: oui</option>
      `;
      focus.value = String(settings.focus||0);
      focus.onchange = ()=>{
        settings.focus = parseInt(focus.value,10);
        persist();
        renderAll();
      };

      row.appendChild(theme);
      row.appendChild(focus);
      s.appendChild(row);

      const s2 = section("C√©l√©brations (surprise)");
      const row2 = document.createElement("div");
      row2.className="row";

      const fatigue = document.createElement("select");
      fatigue.innerHTML = `
        <option value="0">Fatigue: tr√®s basse</option>
        <option value="1">Fatigue: basse</option>
        <option value="2">Fatigue: moyenne</option>
        <option value="3">Fatigue: haute</option>
        <option value="4">Fatigue: tr√®s haute</option>
      `;
      fatigue.value = String(settings.fatigue||2);
      fatigue.onchange = ()=>{ settings.fatigue = parseInt(fatigue.value,10); persist(); };

      const motiv = document.createElement("select");
      motiv.innerHTML = `
        <option value="0">Motivation: tr√®s basse</option>
        <option value="1">Motivation: basse</option>
        <option value="2">Motivation: moyenne</option>
        <option value="3">Motivation: haute</option>
        <option value="4">Motivation: tr√®s haute</option>
      `;
      motiv.value = String(settings.motivation||2);
      motiv.onchange = ()=>{ settings.motivation = parseInt(motiv.value,10); persist(); };

      row2.appendChild(fatigue);
      row2.appendChild(motiv);

      const row3 = document.createElement("div");
      row3.className="row";
      row3.style.marginTop = "10px";

      const chance = document.createElement("input");
      chance.type="number";
      chance.min="0.05"; chance.max="0.60"; chance.step="0.01";
      chance.value = String(settings.celeChanceBase||0.20);
      chance.onchange = ()=>{ settings.celeChanceBase = clamp(parseFloat(chance.value)||0.20, 0.05, 0.60); persist(); };

      const auto = document.createElement("input");
      auto.type="number";
      auto.min="4"; auto.max="20";
      auto.value = String(settings.celeAutoCloseSec||10);
      auto.onchange = ()=>{ settings.celeAutoCloseSec = clamp(parseInt(auto.value,10)||10, 4, 20); persist(); };

      row3.appendChild(chance);
      row3.appendChild(auto);

      s2.appendChild(row2);
      s2.appendChild(row3);

      const help = document.createElement("p");
      help.className="help";
      help.textContent="Confettis: toujours √† la fin d‚Äôune t√¢che. Message: parfois. Pas d‚Äôeffet ‚Äúmachine √† compliments‚Äù.";
      s2.appendChild(help);

      wrap.appendChild(s);
      wrap.appendChild(s2);
      return wrap;
    }

    // =========================
    // Notes
    // =========================
    function openNotes(){
      notesBack.style.display="block";
      notesModal.style.display="block";
      renderNotes();
    }
    function closeNotes(){
      notesBack.style.display="none";
      notesModal.style.display="none";
    }

    function renderNotes(){
      notesList.innerHTML = "";
      if(!notes.length){
        const p = document.createElement("p");
        p.className="help";
        p.textContent="Aucune note.";
        notesList.appendChild(p);
        return;
      }
      for(const n of notes){
        const row = document.createElement("div");
        row.className="item";

        const left = document.createElement("div");
        left.className="t";
        const nm = document.createElement("div");
        nm.className="name";
        nm.textContent = new Date(n.at).toLocaleString();
        const sb = document.createElement("div");
        sb.className="sub";
        sb.textContent = n.text;

        left.appendChild(nm);
        left.appendChild(sb);

        const del = document.createElement("button");
        del.className="iconBtn";
        del.textContent="‚úï";
        del.title="Supprimer";
        del.onclick = ()=>{
          notes = notes.filter(x=>x.id!==n.id);
          persist();
          renderNotes();
        };

        row.appendChild(left);
        row.appendChild(del);
        notesList.appendChild(row);
      }
    }

    // =========================
    // Celebration (better ‚Äúconquistador absurd‚Äù)
    // =========================
    const CELE_POOL = [
      {t:"Gloire administrative", m:"Tu viens de terrasser un monstre bureaucratique sans lever la voix. L‚Äô√©l√©gance d‚Äôun duel au ralenti."},
      {t:"Conqu√™te", m:"La t√¢che a capitul√©. Tu n‚Äôas pas cri√©. Tu as simplement avanc√©. Terrifiant."},
      {t:"Triomphe", m:"Tu viens d‚Äôinscrire ton nom dans les archives sacr√©es du ¬´ je fais ce que j‚Äôai dit ¬ª."},
      {t:"Supr√©matie calme", m:"Le chaos a tent√© un regard appuy√©. Tu l‚Äôas ignor√©. Il a compris."},
      {t:"Victoire tactique", m:"Un √©torion de moins. L‚Äôunivers a √©t√© l√©g√®rement r√©organis√©. √Ä ton avantage."},
      {t:"√âpop√©e", m:"Un pas de plus dans ta saga. Les statues ne sont pas pr√™tes, mais elles prennent rendez-vous."},
      {t:"Domination", m:"La procrastination a recul√© de trois m√®tres. Elle reviendra. Elle a tort."},
      {t:"R√®gne int√©rieur", m:"Tu as repris du territoire mental. Fronti√®re s√©curis√©e. Drapeau plant√©."},
      {t:"M√©canique divine", m:"Tu avances par fragments, comme une horloge de guerre. Efficace. In√©luctable."},
      {t:"L√©gende locale", m:"Les gens vont dire: ¬´ cette personne‚Ä¶ elle d√©gomme. ¬ª Et ils auront raison."}
    ];

    function celebrationProbability(){
      const f = clamp(settings.fatigue,0,4);
      const m = clamp(settings.motivation,0,4);
      let p = clamp(settings.celeChanceBase||0.20, 0.05, 0.60);
      p += (f-2)*0.04;
      p -= (m-2)*0.03;

      // throttle: avoid too frequent
      const streak = state.streak.completedSinceCele||0;
      if(streak < 2) p *= 0.35;
      if(streak >= 3) p *= 1.15;

      return clamp(p, 0.02, 0.60);
    }

    let celeTimer = null;
    function maybeCelebrate(){
      const p = celebrationProbability();
      if(Math.random() > p) return;
      state.streak.completedSinceCele = 0;
      showCelebration();
    }

    function showCelebration(){
      const pick = CELE_POOL[rand(CELE_POOL.length)];
      celeTitle.textContent = pick.t;
      celeMsg.textContent = pick.m;

      celeBack.style.display="block";
      celeModal.style.display="block";

      const sec = clamp(parseInt(settings.celeAutoCloseSec,10)||10, 4, 20);
      if(celeTimer) clearTimeout(celeTimer);
      celeTimer = setTimeout(closeCelebration, sec*1000);
    }

    function closeCelebration(){
      celeBack.style.display="none";
      celeModal.style.display="none";
      if(celeTimer) clearTimeout(celeTimer);
      celeTimer = null;
    }

    // =========================
    // Confetti (monochrome)
    // =========================
    function burstConfetti(){
      confettiCanvas.width = window.innerWidth;
      confettiCanvas.height = window.innerHeight;
      confettiCanvas.style.display="block";

      const w = confettiCanvas.width, h = confettiCanvas.height;
      const fg = getComputedStyle(document.body).getPropertyValue("--fg").trim() || "#fff";

      const parts = [];
      const n = 140;
      for(let i=0;i<n;i++){
        parts.push({
          x: w/2 + (Math.random()-0.5)*220,
          y: h*0.28 + (Math.random()-0.5)*80,
          vx: (Math.random()-0.5)*7,
          vy: -Math.random()*7 - 2,
          g: 0.18 + Math.random()*0.12,
          r: 2 + Math.random()*3,
          a: 0.55 + Math.random()*0.35
        });
      }

      const start = performance.now();
      function anim(t){
        const dt = (t-start)/1000;
        ctx.clearRect(0,0,w,h);
        for(const p of parts){
          p.vy += p.g;
          p.x += p.vx;
          p.y += p.vy;
          p.a *= 0.996;
          ctx.globalAlpha = p.a;
          ctx.beginPath();
          ctx.arc(p.x,p.y,p.r,0,Math.PI*2);
          ctx.fillStyle = fg;
          ctx.fill();
        }
        ctx.globalAlpha = 1;
        if(dt < 1.9) requestAnimationFrame(anim);
        else confettiCanvas.style.display="none";
      }
      requestAnimationFrame(anim);
    }

    window.addEventListener("resize", ()=>{
      confettiCanvas.width = window.innerWidth;
      confettiCanvas.height = window.innerHeight;
    });

    // =========================
    // Sets panel (right) ‚Äî independent checklist
    // =========================
    function generateSets(type, n){
      const items = [];
      const N = clamp(parseInt(n,10)||4, 1, 20);

      if(type==="hospital"){
        for(let i=1;i<=N;i++){
          const p = `Patient ${i}`;
          items.push({id:uniq(), label:`${p} ‚Äî voir`, sub:"", done:false});
          items.push({id:uniq(), label:`${p} ‚Äî note`, sub:"", done:false});
          items.push({id:uniq(), label:`${p} ‚Äî traitement`, sub:"", done:false});
          items.push({id:uniq(), label:`${p} ‚Äî dossier`, sub:"", done:false});
        }
      }else{
        for(let i=1;i<=N;i++){
          const p = `Consult ${i}`;
          items.push({id:uniq(), label:`${p} ‚Äî accueil`, sub:"", done:false});
          items.push({id:uniq(), label:`${p} ‚Äî clinique`, sub:"", done:false});
          items.push({id:uniq(), label:`${p} ‚Äî plan`, sub:"", done:false});
          items.push({id:uniq(), label:`${p} ‚Äî note`, sub:"", done:false});
        }
      }
      return items;
    }

    function renderSetsPanel(){
      setsType.value = sets.type || "hospital";
      setsN.value = String(sets.n || 4);

      setsChecklist.innerHTML = "";
      if(!sets.items || !sets.items.length){
        const p = document.createElement("p");
        p.className="help";
        p.textContent="Aucune checklist. G√©n√®re un set.";
        setsChecklist.appendChild(p);
        return;
      }

      for(const it of sets.items){
        const row = document.createElement("div");
        row.className="chkRow";

        const left = document.createElement("div");
        left.className="chkLeft";

        const nm = document.createElement("div");
        nm.className="chkName";
        nm.textContent = it.label;

        left.appendChild(nm);

        const c = document.createElement("div");
        c.className = "check " + (it.done ? "on" : "");
        c.textContent = it.done ? "‚úì" : "";
        c.onclick = ()=>{
          it.done = !it.done;
          persist();
          renderSetsPanel();
        };

        row.appendChild(left);
        row.appendChild(c);
        setsChecklist.appendChild(row);
      }
    }

    // =========================
    // Events wiring
    // =========================
    btnMenu.onclick = openDrawer;
    btnCloseDrawer.onclick = closeDrawer;
    drawerBack.onclick = closeDrawer;

    btnTheme.onclick = ()=>{
      settings.theme = (settings.theme==="light") ? "dark" : "light";
      persist();
      renderAll();
      renderDrawer();
    };

    btnFocus.onclick = ()=>{
      settings.focus = settings.focus ? 0 : 1;
      persist();
      renderAll();
    };

    btnToggleList.onclick = ()=>{
      settings.listVisible = settings.listVisible ? 0 : 1;
      persist();
      renderAll();
    };
    btnHideList.onclick = ()=>{
      settings.listVisible = 0;
      persist();
      renderAll();
    };

    btnSets.onclick = ()=>{
      settings.setsVisible = settings.setsVisible ? 0 : 1;
      persist();
      renderAll();
    };
    btnCloseSets.onclick = ()=>{
      settings.setsVisible = 0;
      persist();
      renderAll();
    };

    btnGenSets.onclick = ()=>{
      sets.type = setsType.value;
      sets.n = clamp(parseInt(setsN.value,10)||4, 1, 20);
      sets.items = generateSets(sets.type, sets.n);
      persist();
      renderSetsPanel();
    };

    btnRoulette.onclick = ()=>{
      const picked = pickRoulette();
      if(!picked) return;
      btnRoulette.classList.remove("spin");
      void btnRoulette.offsetWidth;
      btnRoulette.classList.add("spin");
      setCurrent(picked.id);
    };

    btnDegomme.onclick = degommeOneEth;

    btnNotes.onclick = openNotes;
    btnCloseNotes.onclick = closeNotes;
    notesBack.onclick = closeNotes;

    btnAddNote.onclick = ()=>{
      const txt = (noteInput.value||"").trim();
      if(!txt) return;
      notes.unshift({ id: uniq(), at: nowISO(), text: txt });
      noteInput.value = "";
      persist();
      renderNotes();
    };
    btnClearNotes.onclick = ()=>{
      if(confirm("Vider toutes les notes ?")){
        notes = [];
        persist();
        renderNotes();
      }
    };

    btnPin.onclick = pinToggle;
    btnDown.onclick = pushDownCurrent;
    btnDel.onclick = ()=>{ const t=currentTask(); if(t) deleteTask(t.id); };
    btnDone.onclick = ()=>{ const t=currentTask(); if(t) markDone(t.id); };

    btnEdit.onclick = ()=>{
      const t = currentTask();
      if(!t) return;
      const nt = prompt("Nouveau titre", t.title);
      if(nt!==null) editTaskTitle(t.id, nt);
    };

    btnCloseCele.onclick = closeCelebration;
    celeBack.onclick = closeCelebration;

    btnReset.onclick = ()=>{
      // reset tasks + done + baseline + timer (notes/habits/kiff/sets remain)
      state.tasks = [];
      state.done = [];
      state.currentId = null;
      state.baseline = { setAt: dayKey(), totalEth: 0 };
      state.timer = { taskId:null, elapsedMs:0, running:false, lastTick:0 };
      state.streak = { completedSinceCele: 0 };

      persist();
      renderAll();
      if(drawer.classList.contains("open")) renderDrawer();
    };

    // =========================
    // Timer loop (reliable)
    // =========================
    setInterval(()=>{
      tickTimer();
      renderHUD(); // cheap
      persist();   // keeps timer stable even on reload
    }, 1000);

    // =========================
    // Boot
    // =========================
    function boot(){
      // sanitize theme
      if(settings.theme!=="light" && settings.theme!=="dark") settings.theme="light";

      renderTabs();
      renderAll();
      renderDrawer();
    }

    boot();
  </script>
</body>
</html>
