<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>ELIMINATOR</title>
  <style>
    :root{
      --bg:#f6f7fb;
      --fg:#0c1220;
      --muted:#5b6477;
      --line:#d8ddea;
      --panel: rgba(255,255,255,.72);
      --panel2: rgba(255,255,255,.56);
      --shadow: 0 12px 35px rgba(14, 22, 44, .12);
      --accent:#2a67ff;          /* bleu (clair) */
      --accent2:#1fd18a;         /* vert (sombre) */
      --good:#18a558;
      --warn:#ffb020;
      --bad:#ff3b5c;
      --glass: blur(14px);
      --radius: 18px;
      --radius2: 26px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
    }

    [data-theme="dark"]{
      --bg:#0d1017;
      --fg:#e9edf5;
      --muted:#a8b0bd;
      --line:#2a2f3a;
      --panel: rgba(20,24,35,.72);
      --panel2: rgba(16,20,33,.60);
      --shadow: 0 14px 50px rgba(0,0,0,.45);
      --accent:#1fd18a;          /* vert (sombre) */
      --accent2:#2a67ff;         /* bleu (clair) */
      --good:#2ae08e;
      --warn:#ffb020;
      --bad:#ff4d6d;
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:var(--sans);
      background:
        radial-gradient(1200px 800px at 10% -10%, rgba(42,103,255,.14), transparent 55%),
        radial-gradient(1000px 700px at 90% 0%, rgba(31,209,138,.12), transparent 55%),
        radial-gradient(900px 900px at 40% 110%, rgba(255,176,32,.10), transparent 55%),
        var(--bg);
      color:var(--fg);
      overflow-x:hidden;
    }

    .wrap{
      max-width:900px;
      margin:0 auto;
      padding:18px 14px 38px;
    }

    /* Header top controls */
    .topbar{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:12px;
      margin-bottom:10px;
    }

    .leftControls, .rightControls{
      display:flex;
      align-items:center;
      gap:10px;
      flex-wrap:wrap;
    }

    .btn{
      border:1px solid var(--line);
      background:var(--panel);
      backdrop-filter: var(--glass);
      -webkit-backdrop-filter: var(--glass);
      color:var(--fg);
      border-radius:999px;
      padding:10px 12px;
      font-weight:650;
      cursor:pointer;
      box-shadow: 0 6px 18px rgba(0,0,0,.06);
      transition: transform .08s ease, border-color .2s ease, background .2s ease;
      user-select:none;
      display:inline-flex;
      align-items:center;
      gap:8px;
    }
    .btn:active{ transform: translateY(1px) scale(.99); }
    .btn.ghost{ background:transparent; box-shadow:none; }
    .btn.small{ padding:8px 10px; font-weight:650; }
    .btn.primary{
      border-color: color-mix(in oklab, var(--accent) 55%, var(--line));
      background: color-mix(in oklab, var(--accent) 12%, var(--panel));
    }
    .btn.danger{
      border-color: color-mix(in oklab, var(--bad) 55%, var(--line));
      background: color-mix(in oklab, var(--bad) 10%, var(--panel));
    }

    .pill{
      border:1px solid var(--line);
      background:var(--panel2);
      backdrop-filter: var(--glass);
      -webkit-backdrop-filter: var(--glass);
      border-radius:999px;
      padding:8px 10px;
      font-family:var(--mono);
      font-size:12px;
      color:var(--muted);
      display:inline-flex;
      gap:10px;
      align-items:center;
      box-shadow: 0 6px 20px rgba(0,0,0,.05);
    }
    .pill b{ color:var(--fg); font-weight:800; }

    .switch{
      display:inline-flex;
      border:1px solid var(--line);
      border-radius:999px;
      overflow:hidden;
      background:var(--panel);
      backdrop-filter: var(--glass);
      -webkit-backdrop-filter: var(--glass);
      box-shadow: 0 6px 18px rgba(0,0,0,.06);
    }
    .switch button{
      border:0;
      padding:9px 12px;
      cursor:pointer;
      background:transparent;
      color:var(--muted);
      font-weight:800;
    }
    .switch button.active{
      color:var(--fg);
      background: color-mix(in oklab, var(--accent) 16%, transparent);
    }
    [data-theme="dark"] .switch button.active{
      background: color-mix(in oklab, var(--accent) 14%, transparent);
    }

    /* Title block */
    .titleBlock{
      margin:8px 0 14px;
      display:flex;
      flex-direction:column;
      align-items:center;
      gap:6px;
      text-align:center;
    }
    .title{
      font-size: clamp(44px, 6.2vw, 78px); /* tr√®s grand */
      letter-spacing: .5px;
      font-weight: 950;
      line-height: .98;
      margin:0;
      text-shadow: 0 10px 30px rgba(0,0,0,.10);
    }
    .subtitle{
      margin:0;
      font-weight:850;
      color:var(--muted);
      letter-spacing:.2px;
    }

    /* Main panel */
    .panel{
      border:1px solid var(--line);
      background:var(--panel);
      backdrop-filter: var(--glass);
      -webkit-backdrop-filter: var(--glass);
      border-radius: var(--radius2);
      box-shadow: var(--shadow);
      padding:16px;
      overflow:hidden;
      position:relative;
    }

    /* Big progress bar */
    .bigBarBox{
      border:1px solid var(--line);
      border-radius: 22px;
      padding:14px;
      background: color-mix(in oklab, var(--panel) 72%, transparent);
      box-shadow: inset 0 1px 0 rgba(255,255,255,.25);
    }

    .bigBarTrack{
      height: 42px; /* √©pais */
      border-radius: 20px;
      background: color-mix(in oklab, var(--line) 40%, transparent);
      border: 1px solid color-mix(in oklab, var(--line) 75%, transparent);
      overflow:hidden;
      position:relative;
    }
    .bigBarFill{
      height:100%;
      width:100%;
      background: linear-gradient(90deg,
        color-mix(in oklab, var(--accent) 85%, white 0%),
        color-mix(in oklab, var(--accent) 55%, var(--accent2) 25%)
      );
      border-radius:20px;
      transform-origin:left center;
      transform: scaleX(1);
      transition: transform .18s ease;
    }
    .bigBarPct{
      position:absolute;
      inset:0;
      display:flex;
      align-items:center;
      justify-content:center;
      font-weight:950;
      font-family:var(--mono);
      letter-spacing:.5px;
      color: rgba(255,255,255,.96);
      text-shadow: 0 6px 18px rgba(0,0,0,.35);
      mix-blend-mode: normal;
      pointer-events:none;
    }
    [data-theme="light"] .bigBarPct{
      color: rgba(255,255,255,.95);
    }

    .taskName{
      margin:14px 2px 10px;
      font-size: clamp(18px, 3vw, 26px);
      font-weight: 920;
      letter-spacing:.2px;
      text-align:center;
    }
    .taskMetaRow{
      display:flex;
      align-items:center;
      justify-content:center;
      gap:10px;
      flex-wrap:wrap;
      margin-bottom:8px;
      color:var(--muted);
      font-family:var(--mono);
      font-size:12px;
    }
    .taskMetaRow .badge{
      border:1px solid var(--line);
      background:var(--panel2);
      border-radius:999px;
      padding:6px 10px;
    }

    /* Etherions bar */
    .ethBox{
      margin-top:10px;
      padding:12px 12px 10px;
      border:1px dashed color-mix(in oklab, var(--line) 85%, transparent);
      border-radius: 18px;
      background: color-mix(in oklab, var(--panel2) 70%, transparent);
    }
    .ethTop{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:8px;
      flex-wrap:wrap;
      margin-bottom:8px;
    }
    .ethLabel{
      font-family:var(--mono);
      font-size:12px;
      color:var(--muted);
    }
    .ethLabel b{ color:var(--fg); }
    .ethTrack{
      height:14px;
      border-radius:999px;
      background: color-mix(in oklab, var(--line) 45%, transparent);
      border:1px solid color-mix(in oklab, var(--line) 70%, transparent);
      overflow:hidden;
      position:relative;
    }
    .ethFill{
      height:100%;
      width:100%;
      background: linear-gradient(90deg,
        color-mix(in oklab, var(--accent) 45%, transparent),
        color-mix(in oklab, var(--accent) 25%, var(--accent2) 35%)
      );
      transform-origin:left center;
      transform: scaleX(1);
      transition: transform .18s ease;
    }
    .ethTicks{
      position:absolute;
      inset:0;
      display:flex;
      gap:0;
      opacity:.75;
      pointer-events:none;
    }
    .ethTicks span{
      flex:1;
      border-right:1px dashed rgba(255,255,255,.30);
    }
    [data-theme="light"] .ethTicks span{
      border-right:1px dashed rgba(0,0,0,.12);
    }

    /* Main actions row */
    .actions{
      display:flex;
      justify-content:center;
      align-items:center;
      gap:10px;
      flex-wrap:wrap;
      margin-top:12px;
    }

    .rouletteBtn{
      width:56px;
      height:56px;
      border-radius: 18px;
      border:1px solid var(--line);
      background: var(--panel);
      backdrop-filter: var(--glass);
      -webkit-backdrop-filter: var(--glass);
      box-shadow: 0 10px 26px rgba(0,0,0,.10);
      cursor:pointer;
      display:grid;
      place-items:center;
      position:relative;
      overflow:hidden;
    }
    .rouletteWheel{
      width:34px;
      height:34px;
      border-radius:999px;
      border:2px solid color-mix(in oklab, var(--accent) 65%, var(--line));
      background:
        conic-gradient(
          from 0deg,
          color-mix(in oklab, var(--accent) 70%, transparent),
          color-mix(in oklab, var(--accent2) 55%, transparent),
          color-mix(in oklab, var(--warn) 55%, transparent),
          color-mix(in oklab, var(--accent) 70%, transparent)
        );
      box-shadow: inset 0 0 0 2px rgba(255,255,255,.18);
      transform: rotate(0deg);
    }
    .rouletteBtn.spinning .rouletteWheel{
      animation: spin 900ms cubic-bezier(.2,.8,.2,1);
    }
    @keyframes spin{
      0%{ transform: rotate(0deg); }
      100%{ transform: rotate(1080deg); }
    }

    .bigAction{
      border:1px solid color-mix(in oklab, var(--accent) 55%, var(--line));
      background: linear-gradient(180deg,
        color-mix(in oklab, var(--accent) 16%, var(--panel)),
        color-mix(in oklab, var(--accent) 10%, var(--panel))
      );
      padding:14px 16px;
      border-radius: 18px;
      font-size:16px;
      font-weight:950;
      cursor:pointer;
      box-shadow: 0 12px 30px rgba(0,0,0,.12);
      display:inline-flex;
      align-items:center;
      gap:10px;
      user-select:none;
    }
    .bigAction:active{ transform: translateY(1px); }

    .miniActions{
      display:flex;
      gap:10px;
      justify-content:center;
      flex-wrap:wrap;
      margin-top:12px;
    }

    /* Tiny icon buttons under task (pin/up/down/edit/delete) */
    .iconRow{
      display:flex;
      justify-content:center;
      align-items:center;
      gap:8px;
      flex-wrap:wrap;
      margin-top:6px;
    }
    .iconBtn{
      border:1px solid var(--line);
      background: var(--panel2);
      border-radius: 14px;
      padding:10px 12px;
      cursor:pointer;
      font-weight:900;
      color:var(--fg);
      display:inline-flex;
      align-items:center;
      gap:8px;
      box-shadow: 0 8px 22px rgba(0,0,0,.06);
      user-select:none;
    }
    .iconBtn small{ color:var(--muted); font-weight:800; }

    /* Overlay menu */
    .overlay{
      position:fixed;
      inset:0;
      background: rgba(0,0,0,.18);
      display:none;
      align-items:flex-end;
      justify-content:center;
      z-index:50;
      padding:14px;
    }
    [data-theme="dark"] .overlay{ background: rgba(0,0,0,.42); }
    .overlay.show{ display:flex; }

    .sheet{
      width:min(900px, 100%);
      max-height: 86vh;
      overflow:hidden;
      border:1px solid var(--line);
      background: var(--panel);
      backdrop-filter: var(--glass);
      -webkit-backdrop-filter: var(--glass);
      border-radius: 26px;
      box-shadow: var(--shadow);
      display:flex;
      flex-direction:column;
    }
    .sheetTop{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding:12px 12px 10px;
      border-bottom:1px solid var(--line);
    }
    .tabs{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
    }
    .tab{
      border:1px solid var(--line);
      background: var(--panel2);
      border-radius:999px;
      padding:8px 10px;
      cursor:pointer;
      font-weight:900;
      color:var(--muted);
      user-select:none;
    }
    .tab.active{
      color:var(--fg);
      border-color: color-mix(in oklab, var(--accent) 55%, var(--line));
      background: color-mix(in oklab, var(--accent) 12%, var(--panel2));
    }
    .sheetBody{
      overflow:auto;
      padding:12px;
    }

    .card{
      border:1px solid var(--line);
      background: var(--panel2);
      border-radius: 18px;
      padding:12px;
      margin-bottom:10px;
      box-shadow: 0 8px 22px rgba(0,0,0,.06);
    }
    .cardTitle{
      font-weight:950;
      margin:0 0 8px;
    }

    textarea, input, select{
      width:100%;
      border:1px solid var(--line);
      background: color-mix(in oklab, var(--panel) 75%, transparent);
      border-radius: 14px;
      padding:10px 12px;
      color:var(--fg);
      outline:none;
      font-family: var(--sans);
    }
    textarea{ min-height: 120px; resize: vertical; }

    .row{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
    }
    .row > *{ flex:1; min-width: 160px; }
    .row.tight > *{ min-width: 120px; }
    .help{
      color:var(--muted);
      font-size:12px;
      line-height:1.35;
    }

    /* Task list */
    .taskItem{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding:10px 10px;
      border:1px solid var(--line);
      background: color-mix(in oklab, var(--panel) 65%, transparent);
      border-radius: 16px;
      margin-bottom:8px;
    }
    .taskItem .name{
      font-weight:900;
      line-height:1.2;
    }
    .taskItem .sub{
      color:var(--muted);
      font-family:var(--mono);
      font-size:12px;
      margin-top:3px;
    }
    .taskItem .actions{
      margin:0;
      justify-content:flex-end;
      gap:8px;
    }
    .taskItem .actions .btn{
      padding:8px 10px;
      border-radius: 14px;
      box-shadow:none;
      background: var(--panel2);
    }

    /* Notes: post-it vibe */
    .noteGrid{
      display:grid;
      grid-template-columns: repeat( auto-fit, minmax(220px, 1fr) );
      gap:10px;
    }
    .note{
      border:1px solid var(--line);
      background:
        linear-gradient(180deg,
          color-mix(in oklab, var(--warn) 16%, var(--panel)),
          color-mix(in oklab, var(--warn) 8%, var(--panel2))
        );
      border-radius:18px;
      padding:12px;
      box-shadow: 0 10px 24px rgba(0,0,0,.10);
    }
    [data-theme="dark"] .note{
      background:
        linear-gradient(180deg,
          color-mix(in oklab, var(--warn) 14%, var(--panel)),
          color-mix(in oklab, var(--warn) 6%, var(--panel2))
        );
    }
    .note .stamp{
      font-family:var(--mono);
      font-size:11px;
      color:var(--muted);
      margin-bottom:6px;
    }
    .note .txt{
      white-space:pre-wrap;
      font-weight:750;
    }

    /* Celebration banner */
    .celebrate{
      position:fixed;
      left:50%;
      top:14px;
      transform:translateX(-50%) translateY(-20px);
      opacity:0;
      pointer-events:none;
      z-index:80;
      border:1px solid color-mix(in oklab, var(--accent) 55%, var(--line));
      background: color-mix(in oklab, var(--accent) 16%, var(--panel));
      backdrop-filter: var(--glass);
      -webkit-backdrop-filter: var(--glass);
      border-radius: 999px;
      padding:10px 14px;
      box-shadow: 0 14px 40px rgba(0,0,0,.16);
      font-weight:950;
      letter-spacing:.2px;
      display:flex;
      gap:10px;
      align-items:center;
      transition: opacity .25s ease, transform .25s ease;
    }
    .celebrate.show{
      opacity:1;
      transform:translateX(-50%) translateY(0);
    }
    .celebrate .small{
      font-family:var(--mono);
      font-weight:850;
      color:var(--muted);
      font-size:12px;
    }

    /* Confetti canvas */
    #confetti{
      position:fixed;
      inset:0;
      pointer-events:none;
      z-index:70;
    }

    /* Focus mode: ultra √©pur√© */
    [data-focus="1"] .titleBlock{ margin-bottom:10px; }
    [data-focus="1"] .topbar .pill{ display:none; }
    [data-focus="1"] .topbar .rightControls .btn:not(.keep){ display:none; }
    [data-focus="1"] .miniActions{ display:none; }
    [data-focus="1"] .taskMetaRow{ display:none; }
    [data-focus="1"] .iconRow .iconBtn small{ display:none; }
    [data-focus="1"] .sheetTop .tabs{ display:flex; } /* menu reste ok */

    /* Pure mode: encore plus minimal (optionnel) */
    [data-pure="1"] .iconRow{ display:none; }
    [data-pure="1"] .ethBox{ display:none; }
    [data-pure="1"] .taskMetaRow{ display:none; }
    [data-pure="1"] .miniActions{ display:none; }

    /* small screens */
    @media (max-width: 460px){
      .btn{ padding:9px 10px; }
      .bigAction{ width:100%; justify-content:center; }
      .rouletteBtn{ width:52px; height:52px; border-radius:16px; }
      .bigBarTrack{ height:40px; }
      .wrap{ padding:14px 12px 34px; }
    }
  </style>
</head>

<body data-theme="light" data-focus="0" data-pure="0">
  <canvas id="confetti"></canvas>

  <div class="celebrate" id="celebrate">
    <span id="celebrateMain">GLORIEUX TRIOMPHE</span>
    <span class="small" id="celebrateSub">+1 √©torion √©limin√©</span>
  </div>

  <div class="wrap">
    <div class="topbar">
      <div class="leftControls">
        <button class="btn keep" id="btnMenu">‚ò∞ Menu</button>
        <button class="btn keep" id="btnReset">‚ü≤ Reset</button>
        <button class="btn keep" id="btnFocus">‚¶ø Focus</button>
      </div>

      <div class="rightControls">
        <div class="pill" id="hud">
          <span>T√¢ches: <b id="hudTasks">0/0</b></span>
          <span>√âthorions: <b id="hudEth">0/0</b></span>
          <span>Faits: <b id="hudDone">0</b></span>
          <span>‚è± <b id="hudTimer">00:00</b></span>
        </div>

        <div class="switch" title="Th√®me">
          <button id="themeLight" class="active">Clair</button>
          <button id="themeDark">Sombre</button>
        </div>
      </div>
    </div>

    <div class="titleBlock">
      <h1 class="title">ELIMINATOR</h1>
      <p class="subtitle">D√©gomme toutes les t√¢ches, tous les √©thorions en cours</p>
    </div>

    <div class="panel" id="mainPanel">
      <div class="bigBarBox">
        <div class="bigBarTrack" aria-label="Progression de la t√¢che">
          <div class="bigBarFill" id="bigFill"></div>
          <div class="bigBarPct" id="bigPct">100%</div>
        </div>
      </div>

      <div class="taskName" id="taskName">Aucune t√¢che (ouvre Menu ‚Üí Inbox / Liste)</div>

      <div class="taskMetaRow" id="taskMetaRow">
        <span class="badge" id="metaEst">Estim√©: 0 min</span>
        <span class="badge" id="metaCat">Cat√©gorie: ‚Äî</span>
      </div>

      <div class="iconRow" id="iconRow">
        <button class="iconBtn" id="btnPin">üìå <small id="pinState">non</small></button>
        <button class="iconBtn" id="btnUp">‚¨ÜÔ∏è <small>prioriser</small></button>
        <button class="iconBtn" id="btnDown">‚¨áÔ∏è <small>d√©prioriser</small></button>
        <button class="iconBtn" id="btnEdit">‚úèÔ∏è <small>√©diter</small></button>
        <button class="iconBtn" id="btnDelete">üóëÔ∏è <small>supprimer</small></button>
      </div>

      <div class="ethBox" id="ethBox">
        <div class="ethTop">
          <div class="ethLabel">√âthorions: <b id="ethNow">0</b>/<b id="ethStart">0</b> ‚Ä¢ Temps estim√©: <b id="ethMinutes">0</b> min</div>
          <div class="ethLabel">Fragment: <b>1 √©thorion</b> = <b id="ethSizeLabel">5</b> min</div>
        </div>
        <div class="ethTrack">
          <div class="ethFill" id="ethFill"></div>
          <div class="ethTicks" id="ethTicks"></div>
        </div>
      </div>

      <div class="actions">
        <button class="rouletteBtn" id="btnRoulette" title="Roulette (choisir une autre t√¢che)">
          <div class="rouletteWheel" id="rouletteWheel"></div>
        </button>

        <button class="bigAction" id="btnSmash">
          üß® D√©gommer 1 √©thorion
        </button>
      </div>

      <div class="miniActions" id="miniActions">
        <button class="btn small" id="btnNoteQuick">üóí Note</button>
        <button class="btn small ghost" id="btnPure">‚ü° Pur</button>
      </div>
    </div>
  </div>

  <!-- Overlay Menu -->
  <div class="overlay" id="overlay">
    <div class="sheet">
      <div class="sheetTop">
        <div class="tabs">
          <div class="tab active" data-tab="inbox">Inbox</div>
          <div class="tab" data-tab="list">Liste</div>
          <div class="tab" data-tab="notes">Notes</div>
          <div class="tab" data-tab="profile">Profil & Stats</div>
        </div>
        <button class="btn" id="btnClose">‚úï Fermer</button>
      </div>

      <div class="sheetBody">
        <!-- Inbox -->
        <div class="tabPanel" id="tab-inbox">
          <div class="card">
            <p class="cardTitle">Importer / coller des t√¢ches</p>
            <textarea id="inboxText" placeholder="Colle n‚Äôimporte quel format.
Exemples support√©s :
- Appeler Hugo
‚Ä¢ Cat√©gorie: Qui fonce | √âthorions: 4 | Appeler Hugo
[Qui fonce] (eth=3) Appeler Samira
Appeler Myriam P ; cat=admin ; eth=2
"></textarea>
            <div class="row tight" style="margin-top:10px;">
              <select id="defaultCategory">
                <option value="">Cat√©gorie par d√©faut (optionnel)</option>
              </select>
              <input id="defaultEth" type="number" min="1" placeholder="√âthorions par d√©faut (ex: 3)" />
            </div>
            <div class="row" style="margin-top:10px;">
              <button class="btn primary" id="btnImport">+ Importer</button>
              <button class="btn" id="btnClearInbox">Vider</button>
            </div>
            <div class="help" style="margin-top:8px;">
              - Si une ligne contient ¬´ qui fonce ¬ª (ou [qui fonce]), elle part direct dans cette cat√©gorie.<br>
              - Si tu ne mets pas d‚Äô√©thorions, on prend la valeur par d√©faut (ou 1).<br>
              - Les notes (onglet Notes) survivent √† tous les reset (oui, comme des cafards).
            </div>
          </div>
        </div>

        <!-- List -->
        <div class="tabPanel" id="tab-list" style="display:none;">
          <div class="card">
            <p class="cardTitle">Filtre des cat√©gories actives</p>
            <div class="help">Choisis quelles cat√©gories sont ‚Äúactives‚Äù pour la roulette / la s√©lection.</div>
            <div id="catFilters" style="margin-top:10px; display:flex; gap:8px; flex-wrap:wrap;"></div>
            <div class="row tight" style="margin-top:10px;">
              <select id="sortMode">
                <option value="roulette">Mode: Roulette (al√©atoire)</option>
                <option value="order">Mode: Dans l'ordre (liste)</option>
                <option value="alpha">Mode: Alphab√©tique</option>
                <option value="chrono">Mode: Chronologique (cr√©ation)</option>
              </select>
              <button class="btn" id="btnApplySort">Appliquer</button>
            </div>
          </div>

          <div class="card">
            <p class="cardTitle">T√¢ches</p>
            <div id="taskList"></div>
          </div>
        </div>

        <!-- Notes -->
        <div class="tabPanel" id="tab-notes" style="display:none;">
          <div class="card">
            <p class="cardTitle">Ajouter une note (persistante)</p>
            <textarea id="noteText" placeholder="Une pens√©e, un rappel, un √©clair de g√©nie ou un cri existentiel‚Ä¶"></textarea>
            <div class="row" style="margin-top:10px;">
              <button class="btn primary" id="btnAddNote">+ Ajouter</button>
              <button class="btn danger" id="btnClearNotes">Effacer toutes les notes</button>
            </div>
            <div class="help" style="margin-top:8px;">
              Les notes sont sauvegard√©es et ne disparaissent pas quand tu reset les t√¢ches.
            </div>
          </div>

          <div class="card">
            <p class="cardTitle">Notes sauvegard√©es</p>
            <div class="noteGrid" id="notesGrid"></div>
          </div>
        </div>

        <!-- Profile & Stats -->
        <div class="tabPanel" id="tab-profile" style="display:none;">
          <div class="card">
            <p class="cardTitle">Affichage</p>
            <div class="row tight">
              <button class="btn" id="btnToggleFocusFromMenu">Basculer Focus</button>
              <button class="btn" id="btnTogglePureFromMenu">Basculer Pur</button>
              <select id="ethMinutesPer">
                <option value="5">1 √©thorion = 5 min</option>
                <option value="10">1 √©thorion = 10 min</option>
                <option value="15">1 √©thorion = 15 min</option>
              </select>
            </div>
            <div class="help" style="margin-top:8px;">
              Focus = masque le bruit. Pur = encore plus minimal (barre only, style ‚Äúlaser‚Äù).
            </div>
          </div>

          <div class="card">
            <p class="cardTitle">Stats & Historique quotidien</p>
            <div id="statsBox" class="help" style="font-family:var(--mono); font-size:12px; white-space:pre-wrap;"></div>
            <div class="row" style="margin-top:10px;">
              <button class="btn" id="btnExport">Exporter JSON</button>
              <button class="btn danger" id="btnNuke">Tout effacer (t√¢ches + stats) ‚Äî SAUF notes</button>
            </div>
            <div class="help" style="margin-top:8px;">
              ‚ÄúTout effacer‚Äù garde les notes (oui, encore).
            </div>
          </div>
        </div>

      </div>
    </div>
  </div>

<script>
(() => {
  /***********************
   * Storage keys
   ***********************/
  const K = {
    state: "ELIMINATOR_STATE_V2",
    notes: "ELIMINATOR_NOTES_V2",
    history: "ELIMINATOR_HISTORY_V2",
    settings: "ELIMINATOR_SETTINGS_V2"
  };

  /***********************
   * Defaults
   ***********************/
  const DEFAULTS = {
    theme: "light",        // clair par d√©faut ‚úÖ
    focus: 0,
    pure: 0,
    ethMinutesPer: 5,
    sortMode: "roulette",
    activeCats: null       // null => toutes actives
  };

  const CELEB = [
    "GLORIEUX TRIOMPHE",
    "CONQU√äTE ABSOLUE",
    "VICTOIRE COSMIQUE",
    "D√âMOLITION IMP√âRIALE",
    "√âCLAT DIVIN (SANS PREUVE)",
    "R√àGNE DE LA PRODUCTIVIT√â",
    "TU ES UN CATACLYSME ORGANIS√â",
    "LA LISTE TREMBLE",
    "L‚ÄôUNIVERS APPLAUDIT (PEUT-√äTRE)",
    "C‚ÄôEST ILL√âGAL D‚Äô√äTRE SI EFFICACE",
    "HONNEUR, GLOIRE, ET CAF√âINE"
  ];

  /***********************
   * DOM
   ***********************/
  const body = document.body;

  const hudTasks = document.getElementById("hudTasks");
  const hudEth = document.getElementById("hudEth");
  const hudDone = document.getElementById("hudDone");
  const hudTimer = document.getElementById("hudTimer");

  const bigFill = document.getElementById("bigFill");
  const bigPct = document.getElementById("bigPct");
  const taskNameEl = document.getElementById("taskName");
  const metaEst = document.getElementById("metaEst");
  const metaCat = document.getElementById("metaCat");

  const ethNowEl = document.getElementById("ethNow");
  const ethStartEl = document.getElementById("ethStart");
  const ethMinutesEl = document.getElementById("ethMinutes");
  const ethFill = document.getElementById("ethFill");
  const ethTicks = document.getElementById("ethTicks");
  const ethSizeLabel = document.getElementById("ethSizeLabel");

  const btnMenu = document.getElementById("btnMenu");
  const btnClose = document.getElementById("btnClose");
  const overlay = document.getElementById("overlay");

  const btnReset = document.getElementById("btnReset");
  const btnFocus = document.getElementById("btnFocus");
  const btnPure = document.getElementById("btnPure");

  const themeLight = document.getElementById("themeLight");
  const themeDark = document.getElementById("themeDark");

  const btnRoulette = document.getElementById("btnRoulette");
  const rouletteWheel = document.getElementById("rouletteWheel");
  const btnSmash = document.getElementById("btnSmash");

  const btnPin = document.getElementById("btnPin");
  const pinState = document.getElementById("pinState");
  const btnUp = document.getElementById("btnUp");
  const btnDown = document.getElementById("btnDown");
  const btnEdit = document.getElementById("btnEdit");
  const btnDelete = document.getElementById("btnDelete");

  const btnNoteQuick = document.getElementById("btnNoteQuick");

  const celebrate = document.getElementById("celebrate");
  const celebrateMain = document.getElementById("celebrateMain");
  const celebrateSub = document.getElementById("celebrateSub");

  // Tabs
  const tabs = [...document.querySelectorAll(".tab")];
  const panels = {
    inbox: document.getElementById("tab-inbox"),
    list: document.getElementById("tab-list"),
    notes: document.getElementById("tab-notes"),
    profile: document.getElementById("tab-profile")
  };

  // Inbox
  const inboxText = document.getElementById("inboxText");
  const defaultCategory = document.getElementById("defaultCategory");
  const defaultEth = document.getElementById("defaultEth");
  const btnImport = document.getElementById("btnImport");
  const btnClearInbox = document.getElementById("btnClearInbox");

  // List
  const taskList = document.getElementById("taskList");
  const catFilters = document.getElementById("catFilters");
  const sortModeSel = document.getElementById("sortMode");
  const btnApplySort = document.getElementById("btnApplySort");

  // Notes
  const noteText = document.getElementById("noteText");
  const btnAddNote = document.getElementById("btnAddNote");
  const btnClearNotes = document.getElementById("btnClearNotes");
  const notesGrid = document.getElementById("notesGrid");

  // Profile
  const btnToggleFocusFromMenu = document.getElementById("btnToggleFocusFromMenu");
  const btnTogglePureFromMenu = document.getElementById("btnTogglePureFromMenu");
  const ethMinutesPerSel = document.getElementById("ethMinutesPer");
  const statsBox = document.getElementById("statsBox");
  const btnExport = document.getElementById("btnExport");
  const btnNuke = document.getElementById("btnNuke");

  // Confetti
  const confettiCanvas = document.getElementById("confetti");
  const ctx = confettiCanvas.getContext("2d");

  /***********************
   * State
   ***********************/
  const nowISO = () => new Date().toISOString();
  const todayKey = () => new Date().toISOString().slice(0,10);

  const uid = () => Math.random().toString(16).slice(2) + "-" + Date.now().toString(16);

  function loadJSON(key, fallback){
    try{
      const raw = localStorage.getItem(key);
      if(!raw) return fallback;
      return JSON.parse(raw);
    }catch(e){ return fallback; }
  }
  function saveJSON(key, value){
    localStorage.setItem(key, JSON.stringify(value));
  }

  let settings = loadJSON(K.settings, DEFAULTS);
  settings = { ...DEFAULTS, ...settings };

  // Tasks state:
  // task: {id, title, cat, ethStart, ethLeft, createdAt, pinned, doneAt?}
  // state: { tasks:[], done:[], currentId:null, startCounts:{tasks,eth}, timer:{taskId, startedAt, elapsedMs} }
  let state = loadJSON(K.state, null);
  if(!state){
    state = {
      tasks: [],
      done: [],
      currentId: null,
      startCounts: { tasks: 0, eth: 0 },
      timer: { taskId: null, startedAt: null, elapsedMs: 0 }
    };
  }

  // Notes stored separately, survive resets
  let notes = loadJSON(K.notes, []);
  // History stored separately
  let history = loadJSON(K.history, {}); // { "YYYY-MM-DD": {ethSmashed, tasksDone, msWorked, snapshots:[] } }

  /***********************
   * Helpers
   ***********************/
  const clamp = (n, a, b) => Math.max(a, Math.min(b, n));

  function formatMMSS(ms){
    const s = Math.floor(ms/1000);
    const m = Math.floor(s/60);
    const r = s % 60;
    return String(m).padStart(2,"0") + ":" + String(r).padStart(2,"0");
  }

  function getActiveCatsSet(){
    const allCats = [...new Set(state.tasks.map(t=>t.cat || "Sans cat√©gorie"))].sort((a,b)=>a.localeCompare(b));
    if(!settings.activeCats || settings.activeCats.length===0){
      return new Set(allCats); // all active
    }
    return new Set(settings.activeCats);
  }

  function normalizeCat(s){
    if(!s) return "Sans cat√©gorie";
    const x = String(s).trim();
    if(!x) return "Sans cat√©gorie";
    // keep user's case but normalize common "qui fonce"
    if(x.toLowerCase().includes("qui fonce")) return "Qui fonce";
    return x;
  }

  function parseLineToTask(line, catDefault, ethDefault){
    const raw = line.trim();
    if(!raw) return null;

    // strip leading bullets
    let s = raw.replace(/^[-‚Ä¢*\u2022]\s+/, "").trim();
    if(!s) return null;

    // Detect category hints
    let cat = null;

    // [cat] prefix
    const mBracket = s.match(/^\[(.+?)\]\s*(.+)$/);
    if(mBracket){
      cat = mBracket[1];
      s = mBracket[2].trim();
    }

    // "Cat√©gorie: X | ..."
    const mCat1 = s.match(/cat(√©|e)gorie\s*:\s*([^|;]+)\s*/i);
    if(mCat1) cat = mCat1[2].trim();

    // "cat=..."
    const mCat2 = s.match(/\bcat\s*=\s*([^|;]+)\b/i);
    if(mCat2) cat = mCat2[1].trim();

    // "qui fonce" anywhere
    if(s.toLowerCase().includes("qui fonce") || (cat && cat.toLowerCase().includes("qui fonce"))){
      cat = "Qui fonce";
    }

    // Detect eth
    let eth = null;
    const mEth1 = s.match(/(√©|e)thorions?\s*:\s*(\d+)/i);
    if(mEth1) eth = parseInt(mEth1[2],10);

    const mEth2 = s.match(/\beth\s*=\s*(\d+)/i);
    if(mEth2) eth = parseInt(mEth2[1],10);

    const mEth3 = s.match(/\b(\d+)\s*eth\b/i);
    if(mEth3) eth = parseInt(mEth3[1],10);

    // Clean title by removing obvious meta patterns
    s = s
      .replace(/\bcat(√©|e)gorie\s*:\s*[^|;]+/ig, "")
      .replace(/\bcat\s*=\s*[^|;]+/ig, "")
      .replace(/(√©|e)thorions?\s*:\s*\d+/ig, "")
      .replace(/\beth\s*=\s*\d+/ig, "")
      .replace(/\b\d+\s*eth\b/ig, "")
      .replace(/\|/g," ")
      .replace(/\s{2,}/g," ")
      .trim();

    const finalCat = normalizeCat(cat || catDefault || "Sans cat√©gorie");
    const finalEth = clamp((eth || ethDefault || 1), 1, 999);

    if(!s) return null;

    return {
      id: uid(),
      title: s,
      cat: finalCat,
      ethStart: finalEth,
      ethLeft: finalEth,
      createdAt: nowISO(),
      pinned: false
    };
  }

  function recalcStartCountsIfNeeded(){
    // Start counts = counts at the moment of (re)starting a "run"
    // If not set (0) but there are tasks, set them. Or if tasks changed while startCounts is zero.
    if(state.startCounts.tasks === 0 && state.tasks.length > 0){
      state.startCounts.tasks = state.tasks.length;
      state.startCounts.eth = state.tasks.reduce((a,t)=>a+t.ethStart, 0);
    }
  }

  function setTheme(theme){
    settings.theme = theme;
    body.setAttribute("data-theme", theme);
    themeLight.classList.toggle("active", theme==="light");
    themeDark.classList.toggle("active", theme==="dark");
    saveJSON(K.settings, settings);
    // no further UI needed
  }

  function setFocus(on){
    settings.focus = on ? 1 : 0;
    body.setAttribute("data-focus", settings.focus);
    saveJSON(K.settings, settings);
  }

  function setPure(on){
    settings.pure = on ? 1 : 0;
    body.setAttribute("data-pure", settings.pure);
    saveJSON(K.settings, settings);
  }

  function openMenu(tabName="inbox"){
    overlay.classList.add("show");
    selectTab(tabName);
    renderAll();
  }
  function closeMenu(){
    overlay.classList.remove("show");
  }

  function selectTab(name){
    tabs.forEach(t => t.classList.toggle("active", t.dataset.tab===name));
    Object.keys(panels).forEach(k => panels[k].style.display = (k===name) ? "" : "none");
  }

  function setCurrentTask(id){
    state.currentId = id;
    // timer handling:
    if(state.timer.taskId !== id){
      state.timer.taskId = id;
      state.timer.startedAt = Date.now();
      state.timer.elapsedMs = 0;
    }else{
      // keep current
      if(!state.timer.startedAt) state.timer.startedAt = Date.now();
    }
    saveJSON(K.state, state);
  }

  function currentTask(){
    return state.tasks.find(t => t.id === state.currentId) || null;
  }

  function pickNextTaskRoulette(){
    const active = getActiveCatsSet();
    const pool = state.tasks.filter(t => active.has(t.cat || "Sans cat√©gorie"));
    if(pool.length === 0) return null;

    // Weighted: pinned tasks get extra chance
    const bag = [];
    for(const t of pool){
      const w = t.pinned ? 3 : 1;
      for(let i=0;i<w;i++) bag.push(t);
    }
    return bag[Math.floor(Math.random()*bag.length)];
  }

  function pickNextTaskOrdered(){
    const active = getActiveCatsSet();
    const pool = state.tasks.filter(t => active.has(t.cat || "Sans cat√©gorie"));
    if(pool.length === 0) return null;

    if(settings.sortMode === "alpha"){
      return [...pool].sort((a,b)=>a.title.localeCompare(b.title))[0];
    }
    if(settings.sortMode === "chrono"){
      return [...pool].sort((a,b)=>new Date(a.createdAt)-new Date(b.createdAt))[0];
    }
    // "order" = current list order (respect user moves)
    return pool[0];
  }

  function ensureCurrent(){
    if(state.tasks.length === 0){
      state.currentId = null;
      state.timer = { taskId:null, startedAt:null, elapsedMs:0 };
      saveJSON(K.state, state);
      return;
    }
    if(!state.currentId || !currentTask()){
      const t = (settings.sortMode==="roulette") ? pickNextTaskRoulette() : pickNextTaskOrdered();
      if(t) setCurrentTask(t.id);
    }
  }

  function moveTask(id, dir){
    const idx = state.tasks.findIndex(t=>t.id===id);
    if(idx < 0) return;
    const newIdx = clamp(idx + dir, 0, state.tasks.length-1);
    if(newIdx === idx) return;
    const [x] = state.tasks.splice(idx,1);
    state.tasks.splice(newIdx,0,x);
    saveJSON(K.state, state);
  }

  function celebrateNow(sub){
    celebrateMain.textContent = CELEB[Math.floor(Math.random()*CELEB.length)];
    celebrateSub.textContent = sub || "Fait.";
    celebrate.classList.add("show");
    setTimeout(()=>celebrate.classList.remove("show"), 1200);
  }

  /***********************
   * Confetti
   ***********************/
  let confettiPieces = [];
  function resizeConfetti(){
    confettiCanvas.width = window.innerWidth * devicePixelRatio;
    confettiCanvas.height = window.innerHeight * devicePixelRatio;
    confettiCanvas.style.width = window.innerWidth + "px";
    confettiCanvas.style.height = window.innerHeight + "px";
    ctx.setTransform(devicePixelRatio,0,0,devicePixelRatio,0,0);
  }
  window.addEventListener("resize", resizeConfetti);
  resizeConfetti();

  function burstConfetti(){
    const w = window.innerWidth;
    const h = window.innerHeight;
    const n = 140;

    for(let i=0;i<n;i++){
      confettiPieces.push({
        x: w/2 + (Math.random()*80-40),
        y: 70 + (Math.random()*20-10),
        vx: (Math.random()*6-3),
        vy: (Math.random()*-5 - 2),
        g: 0.18 + Math.random()*0.12,
        r: 2 + Math.random()*4,
        a: 1,
        spin: (Math.random()*0.4-0.2),
        angle: Math.random()*Math.PI*2,
        life: 70 + Math.random()*40
      });
    }
  }

  function confettiLoop(){
    ctx.clearRect(0,0,window.innerWidth, window.innerHeight);
    const next = [];
    for(const p of confettiPieces){
      p.x += p.vx;
      p.y += p.vy;
      p.vy += p.g;
      p.angle += p.spin;
      p.life -= 1;
      p.a = clamp(p.life/90, 0, 1);

      // draw as small rotated rect
      ctx.save();
      ctx.globalAlpha = p.a;
      ctx.translate(p.x, p.y);
      ctx.rotate(p.angle);
      ctx.fillStyle = "rgba(255,255,255,0.0)"; // placeholder
      // no fixed palette required; we‚Äôll derive from theme accents dynamically
      const accent = getComputedStyle(document.documentElement).getPropertyValue("--accent").trim() || "#2a67ff";
      const accent2 = getComputedStyle(document.documentElement).getPropertyValue("--accent2").trim() || "#1fd18a";
      const warn = getComputedStyle(document.documentElement).getPropertyValue("--warn").trim() || "#ffb020";
      const bad = getComputedStyle(document.documentElement).getPropertyValue("--bad").trim() || "#ff3b5c";
      const pick = [accent, accent2, warn, bad][Math.floor(Math.random()*4)];
      ctx.fillStyle = pick;
      ctx.fillRect(-p.r, -p.r/2, p.r*2.2, p.r);
      ctx.restore();

      if(p.life > 0 && p.y < window.innerHeight + 60) next.push(p);
    }
    confettiPieces = next;
    requestAnimationFrame(confettiLoop);
  }
  confettiLoop();

  /***********************
   * History / Stats
   ***********************/
  function ensureDay(){
    const k = todayKey();
    if(!history[k]){
      history[k] = { ethSmashed:0, tasksDone:0, msWorked:0, snapshots:[] };
    }
  }

  function addWorkMs(ms){
    ensureDay();
    history[todayKey()].msWorked += ms;
    saveJSON(K.history, history);
  }

  function addEthSmashed(n){
    ensureDay();
    history[todayKey()].ethSmashed += n;
    saveJSON(K.history, history);
  }

  function addTaskDone(){
    ensureDay();
    history[todayKey()].tasksDone += 1;
    saveJSON(K.history, history);
  }

  function snapshot(label){
    ensureDay();
    const k = todayKey();
    history[k].snapshots.push({
      at: nowISO(),
      label,
      tasksLeft: state.tasks.length,
      ethLeft: state.tasks.reduce((a,t)=>a+t.ethLeft,0)
    });
    // keep snapshots reasonable
    if(history[k].snapshots.length > 60) history[k].snapshots.shift();
    saveJSON(K.history, history);
  }

  /***********************
   * Rendering
   ***********************/
  function renderHUD(){
    const totalTasksStart = state.startCounts.tasks || (state.tasks.length + state.done.length);
    const totalEthStart = state.startCounts.eth || state.tasks.reduce((a,t)=>a+t.ethStart,0) + state.done.reduce((a,t)=>a+t.ethStart,0);

    const tasksLeft = state.tasks.length;
    const ethLeft = state.tasks.reduce((a,t)=>a+t.ethLeft,0);
    const done = state.done.length;

    hudTasks.textContent = `${tasksLeft}/${totalTasksStart}`;
    hudEth.textContent = `${ethLeft}/${totalEthStart}`;
    hudDone.textContent = `${done}`;

    // timer is handled in tick()
  }

  function renderCurrent(){
    ensureCurrent();
    const t = currentTask();
    if(!t){
      taskNameEl.textContent = "Aucune t√¢che (ouvre Menu ‚Üí Inbox / Liste)";
      metaEst.textContent = "Estim√©: 0 min";
      metaCat.textContent = "Cat√©gorie: ‚Äî";
      pinState.textContent = "non";

      bigFill.style.transform = "scaleX(1)";
      bigPct.textContent = "100%";

      ethNowEl.textContent = "0";
      ethStartEl.textContent = "0";
      ethMinutesEl.textContent = "0";
      ethFill.style.transform = "scaleX(1)";
      ethTicks.innerHTML = "";
      return;
    }

    taskNameEl.textContent = t.title;
    metaCat.textContent = `Cat√©gorie: ${t.cat || "Sans cat√©gorie"}`;

    const minPer = settings.ethMinutesPer;
    const estTotal = t.ethStart * minPer;
    metaEst.textContent = `Estim√©: ${estTotal} min`;

    // Big bar: inverse proportionnel (bar starts full and shrinks)
    const frac = t.ethStart > 0 ? (t.ethLeft / t.ethStart) : 1;
    bigFill.style.transform = `scaleX(${clamp(frac,0,1)})`;
    bigPct.textContent = `${Math.round(frac*100)}%`;

    // ETH bar
    ethNowEl.textContent = `${t.ethLeft}`;
    ethStartEl.textContent = `${t.ethStart}`;
    ethMinutesEl.textContent = `${t.ethLeft * minPer}`;
    ethSizeLabel.textContent = `${minPer}`;

    ethFill.style.transform = `scaleX(${clamp(frac,0,1)})`;

    // ticks = ethStart segments
    ethTicks.innerHTML = "";
    const n = clamp(t.ethStart, 1, 60);
    for(let i=0;i<n;i++){
      const sp = document.createElement("span");
      ethTicks.appendChild(sp);
    }

    pinState.textContent = t.pinned ? "oui" : "non";
  }

  function renderCategories(){
    // Populate defaultCategory list
    const cats = [...new Set(state.tasks.map(t=>t.cat || "Sans cat√©gorie"))].sort((a,b)=>a.localeCompare(b));
    const all = ["Qui fonce", ...cats.filter(c=>c!=="Qui fonce")];
    const uniq = [...new Set(all)];

    defaultCategory.innerHTML = `<option value="">Cat√©gorie par d√©faut (optionnel)</option>` + uniq.map(c=>`<option value="${escapeHTML(c)}">${escapeHTML(c)}</option>`).join("");

    // Filters
    const active = getActiveCatsSet();
    catFilters.innerHTML = "";
    for(const c of uniq){
      const btn = document.createElement("button");
      btn.className = "btn small";
      const on = active.has(c);
      btn.textContent = (on ? "‚úì " : "‚óã ") + c;
      btn.onclick = () => {
        // toggle
        let next = settings.activeCats;
        const allCats = uniq;

        if(!next || next.length===0){
          // currently all active -> set explicit list then toggle off one
          next = [...allCats];
        }else{
          next = [...next];
        }

        if(next.includes(c)){
          next = next.filter(x=>x!==c);
        }else{
          next.push(c);
        }

        // If ends up empty => none active (we allow, but then roulette has no pool)
        settings.activeCats = next;
        saveJSON(K.settings, settings);
        renderAll();
      };
      catFilters.appendChild(btn);
    }
  }

  function renderTaskList(){
    taskList.innerHTML = "";
    const active = getActiveCatsSet();

    const arr = [...state.tasks];
    // minimal sorting preview (doesn't mutate order unless apply)
    const preview = arr;

    for(const t of preview){
      const item = document.createElement("div");
      item.className = "taskItem";

      const left = document.createElement("div");
      const name = document.createElement("div");
      name.className = "name";
      name.textContent = t.title;

      const sub = document.createElement("div");
      sub.className = "sub";
      const isActive = active.has(t.cat || "Sans cat√©gorie");
      sub.textContent = `${t.cat || "Sans cat√©gorie"} ‚Ä¢ eth ${t.ethLeft}/${t.ethStart}` + (t.pinned ? " ‚Ä¢ üìå" : "") + (isActive ? "" : " ‚Ä¢ (inactif)");

      left.appendChild(name);
      left.appendChild(sub);

      const right = document.createElement("div");
      right.className = "actions";

      const btnSet = mkBtn("Voir", () => { setCurrentTask(t.id); closeMenu(); renderAll(); }, "btn");
      const btnPri = mkBtn("‚Üë", () => { moveTask(t.id, -1); renderAll(); }, "btn");
      const btnDel = mkBtn("üóë", () => { deleteTask(t.id); renderAll(); }, "btn danger");
      const btnEd = mkBtn("‚úèÔ∏è", () => { editTaskPrompt(t.id); renderAll(); }, "btn");

      right.appendChild(btnSet);
      right.appendChild(btnPri);
      right.appendChild(btnEd);
      right.appendChild(btnDel);

      item.appendChild(left);
      item.appendChild(right);
      taskList.appendChild(item);
    }

    if(state.tasks.length===0){
      const empty = document.createElement("div");
      empty.className="help";
      empty.textContent = "Liste vide. Inbox ‚Üí colle des t√¢ches, puis reviens ici comme un monarque organis√©.";
      taskList.appendChild(empty);
    }
  }

  function renderNotes(){
    notesGrid.innerHTML = "";
    const arr = [...notes].sort((a,b)=>new Date(b.at)-new Date(a.at));
    for(const n of arr){
      const d = document.createElement("div");
      d.className = "note";
      const stamp = document.createElement("div");
      stamp.className = "stamp";
      stamp.textContent = new Date(n.at).toLocaleString();
      const txt = document.createElement("div");
      txt.className = "txt";
      txt.textContent = n.text;
      d.appendChild(stamp);
      d.appendChild(txt);
      notesGrid.appendChild(d);
    }
    if(arr.length===0){
      const empty = document.createElement("div");
      empty.className="help";
      empty.textContent="Pas de notes. Ton cerveau n‚Äôa pas encore l√¢ch√© ses post-its dans l‚Äôunivers, incroyable.";
      notesGrid.appendChild(empty);
    }
  }

  function renderStats(){
    ensureDay();
    const k = todayKey();
    const day = history[k];

    const totalEthLeft = state.tasks.reduce((a,t)=>a+t.ethLeft,0);
    const totalEthStart = state.startCounts.eth || (state.tasks.reduce((a,t)=>a+t.ethStart,0) + state.done.reduce((a,t)=>a+t.ethStart,0));
    const totalTasksStart = state.startCounts.tasks || (state.tasks.length + state.done.length);

    const lines = [];
    lines.push(`Aujourd‚Äôhui (${k})`);
    lines.push(`- √âthorions d√©gomm√©s: ${day.ethSmashed}`);
    lines.push(`- T√¢ches termin√©es: ${day.tasksDone}`);
    lines.push(`- Temps cumul√© (approx): ${formatMMSS(day.msWorked)}`);

    lines.push(``);
    lines.push(`Run actuel`);
    lines.push(`- T√¢ches restantes: ${state.tasks.length}/${totalTasksStart}`);
    lines.push(`- √âthorions restants: ${totalEthLeft}/${totalEthStart}`);
    lines.push(`- Faits (run): ${state.done.length}`);

    lines.push(``);
    lines.push(`Snapshots (derniers)`);
    const snaps = day.snapshots.slice(-6);
    for(const s of snaps){
      lines.push(`- ${new Date(s.at).toLocaleTimeString()} ‚Ä¢ ${s.label} ‚Ä¢ tasks:${s.tasksLeft} eth:${s.ethLeft}`);
    }
    statsBox.textContent = lines.join("\n");
  }

  function renderAll(){
    recalcStartCountsIfNeeded();
    renderHUD();
    renderCurrent();
    renderCategories();
    renderTaskList();
    renderNotes();
    renderStats();
    saveJSON(K.state, state);
  }

  function mkBtn(label, onClick, className){
    const b = document.createElement("button");
    b.className = className || "btn";
    b.textContent = label;
    b.onclick = onClick;
    return b;
  }

  function escapeHTML(s){
    return String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'}[m]));
  }

  /***********************
   * Core actions
   ***********************/
  function roulettePick(){
    // spin animation
    btnRoulette.classList.add("spinning");
    setTimeout(()=>btnRoulette.classList.remove("spinning"), 920);

    const t = (settings.sortMode==="roulette") ? pickNextTaskRoulette() : pickNextTaskOrdered();
    if(!t){
      celebrateNow("Aucune t√¢che active (filtre cat√©gories?)");
      return;
    }
    setCurrentTask(t.id);
    snapshot("roulette");
    renderAll();
  }

  function smashOneEth(){
    const t = currentTask();
    if(!t){
      celebrateNow("Pas de t√¢che. Inbox d‚Äôabord.");
      return;
    }

    // time log: add time since last tick chunk is handled in tick()
    // decrement eth
    if(t.ethLeft > 0){
      t.ethLeft -= 1;
      addEthSmashed(1);
      celebrateNow("+1 √©thorion √©limin√©");
      burstConfetti();

      if(t.ethLeft <= 0){
        // task complete
        t.ethLeft = 0;
        t.doneAt = nowISO();
        state.done.push(t);
        state.tasks = state.tasks.filter(x=>x.id!==t.id);
        addTaskDone();
        snapshot("t√¢che termin√©e");

        // choose next task automatically
        state.currentId = null;
        state.timer = { taskId:null, startedAt:null, elapsedMs:0 };
        ensureCurrent();

        celebrateNow("T√¢che pulv√©ris√©e. Prochaine victime.");
        burstConfetti();
      }else{
        snapshot("eth -1");
      }

      saveJSON(K.state, state);
      renderAll();
    }
  }

  function deleteTask(id){
    const t = state.tasks.find(x=>x.id===id);
    if(!t) return;
    state.tasks = state.tasks.filter(x=>x.id!==id);
    if(state.currentId === id){
      state.currentId = null;
      state.timer = { taskId:null, startedAt:null, elapsedMs:0 };
    }
    snapshot("suppression");
    ensureCurrent();
    saveJSON(K.state, state);
  }

  function editTaskPrompt(id){
    const t = state.tasks.find(x=>x.id===id);
    if(!t) return;

    const newTitle = prompt("Modifier le titre :", t.title);
    if(newTitle === null) return;
    const cleaned = newTitle.trim();
    if(!cleaned) return;

    t.title = cleaned;
    snapshot("√©dition titre");
    saveJSON(K.state, state);
    renderAll();
  }

  function togglePinCurrent(){
    const t = currentTask();
    if(!t) return;
    t.pinned = !t.pinned;
    snapshot(t.pinned ? "pin" : "unpin");
    saveJSON(K.state, state);
    renderAll();
  }

  function prioritizeCurrent(){
    const t = currentTask();
    if(!t) return;
    // move to top within list (hard prioritize)
    const idx = state.tasks.findIndex(x=>x.id===t.id);
    if(idx>0){
      state.tasks.splice(idx,1);
      state.tasks.unshift(t);
      snapshot("prioriser");
      saveJSON(K.state, state);
      renderAll();
    }
  }

  function deprioritizeCurrent(){
    const t = currentTask();
    if(!t) return;
    // move to bottom
    const idx = state.tasks.findIndex(x=>x.id===t.id);
    if(idx>=0 && idx<state.tasks.length-1){
      state.tasks.splice(idx,1);
      state.tasks.push(t);
      snapshot("d√©prioriser");
      saveJSON(K.state, state);
      renderAll();
    }
  }

  function resetRun(){
    // Reset = remettre une ‚Äúrun‚Äù propre : on conserve t√¢ches + done? (au choix)
    // Ici: reset remet done √† vide et r√©initialise les compteurs de d√©part sur les t√¢ches actuelles
    // et remet timer. Notes restent. Historique reste.
    if(!confirm("Reset du run (t√¢ches faites repassent √† z√©ro dans le compteur 'Faits'). Notes conserv√©es.")) return;

    state.done = [];
    state.startCounts.tasks = state.tasks.length;
    state.startCounts.eth = state.tasks.reduce((a,t)=>a+t.ethStart,0);

    // reset ethLeft to ethStart? NON : tu n‚Äôas pas demand√© √ßa.
    // Donc on garde l‚Äô√©tat actuel des √©thorions (sinon c‚Äôest un 'restart tasks', pas un reset run).
    // Si tu veux un bouton ‚Äúred√©ployer toutes les t√¢ches √† 100%‚Äù, on peut l‚Äôajouter apr√®s.

    state.currentId = null;
    state.timer = { taskId:null, startedAt:null, elapsedMs:0 };
    snapshot("reset run");
    ensureCurrent();
    saveJSON(K.state, state);
    renderAll();
    celebrateNow("Reset. Nouvelle campagne. M√™me empire.");
  }

  function nukeAllButNotes(){
    if(!confirm("Tout effacer (t√¢ches + stats), mais garder les notes. Confirmer ?")) return;

    state = {
      tasks: [],
      done: [],
      currentId: null,
      startCounts: { tasks: 0, eth: 0 },
      timer: { taskId: null, startedAt: null, elapsedMs: 0 }
    };
    history = {}; // wipe stats
    saveJSON(K.state, state);
    saveJSON(K.history, history);
    snapshot("nuke");
    renderAll();
    celebrateNow("Tout effac√©. Les notes ont surv√©cu. √âvidemment.");
  }

  function applySortMode(){
    settings.sortMode = sortModeSel.value;
    saveJSON(K.settings, settings);

    // Option ‚ÄúAppliquer‚Äù : on r√©ordonne r√©ellement la liste si alpha/chrono/order
    if(settings.sortMode === "alpha"){
      state.tasks.sort((a,b)=>a.title.localeCompare(b.title));
      snapshot("tri alpha");
    }else if(settings.sortMode === "chrono"){
      state.tasks.sort((a,b)=>new Date(a.createdAt)-new Date(b.createdAt));
      snapshot("tri chrono");
    }else{
      // "order" and "roulette" don't need reorder
      snapshot("mode tri chang√©");
    }
    saveJSON(K.state, state);
    renderAll();
    celebrateNow("Tri appliqu√©. La liste ob√©it.");
  }

  function addNotes(text){
    const cleaned = String(text || "").trim();
    if(!cleaned) return;
    notes.push({ id: uid(), at: nowISO(), text: cleaned });
    saveJSON(K.notes, notes);
    renderNotes();
    celebrateNow("Note captur√©e. Dans le bocal.");
  }

  function quickNote(){
    openMenu("notes");
    setTimeout(()=>noteText.focus(), 120);
  }

  function importInbox(){
    const lines = inboxText.value.split(/\r?\n/).map(x=>x.trim()).filter(Boolean);
    if(lines.length===0){
      celebrateNow("Inbox vide.");
      return;
    }

    const catDef = defaultCategory.value || "";
    const ethDef = parseInt(defaultEth.value,10);
    const ethDefaultSafe = Number.isFinite(ethDef) && ethDef>0 ? ethDef : null;

    const added = [];
    for(const line of lines){
      const t = parseLineToTask(line, catDef, ethDefaultSafe);
      if(t) added.push(t);
    }

    if(added.length===0){
      celebrateNow("Rien √† importer (format √©trange).");
      return;
    }

    state.tasks.push(...added);

    // If first time, set startCounts
    state.startCounts.tasks = state.tasks.length;
    state.startCounts.eth = state.tasks.reduce((a,t)=>a+t.ethStart,0);

    snapshot("import inbox");
    ensureCurrent();
    saveJSON(K.state, state);
    renderAll();
    celebrateNow(`${added.length} t√¢che(s) import√©e(s)`);
    burstConfetti();
  }

  /***********************
   * Timer tick
   ***********************/
  let lastTick = Date.now();
  function tick(){
    const now = Date.now();
    const dt = now - lastTick;
    lastTick = now;

    const t = currentTask();
    if(t && state.timer.taskId === t.id && state.timer.startedAt){
      state.timer.elapsedMs += dt;
      // We log "work time" continuously (approx)
      addWorkMs(dt);
      hudTimer.textContent = formatMMSS(state.timer.elapsedMs);
    }else{
      hudTimer.textContent = "00:00";
    }

    // update HUD counts occasionally without heavy rendering
    renderHUD();
    requestAnimationFrame(tick);
  }

  /***********************
   * Events
   ***********************/
  btnMenu.onclick = () => openMenu("inbox");
  btnClose.onclick = closeMenu;
  overlay.addEventListener("click", (e)=>{ if(e.target===overlay) closeMenu(); });

  tabs.forEach(t => t.addEventListener("click", () => selectTab(t.dataset.tab)));

  themeLight.onclick = () => setTheme("light");
  themeDark.onclick = () => setTheme("dark");

  btnFocus.onclick = () => setFocus(!(settings.focus===1));
  btnToggleFocusFromMenu.onclick = () => setFocus(!(settings.focus===1));

  btnPure.onclick = () => setPure(!(settings.pure===1));
  btnTogglePureFromMenu.onclick = () => setPure(!(settings.pure===1));

  btnReset.onclick = resetRun;

  btnRoulette.onclick = roulettePick;
  btnSmash.onclick = smashOneEth;

  btnPin.onclick = togglePinCurrent;
  btnUp.onclick = prioritizeCurrent;
  btnDown.onclick = deprioritizeCurrent;
  btnEdit.onclick = () => {
    const t = currentTask();
    if(!t) return;
    editTaskPrompt(t.id);
  };
  btnDelete.onclick = () => {
    const t = currentTask();
    if(!t) return;
    if(!confirm("Supprimer cette t√¢che ?")) return;
    deleteTask(t.id);
    celebrateNow("T√¢che supprim√©e. Elle ne reviendra pas hanter tes nuits.");
    renderAll();
  };

  btnNoteQuick.onclick = quickNote;

  btnImport.onclick = importInbox;
  btnClearInbox.onclick = () => { inboxText.value=""; };

  btnApplySort.onclick = applySortMode;

  btnAddNote.onclick = () => {
    addNotes(noteText.value);
    noteText.value = "";
    renderAll();
  };

  btnClearNotes.onclick = () => {
    if(!confirm("Effacer toutes les notes ? (irr√©versible)")) return;
    notes = [];
    saveJSON(K.notes, notes);
    renderNotes();
    celebrateNow("Notes effac√©es. M√©moire purg√©e.");
  };

  ethMinutesPerSel.onchange = () => {
    settings.ethMinutesPer = parseInt(ethMinutesPerSel.value,10) || 5;
    saveJSON(K.settings, settings);
    renderAll();
  };

  btnExport.onclick = () => {
    const payload = {
      exportedAt: nowISO(),
      settings,
      state,
      notes,
      history
    };
    const blob = new Blob([JSON.stringify(payload,null,2)], {type:"application/json"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = `eliminator_export_${todayKey()}.json`;
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
    celebrateNow("Export√©. Archive de guerre cr√©√©e.");
  };

  btnNuke.onclick = nukeAllButNotes;

  sortModeSel.onchange = () => {
    // live reflect
    settings.sortMode = sortModeSel.value;
    saveJSON(K.settings, settings);
  };

  /***********************
   * Init
   ***********************/
  function applySettingsToUI(){
    setTheme(settings.theme);
    setFocus(settings.focus===1);
    setPure(settings.pure===1);
    ethMinutesPerSel.value = String(settings.ethMinutesPer || 5);
    sortModeSel.value = settings.sortMode || "roulette";
  }

  applySettingsToUI();
  ensureDay();
  recalcStartCountsIfNeeded();
  ensureCurrent();
  renderAll();
  tick();

})();
</script>
</body>
</html>
