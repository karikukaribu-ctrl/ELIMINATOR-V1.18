<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>ELIMINATOR</title>
  <style>
    /* =========
      THEME TOKENS
    ========= */
    :root{
      --bg:#f6f7fb;
      --panel:#ffffffcc;
      --panelSolid:#ffffff;
      --ink:#101322;
      --muted:#5a6375;
      --line:#dfe3ee;
      --shadow: 0 10px 30px rgba(16,19,34,.08);
      --accent:#2f66ff;   /* light mode accent */
      --accent2:#10b981;  /* alt accent */
      --danger:#e23b3b;
      --warn:#f59e0b;
      --chip:#f1f3f9;
      --glass: blur(10px);
    }
    [data-theme="dark"]{
      --bg:#0f1116;
      --panel:#141826cc;
      --panelSolid:#141826;
      --ink:#eaf0ff;
      --muted:#a6b0c3;
      --line:#2a3145;
      --shadow: 0 12px 34px rgba(0,0,0,.35);
      --accent:#10b981;  /* dark mode accent */
      --accent2:#ffb020;
      --chip:#0b0e18;
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, "Apple Color Emoji","Segoe UI Emoji";
      background: radial-gradient(900px 500px at 20% 0%, rgba(47,102,255,.12), transparent 60%),
                  radial-gradient(700px 500px at 80% 10%, rgba(16,185,129,.10), transparent 55%),
                  var(--bg);
      color:var(--ink);
      overflow-x:hidden;
    }

    /* =========
      LAYOUT
    ========= */
    .wrap{
      max-width: 980px;
      margin: 0 auto;
      padding: 18px 14px 40px;
      position:relative;
    }

    /* =========
      HEADER
    ========= */
    .topbar{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:12px;
      margin-bottom: 10px;
    }
    .brand{
      display:flex;
      flex-direction:column;
      gap:6px;
    }
    .brand h1{
      margin:0;
      letter-spacing: .5px;
      font-weight: 900;
      line-height: 1;
      font-size: clamp(44px, 6vw, 86px); /* ~tripl√© vs versions classiques */
    }
    .brand .sub{
      margin:0;
      color:var(--muted);
      font-weight:700;
      letter-spacing:.2px;
      font-size: clamp(14px, 2.2vw, 18px);
    }

    .topControls{
      display:flex;
      align-items:center;
      gap:10px;
      flex-wrap:wrap;
      justify-content:flex-end;
    }

    .pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:10px 12px;
      border:1px solid var(--line);
      background: var(--panelSolid);
      box-shadow: var(--shadow);
      border-radius: 999px;
      backdrop-filter: var(--glass);
      -webkit-backdrop-filter: var(--glass);
      user-select:none;
    }

    .pill button{
      border:0;
      background:transparent;
      color:var(--ink);
      font-weight:800;
      padding:6px 10px;
      border-radius:999px;
      cursor:pointer;
    }
    .pill button.active{
      background: color-mix(in oklab, var(--accent) 18%, transparent);
      outline: 2px solid color-mix(in oklab, var(--accent) 35%, transparent);
    }
    .pill button:active{transform: translateY(1px);}

    .iconBtn{
      border:1px solid var(--line);
      background: var(--panelSolid);
      box-shadow: var(--shadow);
      border-radius: 16px;
      padding:10px 12px;
      cursor:pointer;
      font-weight:900;
      color:var(--ink);
      display:inline-flex;
      align-items:center;
      gap:8px;
    }
    .iconBtn:active{transform: translateY(1px);}

    /* =========
      MAIN PANEL
    ========= */
    .panel{
      border:1px solid var(--line);
      background: var(--panel);
      box-shadow: var(--shadow);
      border-radius: 22px;
      padding: 16px;
      backdrop-filter: var(--glass);
      -webkit-backdrop-filter: var(--glass);
      position:relative;
      overflow:hidden;
    }

    /* =========
      STATS (minimal, no buttons)
    ========= */
    .stats{
      display:flex;
      flex-wrap:wrap;
      gap:10px 14px;
      align-items:center;
      justify-content:space-between;
      margin-bottom: 12px;
    }
    .statLine{
      display:flex;
      gap:12px;
      flex-wrap:wrap;
      align-items:center;
      color:var(--muted);
      font-weight:800;
      font-size: 14px;
    }
    .statLine b{color:var(--ink)}
    .timer{
      font-variant-numeric: tabular-nums;
      font-weight:900;
      color:var(--ink);
    }

    /* =========
      BIG PROGRESS BAR
    ========= */
    .progressBox{
      border:1px solid var(--line);
      border-radius: 18px;
      padding: 12px;
      background: var(--panelSolid);
      box-shadow: 0 10px 24px rgba(0,0,0,.06);
      margin-bottom: 12px;
    }
    .bar{
      height: 40px;              /* doubl√©e / tripl√©e */
      border-radius: 999px;
      background: color-mix(in oklab, var(--line) 55%, transparent);
      position:relative;
      overflow:hidden;
    }
    .fill{
      height:100%;
      width:50%;
      background: linear-gradient(90deg,
        color-mix(in oklab, var(--accent) 85%, white 10%),
        color-mix(in oklab, var(--accent2) 75%, white 10%)
      );
      border-radius: 999px;
      transition: width .25s ease;
    }
    .pct{
      position:absolute;
      inset:0;
      display:flex;
      align-items:center;
      justify-content:center;
      font-weight:1000;
      letter-spacing:.4px;
      color: color-mix(in oklab, var(--ink) 92%, white 0%);
      text-shadow: 0 1px 0 rgba(255,255,255,.35);
      font-variant-numeric: tabular-nums;
    }

    /* =========
      CURRENT TARGET
    ========= */
    .target{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:12px;
      margin: 10px 2px 8px;
    }
    .targetName{
      font-weight: 950;
      font-size: clamp(18px, 3.3vw, 26px);
      line-height:1.1;
      margin:0;
      word-break: break-word;
    }
    .miniMeta{
      color:var(--muted);
      font-weight:800;
      font-size:13px;
      text-align:right;
      min-width: 190px;
    }
    .miniMeta .mono{font-variant-numeric: tabular-nums; font-weight:950; color:var(--ink)}
    .miniMeta .small{font-size:12px; color:var(--muted); font-weight:800}

    /* =========
      ETHORION FRAGMENTS BAR (dotted)
    ========= */
    .ethRow{
      margin-top: 10px;
      display:flex;
      align-items:center;
      gap:10px;
      flex-wrap:wrap;
    }
    .ethTrack{
      flex:1;
      min-width: 220px;
      height: 18px;
      border-radius: 999px;
      border:1px solid var(--line);
      background:
        repeating-linear-gradient(
          90deg,
          color-mix(in oklab, var(--line) 85%, transparent) 0px,
          color-mix(in oklab, var(--line) 85%, transparent) 6px,
          transparent 6px,
          transparent 12px
        );
      position:relative;
      overflow:hidden;
    }
    .ethFill{
      height:100%;
      width:50%;
      background: color-mix(in oklab, var(--accent) 28%, transparent);
      border-right: 2px solid color-mix(in oklab, var(--accent) 70%, transparent);
      transition: width .2s ease;
    }
    .ethActions{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      justify-content:flex-end;
    }

    .primary{
      border:0;
      background: linear-gradient(90deg,
        color-mix(in oklab, var(--accent) 92%, white 0%),
        color-mix(in oklab, var(--accent2) 85%, white 0%)
      );
      color:white;
      font-weight:950;
      padding: 12px 14px;
      border-radius: 16px;
      cursor:pointer;
      box-shadow: 0 10px 22px rgba(0,0,0,.15);
    }
    .ghost{
      border:1px solid var(--line);
      background: var(--panelSolid);
      color:var(--ink);
      font-weight:900;
      padding: 12px 12px;
      border-radius: 16px;
      cursor:pointer;
    }
    .danger{
      border:1px solid color-mix(in oklab, var(--danger) 55%, var(--line));
      background: color-mix(in oklab, var(--danger) 10%, var(--panelSolid));
      color: color-mix(in oklab, var(--danger) 75%, var(--ink));
      font-weight:950;
      padding:12px 12px;
      border-radius:16px;
      cursor:pointer;
    }
    .btnSm{padding:10px 10px; border-radius:14px; font-weight:900;}
    .primary:active,.ghost:active,.danger:active{transform: translateY(1px);}

    /* =========
      BELOW CONTROLS
    ========= */
    .below{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      margin-top: 14px;
      flex-wrap:wrap;
    }
    .leftGroup,.rightGroup{display:flex; gap:10px; flex-wrap:wrap; align-items:center;}

    /* =========
      MENU OVERLAY
    ========= */
    .overlay{
      position:fixed;
      inset:0;
      background: rgba(0,0,0,.25);
      display:none;
      align-items:stretch;
      justify-content:flex-end;
      z-index:50;
    }
    .overlay.open{display:flex;}
    .drawer{
      width:min(520px, 92vw);
      height:100%;
      background: var(--panel);
      border-left: 1px solid var(--line);
      backdrop-filter: var(--glass);
      -webkit-backdrop-filter: var(--glass);
      padding: 16px;
      box-shadow: -20px 0 40px rgba(0,0,0,.18);
      overflow:auto;
    }
    .drawer h2{
      margin: 6px 0 10px;
      font-size: 18px;
      font-weight: 950;
    }
    .tabs{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      margin-bottom: 10px;
    }
    .tab{
      padding:10px 12px;
      border-radius:999px;
      border:1px solid var(--line);
      background: var(--panelSolid);
      cursor:pointer;
      font-weight:900;
    }
    .tab.active{
      outline:2px solid color-mix(in oklab, var(--accent) 40%, transparent);
      background: color-mix(in oklab, var(--accent) 14%, var(--panelSolid));
    }

    .section{
      border:1px solid var(--line);
      background: var(--panelSolid);
      border-radius: 18px;
      padding: 12px;
      margin: 10px 0;
    }
    .row{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
      justify-content:space-between;
    }
    .row label{
      font-weight:900;
      color:var(--muted);
      font-size: 13px;
    }
    .row .right{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      justify-content:flex-end;
      align-items:center;
    }
    input[type="text"], input[type="number"], textarea, select{
      width:100%;
      padding: 10px 12px;
      border-radius: 14px;
      border:1px solid var(--line);
      background: var(--panelSolid);
      color: var(--ink);
      font-weight:800;
      outline:none;
    }
    textarea{min-height: 120px; resize: vertical; font-weight:800;}
    .hint{color:var(--muted); font-size:12px; font-weight:800; margin-top:8px}

    /* =========
      TASK LIST
    ========= */
    .taskList{
      display:flex;
      flex-direction:column;
      gap:10px;
      margin-top:10px;
    }
    .taskItem{
      border:1px solid var(--line);
      background: var(--panelSolid);
      border-radius: 18px;
      padding: 10px 10px 10px 12px;
      display:flex;
      gap:10px;
      align-items:flex-start;
      justify-content:space-between;
    }
    .taskItem .info{
      display:flex;
      flex-direction:column;
      gap:4px;
      min-width: 0;
      flex:1;
    }
    .taskItem .title{
      font-weight:950;
      word-break:break-word;
    }
    .taskItem .meta{
      color:var(--muted);
      font-size: 12px;
      font-weight:850;
      display:flex;
      gap:10px;
      flex-wrap:wrap;
    }
    .taskBtns{
      display:flex;
      gap:8px;
      align-items:center;
      flex-wrap:wrap;
      justify-content:flex-end;
    }

    /* =========
      NOTES (post-it style)
    ========= */
    .notesGrid{
      display:grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap:10px;
      margin-top:10px;
    }
    @media (max-width: 520px){
      .notesGrid{grid-template-columns: 1fr;}
    }
    .note{
      background: linear-gradient(180deg,
        color-mix(in oklab, var(--warn) 16%, var(--panelSolid)),
        var(--panelSolid)
      );
      border:1px solid color-mix(in oklab, var(--warn) 20%, var(--line));
      border-radius: 16px;
      padding: 10px;
      box-shadow: 0 10px 20px rgba(0,0,0,.08);
      position:relative;
    }
    .note .stamp{
      font-size: 12px;
      color: var(--muted);
      font-weight: 900;
      margin-bottom: 6px;
      font-variant-numeric: tabular-nums;
    }
    .note .txt{
      white-space:pre-wrap;
      font-weight: 850;
      color: var(--ink);
    }
    .note .del{
      position:absolute;
      top:8px;
      right:8px;
      border:0;
      background: transparent;
      cursor:pointer;
      font-weight:1000;
      color: color-mix(in oklab, var(--danger) 70%, var(--ink));
    }

    /* =========
      CELEBRATION MODAL
    ========= */
    .modal{
      position:fixed;
      inset:0;
      display:none;
      align-items:center;
      justify-content:center;
      background: rgba(0,0,0,.35);
      z-index:60;
      padding: 16px;
    }
    .modal.open{display:flex;}
    .modalCard{
      width:min(520px, 96vw);
      background: var(--panelSolid);
      border:1px solid var(--line);
      border-radius: 22px;
      box-shadow: 0 20px 50px rgba(0,0,0,.25);
      padding: 14px;
      position:relative;
      overflow:hidden;
    }
    .modalCard h3{
      margin: 6px 0 6px;
      font-size: 18px;
      font-weight: 1000;
    }
    .modalCard p{
      margin:0 0 10px;
      color:var(--muted);
      font-weight:900;
      line-height:1.35;
    }

    /* =========
      CONFETTI CANVAS
    ========= */
    #confetti{
      position:fixed;
      inset:0;
      pointer-events:none;
      z-index:55;
    }

    /* =========
      FOCUS MODE (extra √©pur√©)
    ========= */
    .focus .stats,
    .focus .below{
      display:none !important;
    }
    .focus .panel{padding: 14px;}
    .focus .progressBox{margin-bottom: 10px;}
    .focus .miniMeta{display:none;}

    /* =========
      SMALL SCREEN TWEAKS
    ========= */
    @media (max-width: 520px){
      .topControls{gap:8px}
      .iconBtn{padding:9px 10px}
      .pill{padding:9px 10px}
      .miniMeta{min-width: 140px}
      .primary,.ghost,.danger{padding:11px 12px}
      .bar{height: 36px}
    }
  </style>
</head>

<body>
  <canvas id="confetti"></canvas>

  <div class="wrap" id="appRoot">
    <div class="topbar">
      <div class="brand">
        <h1>ELIMINATOR</h1>
        <p class="sub">D√©gomme toutes les t√¢ches. D√©gomme tous les √©thorions en cours.</p>
      </div>

      <div class="topControls">
        <div class="pill" title="Th√®me + modes d'affichage rapides">
          <span style="font-weight:1000; color:var(--muted);">Th√®me</span>
          <button id="btnLight" class="active" type="button">Clair</button>
          <button id="btnDark" type="button">Sombre</button>
        </div>

        <button class="iconBtn" id="btnFocus" type="button" title="Mode Focus (√©pure au maximum)">Focus</button>
        <button class="iconBtn" id="btnMenu" type="button" title="Menu">Menu</button>
        <button class="iconBtn" id="btnReset" type="button" title="Reset des t√¢ches (les notes restent)">Reset</button>
      </div>
    </div>

    <div class="panel" id="mainPanel">
      <div class="stats" id="stats">
        <div class="statLine" id="statLine">
          <span>üßπ <b id="tasksLeft">0</b>/<span id="tasksTotal">0</span> t√¢ches restantes</span>
          <span>‚õèÔ∏è <b id="ethLeft">0</b>/<span id="ethTotal">0</span> √©thorions restants</span>
          <span>üèÅ <b id="tasksDone">0</b> r√©alis√©es</span>
        </div>
        <div class="statLine">
          <span>‚è±Ô∏è <span class="timer" id="taskTimer">00:00</span></span>
        </div>
      </div>

      <div class="progressBox">
        <div class="bar" aria-label="Progression de la t√¢che">
          <div class="fill" id="progressFill"></div>
          <div class="pct" id="progressPct">0%</div>
        </div>
      </div>

      <div class="target">
        <p class="targetName" id="currentTitle">Aucune t√¢che. Nourris l‚ÄôInbox.</p>
        <div class="miniMeta" id="miniMeta">
          <div><span class="small">Estimation</span><br><span class="mono" id="estTime">‚Äî</span></div>
          <div class="small" id="estHint">bas√©e sur les √©thorions de d√©part</div>
        </div>
      </div>

      <div class="ethRow">
        <div class="ethTrack" title="Fragments (√©thorions) restants">
          <div class="ethFill" id="ethFill"></div>
        </div>
        <div class="ethActions">
          <button class="ghost btnSm" id="btnPin" type="button" title="√âpingler / prioriser">üìå Prioriser</button>
          <button class="ghost btnSm" id="btnDemote" type="button" title="Redescendre dans le pool">‚Ü©Ô∏é Pool</button>
          <button class="ghost btnSm" id="btnEditCurrent" type="button" title="√âditer le titre">‚úé √âditer</button>
          <button class="danger btnSm" id="btnDeleteCurrent" type="button" title="Supprimer la t√¢che">Supprimer</button>
          <button class="primary" id="btnSmash" type="button">D√©gommer 1 √©thorion</button>
          <button class="ghost" id="btnRoulette" type="button" title="Changer de cible (roulette)">Roulette üé∞</button>
        </div>
      </div>
    </div>
  </div>

  <!-- MENU OVERLAY -->
  <div class="overlay" id="overlay">
    <div class="drawer">
      <div class="row" style="align-items:flex-start; margin-bottom:6px;">
        <div>
          <h2 style="margin:0 0 4px;">Menu</h2>
          <div class="hint" style="margin:0;">Param√®tres utiles, sans redondance. Les notes survivent aux resets. ü™®</div>
        </div>
        <div class="right">
          <button class="ghost btnSm" id="btnCloseMenu" type="button">Fermer</button>
        </div>
      </div>

      <div class="tabs">
        <button class="tab active" data-tab="inbox" type="button">Inbox</button>
        <button class="tab" data-tab="list" type="button">Liste</button>
        <button class="tab" data-tab="notes" type="button">Notes</button>
        <button class="tab" data-tab="profil" type="button">Profil</button>
      </div>

      <!-- INBOX -->
      <div id="tab_inbox" class="tabPane">
        <div class="section">
          <div class="row">
            <label>Colle des t√¢ches (formats vari√©s accept√©s)</label>
            <div class="right">
              <button class="ghost btnSm" id="btnImport" type="button">Importer</button>
            </div>
          </div>
          <textarea id="inboxText" placeholder="Exemples :
- Appeler Hugo | cat=appels | eth=3
Appeler Samira (appels) [5]
‚Ä¢ 'Qui fonce' : Scanner les rendez-vous | eth 2
1) R√©diger rapport Mme Imbo - 6
"></textarea>
          <div class="hint">
            Reconna√Æt : puces, num√©ros, (cat√©gorie), cat=..., #cat, [eth], eth=..., ‚Äúqui fonce‚Äù.
            Si la cat√©gorie contient ‚Äúqui fonce‚Äù, elle va dans la cat√©gorie <b>qui fonce</b>.
          </div>
        </div>

        <div class="section">
          <div class="row">
            <label>Ajout rapide</label>
          </div>
          <div class="row">
            <div style="flex:1; min-width: 220px;">
              <input id="quickTitle" type="text" placeholder="Titre de t√¢che" />
            </div>
            <div style="width: 140px;">
              <input id="quickEth" type="number" min="1" value="1" />
              <div class="hint" style="margin:6px 0 0;">√©thorions</div>
            </div>
            <div style="width: 180px;">
              <input id="quickCat" type="text" placeholder="cat√©gorie (option)" />
            </div>
            <button class="ghost" id="btnQuickAdd" type="button">Ajouter</button>
          </div>
        </div>
      </div>

      <!-- LIST -->
      <div id="tab_list" class="tabPane" style="display:none;">
        <div class="section">
          <div class="row">
            <label>Tri</label>
            <div class="right">
              <select id="sortMode">
                <option value="roulette">Roulette (al√©atoire)</option>
                <option value="pinnedFirst">Prioris√©es d‚Äôabord</option>
                <option value="alpha">Alphab√©tique</option>
                <option value="chrono">Chronologie (ajout)</option>
                <option value="ethDesc">√âthorions (desc)</option>
              </select>
            </div>
          </div>
          <div class="hint">Le bouton ‚ÄúRoulette üé∞‚Äù respecte ce tri (sauf ‚Äúroulette‚Äù qui re-m√©lange).</div>
        </div>

        <div class="section">
          <div class="row">
            <label>Cat√©gories actives (pool en cours)</label>
          </div>
          <div id="catFilters" class="row" style="gap:8px; justify-content:flex-start;"></div>
          <div class="hint">D√©coche une cat√©gorie = elle dispara√Æt du pool ‚Äú√† d√©gomm(er)‚Äù.</div>
        </div>

        <div class="section">
          <div class="row">
            <label>Liste des t√¢ches</label>
            <div class="right">
              <button class="ghost btnSm" id="btnPickNow" type="button">Cibler maintenant</button>
            </div>
          </div>
          <div class="taskList" id="taskList"></div>
        </div>
      </div>

      <!-- NOTES -->
      <div id="tab_notes" class="tabPane" style="display:none;">
        <div class="section">
          <div class="row">
            <label>Ajouter une note (persistante, horodat√©e)</label>
            <div class="right">
              <button class="ghost btnSm" id="btnAddNote" type="button">Ajouter</button>
            </div>
          </div>
          <textarea id="noteText" placeholder="Pens√©e parasite, id√©e brillante, col√®re contre l‚Äôunivers, rappel doux‚Ä¶"></textarea>
          <div class="hint">Ces notes restent m√™me si tu fais Reset des t√¢ches.</div>
        </div>

        <div class="section">
          <div class="row">
            <label>Notes</label>
          </div>
          <div class="notesGrid" id="notesGrid"></div>
        </div>
      </div>

      <!-- PROFIL -->
      <div id="tab_profil" class="tabPane" style="display:none;">
        <div class="section">
          <div class="row">
            <label>Affichage</label>
          </div>
          <div class="row">
            <div style="flex:1; min-width: 220px;">
              <label style="display:block; margin-bottom:6px;">Mode</label>
              <select id="displayMode">
                <option value="normal">Normal (√©pur√©)</option>
                <option value="focus">Focus (ultra √©pur√©)</option>
              </select>
            </div>
            <div style="flex:1; min-width: 220px;">
              <label style="display:block; margin-bottom:6px;">C√©l√©brations</label>
              <select id="celebrateLevel">
                <option value="big">Maximal (absurde & conqu√©rant)</option>
                <option value="small">Minimal</option>
                <option value="off">Off</option>
              </select>
            </div>
          </div>
          <div class="hint">Pas de son. Les confettis, oui. Parce que la dignit√© est optionnelle.</div>
        </div>

        <div class="section">
          <div class="row">
            <label>Estimation</label>
          </div>
          <div class="row">
            <div style="flex:1; min-width: 220px;">
              <label style="display:block; margin-bottom:6px;">1 √©thorion = minutes</label>
              <input id="ethMinutes" type="number" min="1" value="5" />
              <div class="hint">Par d√©faut : 5 min. L‚Äôestimation affich√©e = √©thorions de d√©part √ó minutes.</div>
            </div>
            <div style="flex:1; min-width: 220px;">
              <label style="display:block; margin-bottom:6px;">Validation estimation</label>
              <select id="needValidate">
                <option value="no">Optionnelle (recommand√©)</option>
                <option value="yes">Obligatoire</option>
              </select>
              <div class="hint">Tu voulais que ce soit une option : c‚Äôest le d√©faut.</div>
            </div>
          </div>
        </div>

        <div class="section">
          <div class="row">
            <label>Danger zone (sans toucher aux notes)</label>
            <div class="right">
              <button class="danger" id="btnNukeTasks" type="button">Vider toutes les t√¢ches</button>
            </div>
          </div>
          <div class="hint">Les notes restent. Les t√¢ches‚Ä¶ vont au Valhalla.</div>
        </div>
      </div>
    </div>
  </div>

  <!-- CELEBRATION MODAL -->
  <div class="modal" id="celeModal" aria-hidden="true">
    <div class="modalCard">
      <h3 id="celeTitle">Gloire.</h3>
      <p id="celeText">Tu viens de terrasser un √©thorion. La l√©gende s‚Äô√©paissit.</p>
      <div style="display:flex; justify-content:flex-end; gap:10px;">
        <button class="ghost" id="btnCloseCele" type="button">OK, je continue.</button>
      </div>
    </div>
  </div>

<script>
/* =========================================================
   ELIMINATOR ‚Äî version √©pur√©e, focus, c√©l√©brations absurdes,
   notes persistantes, tri + filtres, √©dition synchronis√©e.
   ========================================================= */

(() => {
  const LS = {
    tasks: "ELIMINATOR_tasks_v2",
    done: "ELIMINATOR_done_v2",
    settings: "ELIMINATOR_settings_v2",
    notes: "ELIMINATOR_notes_v2",
    activeCats: "ELIMINATOR_activeCats_v2",
    currentId: "ELIMINATOR_currentId_v2",
    theme: "ELIMINATOR_theme_v2",
    timerStart: "ELIMINATOR_timerStart_v2",
    validated: "ELIMINATOR_validated_v2"
  };

  const $ = (id) => document.getElementById(id);

  const ui = {
    appRoot: $("appRoot"),
    mainPanel: $("mainPanel"),

    tasksLeft: $("tasksLeft"),
    tasksTotal: $("tasksTotal"),
    ethLeft: $("ethLeft"),
    ethTotal: $("ethTotal"),
    tasksDone: $("tasksDone"),
    taskTimer: $("taskTimer"),

    progressFill: $("progressFill"),
    progressPct: $("progressPct"),
    currentTitle: $("currentTitle"),
    estTime: $("estTime"),
    estHint: $("estHint"),
    ethFill: $("ethFill"),

    btnSmash: $("btnSmash"),
    btnRoulette: $("btnRoulette"),
    btnDeleteCurrent: $("btnDeleteCurrent"),
    btnPin: $("btnPin"),
    btnDemote: $("btnDemote"),
    btnEditCurrent: $("btnEditCurrent"),

    btnMenu: $("btnMenu"),
    btnCloseMenu: $("btnCloseMenu"),
    overlay: $("overlay"),

    btnReset: $("btnReset"),
    btnFocus: $("btnFocus"),

    btnLight: $("btnLight"),
    btnDark: $("btnDark"),

    // tabs
    tabs: Array.from(document.querySelectorAll(".tab")),
    panes: {
      inbox: $("tab_inbox"),
      list: $("tab_list"),
      notes: $("tab_notes"),
      profil: $("tab_profil")
    },

    // inbox
    inboxText: $("inboxText"),
    btnImport: $("btnImport"),
    quickTitle: $("quickTitle"),
    quickEth: $("quickEth"),
    quickCat: $("quickCat"),
    btnQuickAdd: $("btnQuickAdd"),

    // list
    sortMode: $("sortMode"),
    catFilters: $("catFilters"),
    taskList: $("taskList"),
    btnPickNow: $("btnPickNow"),

    // notes
    noteText: $("noteText"),
    btnAddNote: $("btnAddNote"),
    notesGrid: $("notesGrid"),

    // profil
    displayMode: $("displayMode"),
    celebrateLevel: $("celebrateLevel"),
    ethMinutes: $("ethMinutes"),
    needValidate: $("needValidate"),
    btnNukeTasks: $("btnNukeTasks"),

    // celebration
    celeModal: $("celeModal"),
    celeTitle: $("celeTitle"),
    celeText: $("celeText"),
    btnCloseCele: $("btnCloseCele"),

    // confetti
    confetti: $("confetti")
  };

  /* =======================
     STATE
  ======================= */
  const defaultSettings = {
    sortMode: "roulette",
    displayMode: "normal",
    celebrateLevel: "big", // big | small | off
    ethMinutes: 5,
    needValidate: "no" // no | yes
  };

  let tasks = loadJSON(LS.tasks, []);
  let doneCount = loadJSON(LS.done, 0);
  let notes = loadJSON(LS.notes, []);
  let settings = loadJSON(LS.settings, defaultSettings);
  let activeCats = loadJSON(LS.activeCats, null); // null => all active
  let currentId = localStorage.getItem(LS.currentId) || null;

  // theme default = light
  let theme = localStorage.getItem(LS.theme) || "light";
  applyTheme(theme);

  // apply settings to UI
  ui.sortMode.value = settings.sortMode || "roulette";
  ui.displayMode.value = settings.displayMode || "normal";
  ui.celebrateLevel.value = settings.celebrateLevel || "big";
  ui.ethMinutes.value = Number(settings.ethMinutes || 5);
  ui.needValidate.value = settings.needValidate || "no";

  applyDisplayMode(ui.displayMode.value);

  /* =======================
     UTILITIES
  ======================= */
  function loadJSON(key, fallback){
    try{
      const v = localStorage.getItem(key);
      if(v === null || v === undefined) return fallback;
      return JSON.parse(v);
    }catch(e){
      return fallback;
    }
  }
  function save(){
    localStorage.setItem(LS.tasks, JSON.stringify(tasks));
    localStorage.setItem(LS.done, JSON.stringify(doneCount));
    localStorage.setItem(LS.settings, JSON.stringify(settings));
    localStorage.setItem(LS.notes, JSON.stringify(notes));
    localStorage.setItem(LS.theme, theme);
    if(activeCats === null) localStorage.removeItem(LS.activeCats);
    else localStorage.setItem(LS.activeCats, JSON.stringify(activeCats));
    if(currentId) localStorage.setItem(LS.currentId, currentId);
    else localStorage.removeItem(LS.currentId);
  }

  function uid(){
    return Math.random().toString(16).slice(2) + Date.now().toString(16);
  }

  function clamp(n,min,max){ return Math.max(min, Math.min(max, n)); }

  function fmtTime(sec){
    sec = Math.max(0, Math.floor(sec));
    const m = String(Math.floor(sec/60)).padStart(2,'0');
    const s = String(sec%60).padStart(2,'0');
    return `${m}:${s}`;
  }

  function nowStamp(){
    const d = new Date();
    // format simple: YYYY-MM-DD HH:MM
    const pad = (x)=>String(x).padStart(2,'0');
    return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())} ${pad(d.getHours())}:${pad(d.getMinutes())}`;
  }

  function normalizeCat(cat){
    if(!cat) return "";
    cat = String(cat).trim();
    if(!cat) return "";
    // normalize spaces
    cat = cat.replace(/\s+/g,' ').toLowerCase();
    // special: "qui fonce"
    if(cat.includes("qui fonce")) return "qui fonce";
    return cat;
  }

  function parseLineToTask(line){
    // Accept many formats:
    // - Title | cat=xxx | eth=3
    // Title (cat) [5]
    // ‚Ä¢ 'Qui fonce' : Title | eth 2
    // 1) Title - 6
    // Title #cat [eth]
    let raw = line.trim();
    if(!raw) return null;

    // strip bullet/number prefixes
    raw = raw.replace(/^[-‚Ä¢*]+\s+/,'');
    raw = raw.replace(/^\d+[\)\.\-:]\s+/,'');
    raw = raw.replace(/^["'‚Äú‚Äù‚Äò‚Äô]\s*/,'').replace(/\s*["'‚Äú‚Äù‚Äò‚Äô]$/,'');

    let cat = "";
    let eth = null;

    // cat=...
    const catEq = raw.match(/(?:^|\s)cat\s*=\s*([^\|\#\[\]]+)/i);
    if(catEq){
      cat = catEq[1].trim();
      raw = raw.replace(catEq[0],'').trim();
    }

    // #cat
    const hashCat = raw.match(/(?:^|\s)#([a-zA-Z√Ä-√ø0-9 _-]+)/);
    if(hashCat){
      cat = hashCat[1].trim();
      raw = raw.replace(hashCat[0],'').trim();
    }

    // (cat)
    const parenCat = raw.match(/\(([^\)]+)\)/);
    if(parenCat && !cat){
      cat = parenCat[1].trim();
      raw = raw.replace(parenCat[0],'').trim();
    }

    // leading "'Qui fonce' :"
    const qf = raw.match(/^(?:qui\s*fonce|["'‚Äú‚Äù]?\s*qui\s*fonce\s*["'‚Äú‚Äù]?)\s*[:\-]\s*/i);
    if(qf){
      cat = "qui fonce";
      raw = raw.replace(qf[0],'').trim();
    }

    // eth= or eth :
    const ethEq = raw.match(/(?:^|\s)eth(?:orions?)?\s*(?:=|:)\s*(\d+)/i);
    if(ethEq){
      eth = parseInt(ethEq[1],10);
      raw = raw.replace(ethEq[0],'').trim();
    }

    // [n]
    const bracket = raw.match(/\[(\d+)\]/);
    if(bracket){
      eth = eth ?? parseInt(bracket[1],10);
      raw = raw.replace(bracket[0],'').trim();
    }

    // trailing "- n" or "| n" or "‚Äî n"
    const trailNum = raw.match(/(?:\s*(?:\||-|‚Äî|‚Äì)\s*)(\d+)\s*$/);
    if(trailNum && eth === null){
      eth = parseInt(trailNum[1],10);
      raw = raw.replace(trailNum[0],'').trim();
    }

    // "eth 3"
    const ethWord = raw.match(/(?:^|\s)eth(?:orions?)?\s+(\d+)\b/i);
    if(ethWord && eth === null){
      eth = parseInt(ethWord[1],10);
      raw = raw.replace(ethWord[0],'').trim();
    }

    const title = raw.replace(/\s+\|\s+/g,' ').trim();
    if(!title) return null;

    eth = clamp(Number.isFinite(eth) ? eth : 1, 1, 999);
    cat = normalizeCat(cat);

    return {
      id: uid(),
      title,
      cat,
      ethStart: eth,
      ethLeft: eth,
      pinned: false,
      createdAt: Date.now()
    };
  }

  function getAllCats(){
    const set = new Set();
    tasks.forEach(t => { if(t.cat) set.add(t.cat); });
    return Array.from(set).sort((a,b)=>a.localeCompare(b,'fr'));
  }

  function isCatActive(cat){
    if(activeCats === null) return true;
    if(!cat) return activeCats.includes("(sans cat√©gorie)");
    return activeCats.includes(cat);
  }

  function activePool(){
    return tasks.filter(t => {
      const c = t.cat ? t.cat : "(sans cat√©gorie)";
      return isCatActive(c);
    });
  }

  function sortTasks(arr){
    const mode = settings.sortMode || "roulette";
    if(mode === "roulette"){
      // shuffle copy
      const a = arr.slice();
      for(let i=a.length-1;i>0;i--){
        const j = Math.floor(Math.random()*(i+1));
        [a[i],a[j]] = [a[j],a[i]];
      }
      return a;
    }
    if(mode === "pinnedFirst"){
      return arr.slice().sort((x,y)=>{
        if(x.pinned !== y.pinned) return x.pinned ? -1 : 1;
        return x.createdAt - y.createdAt;
      });
    }
    if(mode === "alpha"){
      return arr.slice().sort((x,y)=> x.title.localeCompare(y.title,'fr'));
    }
    if(mode === "chrono"){
      return arr.slice().sort((x,y)=> x.createdAt - y.createdAt);
    }
    if(mode === "ethDesc"){
      return arr.slice().sort((x,y)=> y.ethLeft - x.ethLeft);
    }
    return arr;
  }

  function getCurrent(){
    if(!currentId) return null;
    return tasks.find(t => t.id === currentId) || null;
  }

  function ensureCurrent(){
    const pool = activePool();
    if(pool.length === 0){
      currentId = null;
      localStorage.removeItem(LS.timerStart);
      return null;
    }
    const cur = getCurrent();
    if(cur && pool.some(t => t.id === cur.id)) return cur;
    // pick a new one
    const pick = sortTasks(pool)[0];
    currentId = pick.id;
    startTaskTimer();
    return pick;
  }

  function startTaskTimer(){
    localStorage.setItem(LS.timerStart, String(Date.now()));
  }

  function resetTaskTimer(){
    localStorage.removeItem(LS.timerStart);
    localStorage.setItem(LS.timerStart, String(Date.now()));
  }

  function elapsedSec(){
    const s = localStorage.getItem(LS.timerStart);
    if(!s) return 0;
    const ms = Date.now() - Number(s);
    return Math.floor(ms/1000);
  }

  function totalEth(){
    return tasks.reduce((acc,t)=> acc + t.ethLeft, 0);
  }
  function totalEthStart(){
    return tasks.reduce((acc,t)=> acc + t.ethStart, 0);
  }

  function poolEthTotals(){
    const pool = activePool();
    const left = pool.reduce((a,t)=>a+t.ethLeft,0);
    const start = pool.reduce((a,t)=>a+t.ethStart,0);
    return {left,start};
  }

  function setThemeButtons(){
    ui.btnLight.classList.toggle("active", theme === "light");
    ui.btnDark.classList.toggle("active", theme === "dark");
  }

  function applyTheme(t){
    theme = (t === "dark") ? "dark" : "light";
    document.documentElement.setAttribute("data-theme", theme);
    setThemeButtons();
    save();
  }

  function applyDisplayMode(mode){
    settings.displayMode = mode;
    ui.appRoot.classList.toggle("focus", mode === "focus");
    ui.btnFocus.textContent = (mode === "focus") ? "Focus ‚úì" : "Focus";
    save();
  }

  /* =======================
     RENDER
  ======================= */
  function render(){
    // ensure current
    const cur = ensureCurrent();

    // top stats (pool-based, not global)
    const pool = activePool();
    const poolTotalTasks = pool.length;
    const totalTasksStart = poolTotalTasks; // pool snapshot: remaining only
    // we also show "restantes / d√©part" as overall tasks remaining / tasks initial.
    // For "d√©part", we store in validation snapshot? We'll compute from LS.validated if exists.
    const initial = loadJSON(LS.validated, null);

    const tasksRemaining = poolTotalTasks;
    const tasksInitial = initial?.tasksInitial ?? tasks.length; // fallback
    const ethT = poolEthTotals();
    const ethInitial = initial?.ethInitial ?? totalEthStart();

    ui.tasksLeft.textContent = String(tasksRemaining);
    ui.tasksTotal.textContent = String(tasksInitial);
    ui.ethLeft.textContent = String(ethT.left);
    ui.ethTotal.textContent = String(ethInitial);
    ui.tasksDone.textContent = String(doneCount);

    // timer
    ui.taskTimer.textContent = fmtTime(elapsedSec());

    // current
    if(!cur){
      ui.currentTitle.textContent = "Aucune t√¢che. Nourris l‚ÄôInbox.";
      ui.progressFill.style.width = "0%";
      ui.progressPct.textContent = "0%";
      ui.ethFill.style.width = "0%";
      ui.estTime.textContent = "‚Äî";
      ui.btnSmash.disabled = true;
      ui.btnRoulette.disabled = true;
      ui.btnDeleteCurrent.disabled = true;
      ui.btnPin.disabled = true;
      ui.btnDemote.disabled = true;
      ui.btnEditCurrent.disabled = true;
      ui.btnSmash.style.opacity = .6;
      ui.btnRoulette.style.opacity = .6;
      save();
      renderList();
      renderCatFilters();
      renderNotes();
      return;
    }

    ui.btnSmash.disabled = false;
    ui.btnRoulette.disabled = false;
    ui.btnDeleteCurrent.disabled = false;
    ui.btnPin.disabled = false;
    ui.btnDemote.disabled = false;
    ui.btnEditCurrent.disabled = false;
    ui.btnSmash.style.opacity = 1;
    ui.btnRoulette.style.opacity = 1;

    ui.currentTitle.textContent = cur.title;

    const pct = Math.round((1 - (cur.ethLeft / cur.ethStart)) * 100);
    ui.progressFill.style.width = `${clamp(pct,0,100)}%`;
    ui.progressPct.textContent = `${clamp(pct,0,100)}%`;

    const ethPct = Math.round((cur.ethLeft / cur.ethStart) * 100);
    ui.ethFill.style.width = `${clamp(ethPct,0,100)}%`;

    // estimation display based on ethStart * minutes
    const mins = Number(settings.ethMinutes || 5);
    const estMin = cur.ethStart * mins;
    const h = Math.floor(estMin / 60);
    const m = estMin % 60;
    ui.estTime.textContent = (h>0) ? `${h}h ${String(m).padStart(2,'0')}m` : `${m} min`;

    // pin button label
    ui.btnPin.textContent = cur.pinned ? "üìå Prioris√©e ‚úì" : "üìå Prioriser";

    save();
    renderList();
    renderCatFilters();
    renderNotes();
  }

  function renderCatFilters(){
    const cats = getAllCats();
    const withNone = ["(sans cat√©gorie)", ...cats];
    // init activeCats if null => all checked
    if(activeCats !== null){
      // keep only existing
      activeCats = activeCats.filter(c => withNone.includes(c));
      if(activeCats.length === 0) activeCats = null;
    }

    ui.catFilters.innerHTML = "";
    withNone.forEach(cat => {
      const id = "cat_" + cat.replace(/[^a-z0-9]/gi,'_');
      const wrap = document.createElement("div");
      wrap.style.display = "inline-flex";
      wrap.style.alignItems = "center";
      wrap.style.gap = "6px";
      wrap.style.padding = "8px 10px";
      wrap.style.border = "1px solid var(--line)";
      wrap.style.borderRadius = "999px";
      wrap.style.background = "var(--panelSolid)";
      wrap.style.fontWeight = "900";
      wrap.style.color = "var(--muted)";
      wrap.style.userSelect = "none";
      wrap.style.cursor = "pointer";

      const cb = document.createElement("input");
      cb.type = "checkbox";
      cb.id = id;
      cb.checked = (activeCats === null) ? true : activeCats.includes(cat);
      cb.style.accentColor = "var(--accent)";
      cb.addEventListener("change", () => {
        const all = withNone.slice();
        let selected = all.filter(c => document.getElementById("cat_" + c.replace(/[^a-z0-9]/gi,'_')).checked);
        if(selected.length === all.length){
          activeCats = null;
        }else{
          activeCats = selected;
        }
        // current might become invalid
        currentId = null;
        resetTaskTimer();
        save();
        render();
      });

      const span = document.createElement("span");
      span.textContent = cat;
      span.style.color = "var(--ink)";
      span.style.fontSize = "13px";

      wrap.appendChild(cb);
      wrap.appendChild(span);
      ui.catFilters.appendChild(wrap);
    });
  }

  function renderList(){
    ui.taskList.innerHTML = "";
    const pool = sortTasks(activePool());

    if(pool.length === 0){
      const empty = document.createElement("div");
      empty.className = "hint";
      empty.textContent = "Aucune t√¢che dans le pool actif (filtres ?).";
      ui.taskList.appendChild(empty);
      return;
    }

    pool.forEach(t => {
      const item = document.createElement("div");
      item.className = "taskItem";

      const info = document.createElement("div");
      info.className = "info";

      const title = document.createElement("div");
      title.className = "title";
      title.textContent = (t.id === currentId ? "‚ñ∂ " : "") + t.title;

      const meta = document.createElement("div");
      meta.className = "meta";
      const cat = t.cat ? t.cat : "(sans cat√©gorie)";
      meta.innerHTML = `<span>${t.pinned ? "üìå prioris√©e" : ""}</span><span>cat: <b style="color:var(--ink)">${cat}</b></span><span>eth: <b style="color:var(--ink)">${t.ethLeft}/${t.ethStart}</b></span>`;

      info.appendChild(title);
      info.appendChild(meta);

      const btns = document.createElement("div");
      btns.className = "taskBtns";

      // minimal buttons: delete, prioritize, edit
      const bPin = document.createElement("button");
      bPin.className = "ghost btnSm";
      bPin.type = "button";
      bPin.textContent = t.pinned ? "üìå" : "üìå";
      bPin.title = "Prioriser";
      bPin.addEventListener("click", () => {
        t.pinned = !t.pinned;
        save();
        render();
      });

      const bEdit = document.createElement("button");
      bEdit.className = "ghost btnSm";
      bEdit.type = "button";
      bEdit.textContent = "‚úé";
      bEdit.title = "√âditer";
      bEdit.addEventListener("click", () => editTaskTitle(t.id));

      const bDel = document.createElement("button");
      bDel.className = "danger btnSm";
      bDel.type = "button";
      bDel.textContent = "üóë";
      bDel.title = "Supprimer";
      bDel.addEventListener("click", () => {
        tasks = tasks.filter(x => x.id !== t.id);
        if(currentId === t.id) currentId = null;
        save();
        render();
      });

      item.addEventListener("click", (e) => {
        // clicking on buttons shouldn't retarget
        if(e.target.tagName.toLowerCase() === "button") return;
        currentId = t.id;
        resetTaskTimer();
        save();
        render();
      });

      btns.appendChild(bPin);
      btns.appendChild(bEdit);
      btns.appendChild(bDel);

      item.appendChild(info);
      item.appendChild(btns);
      ui.taskList.appendChild(item);
    });
  }

  function renderNotes(){
    ui.notesGrid.innerHTML = "";
    if(notes.length === 0){
      const empty = document.createElement("div");
      empty.className = "hint";
      empty.textContent = "Aucune note. Ton cerveau est calme ? Suspicious.";
      ui.notesGrid.appendChild(empty);
      return;
    }
    notes
      .slice()
      .sort((a,b)=> b.createdAt - a.createdAt)
      .forEach(n => {
        const card = document.createElement("div");
        card.className = "note";

        const del = document.createElement("button");
        del.className = "del";
        del.type = "button";
        del.textContent = "√ó";
        del.title = "Supprimer la note";
        del.addEventListener("click", () => {
          notes = notes.filter(x => x.id !== n.id);
          save();
          renderNotes();
        });

        const stamp = document.createElement("div");
        stamp.className = "stamp";
        stamp.textContent = n.stamp;

        const txt = document.createElement("div");
        txt.className = "txt";
        txt.textContent = n.text;

        card.appendChild(del);
        card.appendChild(stamp);
        card.appendChild(txt);
        ui.notesGrid.appendChild(card);
      });
  }

  /* =======================
     ACTIONS
  ======================= */
  function validateSnapshotIfNeeded(){
    // You asked: estimation validation should be optional.
    // If set to obligatory, we require snapshot once before smashing.
    if(settings.needValidate !== "yes") return true;

    const snap = loadJSON(LS.validated, null);
    if(snap) return true;

    // lightweight confirm
    const tasksInitial = tasks.length;
    const ethInitial = totalEthStart();
    localStorage.setItem(LS.validated, JSON.stringify({ tasksInitial, ethInitial, at: Date.now() }));
    return true;
  }

  function smashOne(){
    const cur = ensureCurrent();
    if(!cur) return;

    if(!validateSnapshotIfNeeded()) return;

    cur.ethLeft = clamp(cur.ethLeft - 1, 0, cur.ethStart);

    // celebration each eth smash
    celebrate("eth");

    // when task complete
    if(cur.ethLeft <= 0){
      doneCount += 1;
      tasks = tasks.filter(t => t.id !== cur.id);
      currentId = null;
      resetTaskTimer();
      celebrate("task");
    }

    save();
    render();
  }

  function roulettePick(){
    const pool = activePool();
    if(pool.length === 0) return;

    // show a tiny ‚Äúroulette‚Äù effect by rapidly switching currentId a few times
    const picks = sortTasks(pool);
    let i = 0;
    const spinCount = 10 + Math.floor(Math.random()*8);
    const interval = setInterval(() => {
      const t = picks[i % picks.length];
      currentId = t.id;
      ui.currentTitle.textContent = t.title;
      i++;
      if(i >= spinCount){
        clearInterval(interval);
        resetTaskTimer();
        save();
        render();
      }
    }, 55);
  }

  function deleteCurrent(){
    const cur = getCurrent();
    if(!cur) return;
    tasks = tasks.filter(t => t.id !== cur.id);
    currentId = null;
    resetTaskTimer();
    save();
    render();
  }

  function pinCurrent(){
    const cur = getCurrent();
    if(!cur) return;
    cur.pinned = !cur.pinned;
    save();
    render();
  }

  function demoteCurrent(){
    // "descendre dans le pool principal" => enlever la priorit√©
    const cur = getCurrent();
    if(!cur) return;
    cur.pinned = false;
    save();
    render();
  }

  function editTaskTitle(id){
    const t = tasks.find(x => x.id === id);
    if(!t) return;

    const next = prompt("Modifier le titre :", t.title);
    if(next === null) return;
    const cleaned = String(next).trim();
    if(!cleaned) return;

    t.title = cleaned;
    save();
    render();
  }

  function resetTasks(){
    // Reset should not kill notes
    // We'll clear tasks + validated snapshot + current, but keep doneCount (optional).
    // Keeping doneCount feels nice; user didn't ask to clear it.
    tasks = [];
    currentId = null;
    localStorage.removeItem(LS.validated);
    resetTaskTimer();
    save();
    render();
  }

  function nukeTasks(){
    tasks = [];
    currentId = null;
    localStorage.removeItem(LS.validated);
    resetTaskTimer();
    save();
    render();
  }

  function importInbox(){
    const text = ui.inboxText.value || "";
    const lines = text.split(/\r?\n/);
    const newTasks = [];
    for(const line of lines){
      const t = parseLineToTask(line);
      if(t) newTasks.push(t);
    }
    if(newTasks.length === 0) return;

    tasks = tasks.concat(newTasks);

    // update activeCats (keep user's selection, but add new cats as available)
    const cats = getAllCats();
    // if activeCats is null => all active anyway
    // if not null, keep selection; don't auto-enable new cats (user can tick)
    save();

    // auto set current if none
    if(!currentId){
      currentId = null;
      resetTaskTimer();
    }
    ui.inboxText.value = "";
    render();
  }

  function quickAdd(){
    const title = String(ui.quickTitle.value || "").trim();
    if(!title) return;
    const eth = clamp(parseInt(ui.quickEth.value || "1",10), 1, 999);
    const cat = normalizeCat(ui.quickCat.value || "");

    const t = {
      id: uid(),
      title,
      cat,
      ethStart: eth,
      ethLeft: eth,
      pinned: false,
      createdAt: Date.now()
    };
    tasks.push(t);
    ui.quickTitle.value = "";
    ui.quickEth.value = "1";
    ui.quickCat.value = "";
    save();
    render();
  }

  function addNote(){
    const txt = String(ui.noteText.value || "").trim();
    if(!txt) return;
    notes.push({ id: uid(), text: txt, createdAt: Date.now(), stamp: nowStamp() });
    ui.noteText.value = "";
    save();
    renderNotes();
  }

  /* =======================
     MENU / TABS
  ======================= */
  function openMenu(){
    ui.overlay.classList.add("open");
  }
  function closeMenu(){
    ui.overlay.classList.remove("open");
  }

  function setTab(name){
    ui.tabs.forEach(t => t.classList.toggle("active", t.dataset.tab === name));
    Object.keys(ui.panes).forEach(k => {
      ui.panes[k].style.display = (k === name) ? "" : "none";
    });
    if(name === "list"){
      renderCatFilters();
      renderList();
    }
    if(name === "notes"){
      renderNotes();
    }
  }

  /* =======================
     CELEBRATIONS + CONFETTI
  ======================= */
  const gloryBank = [
    "GLOIRE IMP√âRIALE.",
    "Victoire cosmique.",
    "√âthorion terrass√©. Le monde tremble.",
    "Tu viens de gagner un duel contre le temps. Et tu l‚Äôas humili√©.",
    "Frappe critique : productivit√© +12, chaos -7.",
    "La t√¢che a perdu. Tu as gagn√©. Science.",
    "Conqu√©rant(e) du minuscule. C‚Äôest exactement comme √ßa qu‚Äôon dompte l‚Äôinfini."
  ];
  const taskBank = [
    "T√ÇCHE D√âGOMM√âE.",
    "Un dragon administratif vient de tomber.",
    "Tu as r√©duit l‚Äôentropie. L‚Äôunivers te d√©teste un peu moins.",
    "C‚Äôest officiel : tu es une machine √† terminer."
  ];

  function celebrate(kind){
    const level = settings.celebrateLevel || "big";
    if(level === "off") return;

    // confetti always for big, minimal for small only on task
    const doConfetti = (level === "big") || (level === "small" && kind === "task");
    if(doConfetti) burstConfetti();

    if(level === "small" && kind === "eth") return;

    const title = (kind === "task") ? "GLORIEUX ACH√àVEMENT" : "GLORIEUX FRAGMENT";
    const text = (kind === "task")
      ? taskBank[Math.floor(Math.random()*taskBank.length)]
      : gloryBank[Math.floor(Math.random()*gloryBank.length)];

    ui.celeTitle.textContent = title;
    ui.celeText.textContent = text;
    ui.celeModal.classList.add("open");
    ui.celeModal.setAttribute("aria-hidden","false");
  }

  ui.btnCloseCele.addEventListener("click", () => {
    ui.celeModal.classList.remove("open");
    ui.celeModal.setAttribute("aria-hidden","true");
  });
  ui.celeModal.addEventListener("click", (e) => {
    if(e.target === ui.celeModal){
      ui.celeModal.classList.remove("open");
      ui.celeModal.setAttribute("aria-hidden","true");
    }
  });

  // Simple confetti engine (no libs)
  const ctx = ui.confetti.getContext("2d");
  let confettiParticles = [];
  function resizeCanvas(){
    ui.confetti.width = window.innerWidth * devicePixelRatio;
    ui.confetti.height = window.innerHeight * devicePixelRatio;
  }
  window.addEventListener("resize", resizeCanvas);
  resizeCanvas();

  function burstConfetti(){
    const count = 110;
    const w = ui.confetti.width;
    const h = ui.confetti.height;
    const cx = w/2, cy = h/5;

    for(let i=0;i<count;i++){
      confettiParticles.push({
        x: cx + (Math.random()*200-100),
        y: cy + (Math.random()*40-20),
        vx: (Math.random()*2-1) * 7,
        vy: (Math.random()*-1) * 10 - 6,
        g: 0.35 + Math.random()*0.12,
        r: 3 + Math.random()*4,
        a: 1,
        rot: Math.random()*Math.PI,
        vr: (Math.random()*2-1)*0.18,
        life: 70 + Math.random()*40
      });
    }
    // kick loop
    if(!animating) requestAnimationFrame(tickConfetti);
    animating = true;
  }

  let animating = false;
  function tickConfetti(){
    const w = ui.confetti.width;
    const h = ui.confetti.height;
    ctx.clearRect(0,0,w,h);

    confettiParticles = confettiParticles.filter(p => p.life > 0 && p.a > 0.01);

    for(const p of confettiParticles){
      p.vy += p.g;
      p.x += p.vx;
      p.y += p.vy;
      p.rot += p.vr;
      p.life -= 1;
      p.a = Math.min(1, p.life/80);

      // draw (no fixed colors; use theme-mixed random-ish via HSL)
      const hue = (p.x / w) * 360;
      ctx.save();
      ctx.globalAlpha = p.a;
      ctx.translate(p.x, p.y);
      ctx.rotate(p.rot);
      ctx.fillStyle = `hsl(${hue}, 85%, 60%)`;
      ctx.fillRect(-p.r, -p.r/2, p.r*2, p.r);
      ctx.restore();
    }

    if(confettiParticles.length > 0){
      requestAnimationFrame(tickConfetti);
    }else{
      animating = false;
      ctx.clearRect(0,0,w,h);
    }
  }

  /* =======================
     EVENTS
  ======================= */
  ui.btnSmash.addEventListener("click", smashOne);
  ui.btnRoulette.addEventListener("click", roulettePick);
  ui.btnDeleteCurrent.addEventListener("click", deleteCurrent);
  ui.btnPin.addEventListener("click", pinCurrent);
  ui.btnDemote.addEventListener("click", demoteCurrent);
  ui.btnEditCurrent.addEventListener("click", () => {
    const cur = getCurrent();
    if(cur) editTaskTitle(cur.id);
  });

  ui.btnMenu.addEventListener("click", openMenu);
  ui.btnCloseMenu.addEventListener("click", closeMenu);
  ui.overlay.addEventListener("click", (e) => { if(e.target === ui.overlay) closeMenu(); });

  ui.btnReset.addEventListener("click", () => {
    // reset tasks only (notes remain)
    resetTasks();
  });

  ui.btnFocus.addEventListener("click", () => {
    const next = (settings.displayMode === "focus") ? "normal" : "focus";
    ui.displayMode.value = next;
    applyDisplayMode(next);
    render();
  });

  ui.btnLight.addEventListener("click", () => applyTheme("light"));
  ui.btnDark.addEventListener("click", () => applyTheme("dark"));

  ui.tabs.forEach(t => t.addEventListener("click", () => setTab(t.dataset.tab)));

  ui.btnImport.addEventListener("click", importInbox);
  ui.btnQuickAdd.addEventListener("click", quickAdd);

  ui.btnPickNow.addEventListener("click", () => {
    currentId = null;
    resetTaskTimer();
    save();
    render();
    closeMenu();
  });

  ui.btnAddNote.addEventListener("click", addNote);

  ui.sortMode.addEventListener("change", () => {
    settings.sortMode = ui.sortMode.value;
    save();
    render();
  });

  ui.displayMode.addEventListener("change", () => {
    applyDisplayMode(ui.displayMode.value);
    render();
  });

  ui.celebrateLevel.addEventListener("change", () => {
    settings.celebrateLevel = ui.celebrateLevel.value;
    save();
  });

  ui.ethMinutes.addEventListener("change", () => {
    settings.ethMinutes = clamp(parseInt(ui.ethMinutes.value || "5",10), 1, 120);
    ui.ethMinutes.value = settings.ethMinutes;
    save();
    render();
  });

  ui.needValidate.addEventListener("change", () => {
    settings.needValidate = ui.needValidate.value;
    // if switching to obligatory and no snapshot, we'll take it on first smash
    save();
  });

  ui.btnNukeTasks.addEventListener("click", () => {
    nukeTasks();
  });

  // keyboard niceties
  document.addEventListener("keydown", (e) => {
    if(e.key === "Escape"){
      closeMenu();
      ui.celeModal.classList.remove("open");
      ui.celeModal.setAttribute("aria-hidden","true");
    }
  });

  // update timer every second
  setInterval(() => {
    ui.taskTimer.textContent = fmtTime(elapsedSec());
  }, 1000);

  // init validated snapshot if optional mode: still nice to have stable denominators
  if(settings.needValidate !== "yes"){
    // keep existing snapshot if present; else create when there are tasks
    const snap = loadJSON(LS.validated, null);
    if(!snap && tasks.length > 0){
      localStorage.setItem(LS.validated, JSON.stringify({
        tasksInitial: tasks.length,
        ethInitial: totalEthStart(),
        at: Date.now()
      }));
    }
  }

  // initial timer start
  if(!localStorage.getItem(LS.timerStart)) startTaskTimer();

  // initial render
  render();

})();
</script>
</body>
</html>
