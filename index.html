<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>ELIMINATOR</title>

  <style>
    /* =========================
       THEME (minimal glass)
       ========================= */
    :root{
      --bg:#0f1218;
      --fg:#e9edf5;
      --muted:#a8b0bd;
      --line:rgba(255,255,255,.12);
      --glass:rgba(18,22,30,.62);
      --glass2:rgba(18,22,30,.40);
      --shadow: 0 18px 60px rgba(0,0,0,.45);
      --blur: blur(14px);

      /* accents: only 2, subtle */
      --accent:#8fd3ff;     /* light-blue */
      --accent2:#7cffc7;    /* mint */

      --radius:22px;
      --radius2:28px;

      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;

      --barH: 54px;         /* big bar thickness */
      --ethH: 18px;         /* eth bar thickness */

      --centerMax: 920px;
    }

    [data-theme="light"]{
      --bg:#f5f7fb;
      --fg:#0d1323;
      --muted:#5c667a;
      --line:rgba(13,19,35,.14);
      --glass:rgba(255,255,255,.66);
      --glass2:rgba(255,255,255,.42);
      --shadow: 0 18px 60px rgba(10,16,30,.16);
      --accent:#2a67ff;
      --accent2:#16c784;
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      font-family:var(--sans);
      background:
        radial-gradient(1200px 800px at 10% -10%, rgba(42,103,255,.10), transparent 55%),
        radial-gradient(1000px 700px at 90% 0%, rgba(22,199,132,.10), transparent 55%),
        var(--bg);
      color:var(--fg);
      overflow-x:hidden;
    }

    /* =========================
       Layout
       ========================= */
    .wrap{
      max-width: var(--centerMax);
      margin: 0 auto;
      padding: 18px 14px 40px;
      display:flex;
      flex-direction:column;
      align-items:center;     /* center everything */
      gap: 14px;
    }

    .topRow{
      width:100%;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
    }

    .group{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; }

    .btn{
      border:1px solid var(--line);
      background: var(--glass);
      backdrop-filter: var(--blur);
      -webkit-backdrop-filter: var(--blur);
      color: var(--fg);
      border-radius: 999px;
      padding: 10px 12px;
      font-weight: 800;
      cursor:pointer;
      user-select:none;
      box-shadow: 0 10px 30px rgba(0,0,0,.08);
      transition: transform .08s ease, background .2s ease, border-color .2s ease;
    }
    .btn:active{ transform: translateY(1px) scale(.99); }
    .btn.small{ padding: 8px 10px; font-weight: 800; box-shadow:none; background:var(--glass2); }
    .btn.ghost{ background:transparent; box-shadow:none; }
    .btn.primary{
      border-color: color-mix(in oklab, var(--accent) 55%, var(--line));
      background: color-mix(in oklab, var(--accent) 10%, var(--glass));
    }

    .toggle{
      display:inline-flex;
      border:1px solid var(--line);
      border-radius:999px;
      overflow:hidden;
      background:var(--glass);
      backdrop-filter: var(--blur);
      -webkit-backdrop-filter: var(--blur);
      box-shadow: 0 10px 30px rgba(0,0,0,.08);
    }
    .toggle button{
      border:0;
      background:transparent;
      color:var(--muted);
      padding: 9px 12px;
      cursor:pointer;
      font-weight: 900;
    }
    .toggle button.active{
      color:var(--fg);
      background: color-mix(in oklab, var(--accent) 12%, transparent);
    }

    .hud{
      border:1px solid var(--line);
      background:var(--glass);
      backdrop-filter: var(--blur);
      -webkit-backdrop-filter: var(--blur);
      border-radius:999px;
      padding: 9px 12px;
      box-shadow: 0 10px 30px rgba(0,0,0,.08);
      display:flex;
      gap: 14px;
      align-items:center;
      font-family: var(--mono);
      font-size: 12px;
      color: var(--muted);
      white-space:nowrap;
    }
    .hud b{ color: var(--fg); font-weight: 900; }

    .titleBlock{
      width:100%;
      display:flex;
      flex-direction:column;
      align-items:center;
      text-align:center;
      gap: 6px;
      margin-top: 2px;
    }
    .title{
      margin:0;
      font-weight: 950;
      letter-spacing: .6px;
      font-size: clamp(44px, 6.2vw, 86px);
      line-height: .95;
      text-shadow: 0 14px 40px rgba(0,0,0,.14);
    }
    .subtitle{
      margin:0;
      color: var(--muted);
      font-weight: 850;
      letter-spacing: .2px;
    }

    /* =========================
       Main blocks
       ========================= */
    .block{
      width:100%;
      border:1px solid var(--line);
      border-radius: var(--radius2);
      background: var(--glass);
      backdrop-filter: var(--blur);
      -webkit-backdrop-filter: var(--blur);
      box-shadow: var(--shadow);
      padding: 16px;
    }

    /* Big progress bar block (distinct) */
    .barTrack{
      height: var(--barH);
      border-radius: 999px;
      border:1px solid color-mix(in oklab, var(--line) 90%, transparent);
      background: color-mix(in oklab, var(--line) 25%, transparent);
      overflow:hidden;
      position:relative;
    }
    .barFill{
      height:100%;
      width:100%;
      transform-origin:left center;
      transform: scaleX(1);
      background: linear-gradient(90deg,
        color-mix(in oklab, var(--accent) 70%, transparent),
        color-mix(in oklab, var(--accent2) 55%, transparent)
      );
      transition: transform .18s ease;
    }
    .barPct{
      position:absolute;
      inset:0;
      display:flex;
      align-items:center;
      justify-content:center;
      font-family: var(--mono);
      font-weight: 950;
      letter-spacing: .6px;
      color: rgba(255,255,255,.92);
      text-shadow: 0 10px 30px rgba(0,0,0,.35);
      pointer-events:none;
      mix-blend-mode: normal;
    }
    [data-theme="light"] .barPct{
      color: rgba(255,255,255,.95);
      text-shadow: 0 12px 30px rgba(0,0,0,.32);
    }

    /* Task block */
    .taskName{
      margin: 0;
      text-align:center;
      font-size: clamp(18px, 2.8vw, 28px);
      font-weight: 950;
      letter-spacing: .2px;
    }

    .taskSub{
      margin-top: 10px;
      display:flex;
      gap: 10px;
      justify-content:center;
      flex-wrap:wrap;
      color: var(--muted);
      font-family: var(--mono);
      font-size: 12px;
    }
    .pill{
      border:1px solid var(--line);
      border-radius:999px;
      padding: 7px 10px;
      background: var(--glass2);
    }

    /* Etherions bar */
    .ethBox{
      margin-top: 14px;
      border:1px solid var(--line);
      border-radius: var(--radius);
      background: var(--glass2);
      padding: 12px;
    }
    .ethTop{
      display:flex;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
      margin-bottom: 10px;
      font-family: var(--mono);
      font-size: 12px;
      color: var(--muted);
    }
    .ethTop b{ color: var(--fg); }
    .ethTrack{
      height: var(--ethH);
      border-radius: 999px;
      border:1px solid color-mix(in oklab, var(--line) 90%, transparent);
      background: color-mix(in oklab, var(--line) 25%, transparent);
      overflow:hidden;
      position:relative;
    }
    .ethFill{
      height:100%;
      width:100%;
      transform-origin:left center;
      transform: scaleX(1);
      background: linear-gradient(90deg,
        color-mix(in oklab, var(--accent) 55%, transparent),
        color-mix(in oklab, var(--accent2) 45%, transparent)
      );
      transition: transform .18s ease;
    }
    .ethTicks{
      position:absolute;
      inset:0;
      display:flex;
      opacity:.65;
      pointer-events:none;
    }
    .ethTicks span{
      flex:1;
      border-right:1px dashed rgba(255,255,255,.22);
    }
    [data-theme="light"] .ethTicks span{
      border-right:1px dashed rgba(13,19,35,.14);
    }

    /* Actions */
    .actionRow{
      margin-top: 16px;
      display:flex;
      gap: 14px;
      justify-content:center;
      align-items:center;
      flex-wrap:wrap;
    }

    /* Big roulette */
    .rouletteBtn{
      width: 112px;
      height: 112px;
      border-radius: 26px;
      border:1px solid var(--line);
      background: var(--glass);
      backdrop-filter: var(--blur);
      -webkit-backdrop-filter: var(--blur);
      box-shadow: 0 18px 50px rgba(0,0,0,.16);
      cursor:pointer;
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      gap: 8px;
      user-select:none;
    }
    .rouletteWheel{
      width: 56px;
      height: 56px;
      border-radius: 999px;
      border:2px solid color-mix(in oklab, var(--accent) 55%, var(--line));
      background:
        conic-gradient(
          from 0deg,
          color-mix(in oklab, var(--accent) 26%, transparent),
          color-mix(in oklab, var(--accent2) 24%, transparent),
          color-mix(in oklab, var(--accent) 26%, transparent)
        );
      box-shadow: inset 0 0 0 2px rgba(255,255,255,.10);
      transform: rotate(0deg);
    }
    .rouletteBtn.spinning .rouletteWheel{
      animation: spin 900ms cubic-bezier(.2,.8,.2,1);
    }
    @keyframes spin{
      0%{ transform: rotate(0deg); }
      100%{ transform: rotate(1080deg); }
    }
    .rouletteLabel{
      font-family: var(--mono);
      font-weight: 950;
      letter-spacing:.6px;
      color: var(--muted);
      font-size: 12px;
      text-transform: uppercase;
    }

    /* Smash button */
    .smashBtn{
      border:1px solid color-mix(in oklab, var(--accent) 55%, var(--line));
      background: color-mix(in oklab, var(--accent) 8%, var(--glass));
      border-radius: 26px;
      padding: 18px 22px;
      font-weight: 950;
      letter-spacing: .2px;
      cursor:pointer;
      box-shadow: 0 18px 50px rgba(0,0,0,.16);
      user-select:none;
      display:flex;
      align-items:center;
      gap: 10px;
      font-size: 18px;
    }
    .smashBtn:active{ transform: translateY(1px); }

    /* Bottom quick bar (menu + note) */
    .bottomBar{
      margin-top: 14px;
      display:flex;
      justify-content:center;
      gap: 10px;
      flex-wrap:wrap;
    }

    /* =========================
       Drawer (left, hideable)
       ========================= */
    .drawerOverlay{
      position:fixed;
      inset:0;
      background: rgba(0,0,0,.25);
      display:none;
      z-index:60;
    }
    [data-theme="light"] .drawerOverlay{ background: rgba(0,0,0,.12); }
    .drawerOverlay.show{ display:block; }

    .drawer{
      position:fixed;
      top:0;
      left:0;
      height:100%;
      width: min(420px, 88vw);
      background: var(--glass);
      backdrop-filter: var(--blur);
      -webkit-backdrop-filter: var(--blur);
      border-right:1px solid var(--line);
      box-shadow: var(--shadow);
      transform: translateX(-102%);
      transition: transform .22s ease;
      z-index:70;
      display:flex;
      flex-direction:column;
    }
    .drawerOverlay.show .drawer{
      transform: translateX(0);
    }

    .drawerTop{
      padding: 14px 14px 10px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      border-bottom:1px solid var(--line);
    }

    .drawerTabs{
      padding: 10px 14px 0;
      display:flex;
      gap:8px;
      flex-wrap:wrap;
    }
    .tab{
      border:1px solid var(--line);
      background: var(--glass2);
      border-radius: 999px;
      padding: 8px 10px;
      font-weight: 900;
      color: var(--muted);
      cursor:pointer;
      user-select:none;
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: .6px;
      font-family: var(--mono);
    }
    .tab.active{
      color: var(--fg);
      border-color: color-mix(in oklab, var(--accent) 55%, var(--line));
      background: color-mix(in oklab, var(--accent) 10%, var(--glass2));
    }

    .drawerBody{
      padding: 12px 14px 16px;
      overflow:auto;
    }

    .card{
      border:1px solid var(--line);
      border-radius: var(--radius);
      background: var(--glass2);
      padding: 12px;
      margin-bottom: 12px;
    }
    .cardTitle{
      margin:0 0 10px;
      font-weight: 950;
      letter-spacing:.2px;
    }

    textarea, input, select{
      width:100%;
      border:1px solid var(--line);
      background: color-mix(in oklab, var(--glass) 70%, transparent);
      color: var(--fg);
      border-radius: 16px;
      padding: 10px 12px;
      outline:none;
      font-family: var(--sans);
    }
    textarea{ min-height: 130px; resize: vertical; }

    .row{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
    }
    .row > *{ flex:1; min-width: 140px; }

    .help{
      color: var(--muted);
      font-size: 12px;
      line-height: 1.35;
      font-family: var(--mono);
    }

    /* List items (minimal icons in list) */
    .taskItem{
      border:1px solid var(--line);
      background: color-mix(in oklab, var(--glass) 60%, transparent);
      border-radius: 18px;
      padding: 10px 10px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      margin-bottom: 8px;
    }
    .taskLeft .name{
      font-weight: 950;
      line-height: 1.15;
    }
    .taskLeft .sub{
      margin-top: 3px;
      font-family: var(--mono);
      font-size: 12px;
      color: var(--muted);
    }
    .taskAct{
      display:flex;
      gap: 8px;
      align-items:center;
      flex-wrap:wrap;
    }
    .iconBtn{
      border:1px solid var(--line);
      background: var(--glass2);
      border-radius: 14px;
      padding: 8px 10px;
      cursor:pointer;
      font-weight: 950;
      font-family: var(--mono);
      font-size: 12px;
      color: var(--fg);
      user-select:none;
    }
    .iconBtn:active{ transform: translateY(1px); }

    /* Notes */
    .noteGrid{
      display:grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 10px;
    }
    .note{
      border:1px solid var(--line);
      border-radius: 18px;
      background: color-mix(in oklab, var(--glass2) 85%, transparent);
      padding: 12px;
    }
    .note .stamp{
      font-family: var(--mono);
      font-size: 11px;
      color: var(--muted);
      margin-bottom: 8px;
    }
    .note .txt{
      white-space: pre-wrap;
      font-weight: 800;
    }

    /* Habits */
    .habitItem{
      border:1px solid var(--line);
      border-radius: 18px;
      background: color-mix(in oklab, var(--glass) 60%, transparent);
      padding: 10px;
      margin-bottom: 10px;
    }
    .habitTop{
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap:10px;
    }
    .habitName{
      font-weight: 950;
      margin:0;
    }
    .habitMeta{
      font-family: var(--mono);
      color: var(--muted);
      font-size: 12px;
      white-space:nowrap;
    }
    .habitChecks{
      margin-top: 10px;
      display:flex;
      gap: 8px;
      flex-wrap:wrap;
    }
    .check{
      width: 22px;
      height: 22px;
      border-radius: 6px;
      border:1px solid var(--line);
      background: var(--glass2);
      cursor:pointer;
      display:grid;
      place-items:center;
      user-select:none;
      font-family: var(--mono);
      font-weight: 950;
      color: var(--fg);
    }
    .check.on{
      background: color-mix(in oklab, var(--accent) 12%, var(--glass2));
      border-color: color-mix(in oklab, var(--accent) 40%, var(--line));
    }

    /* =========================
       Celebration full-screen
       ========================= */
    .celebrateOverlay{
      position:fixed;
      inset:0;
      display:none;
      z-index:90;
      background: rgba(0,0,0,.24);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
    }
    [data-theme="light"] .celebrateOverlay{ background: rgba(0,0,0,.10); }
    .celebrateOverlay.show{ display:block; }

    .celebrateBox{
      position:absolute;
      inset: 0;
      display:flex;
      align-items:center;
      justify-content:center;
      padding: 18px;
    }
    .celebrateCard{
      width: min(760px, 92vw);
      border:1px solid var(--line);
      border-radius: 34px;
      background: var(--glass);
      backdrop-filter: var(--blur);
      -webkit-backdrop-filter: var(--blur);
      box-shadow: var(--shadow);
      padding: 26px 22px;
      text-align:center;
    }
    .celebrateTitle{
      margin:0;
      font-size: clamp(28px, 4.2vw, 52px);
      font-weight: 980;
      letter-spacing: .6px;
      line-height: 1.02;
    }
    .celebrateSub{
      margin: 12px 0 0;
      font-family: var(--mono);
      color: var(--muted);
      font-size: 14px;
      font-weight: 850;
      letter-spacing: .3px;
    }
    .celebrateHint{
      margin: 18px 0 0;
      font-family: var(--mono);
      color: var(--muted);
      font-size: 12px;
    }

    /* =========================
       Focus mode (hard minimal)
       ========================= */
    [data-focus="1"] .topRow{ display:none; }
    [data-focus="1"] .subtitle{ display:none; }
    [data-focus="1"] .taskSub{ display:none; }
    [data-focus="1"] .ethBox{ display:none; }
    [data-focus="1"] .bottomBar{ display:none; }
    [data-focus="1"] .focusExit{
      display:flex;
      justify-content:center;
      margin-top: 14px;
    }
    .focusExit{ display:none; }

    /* Mobile tightening */
    @media (max-width: 480px){
      :root{ --barH: 50px; }
      .hud{ gap: 10px; }
      .rouletteBtn{ width: 104px; height: 104px; }
      .rouletteWheel{ width: 52px; height: 52px; }
      .smashBtn{ width:100%; justify-content:center; }
      .topRow{ justify-content:center; }
    }
  </style>
</head>

<body data-theme="light" data-focus="0">
  <div class="celebrateOverlay" id="celebrateOverlay" aria-hidden="true">
    <div class="celebrateBox">
      <div class="celebrateCard">
        <h2 class="celebrateTitle" id="celebrateTitle">VICTOIRE ABSURDE</h2>
        <p class="celebrateSub" id="celebrateSub">+1 √©thorion d√©gomm√©</p>
        <p class="celebrateHint">Clique n‚Äôimporte o√π pour revenir.</p>
      </div>
    </div>
  </div>

  <!-- Drawer -->
  <div class="drawerOverlay" id="drawerOverlay">
    <aside class="drawer" role="dialog" aria-modal="true">
      <div class="drawerTop">
        <button class="btn small" id="btnDrawerClose">Fermer</button>
        <div class="toggle" title="Th√®me">
          <button id="themeLight" class="active">Clair</button>
          <button id="themeDark">Sombre</button>
        </div>
      </div>

      <div class="drawerTabs" id="drawerTabs"></div>

      <div class="drawerBody">
        <!-- panels injected by JS -->
        <div id="drawerPanels"></div>
      </div>
    </aside>
  </div>

  <div class="wrap">
    <div class="topRow">
      <div class="group">
        <button class="btn" id="btnMenu">Menu</button>
        <button class="btn" id="btnReset">Reset</button>
        <button class="btn" id="btnFocus">Focus</button>
      </div>

      <div class="group">
        <div class="hud" id="hud">
          <span>T√¢ches <b id="hudTasks">0/0</b></span>
          <span>√âthorions <b id="hudEth">0/0</b></span>
          <span>Faits <b id="hudDone">0</b></span>
          <span>Temps <b id="hudTimer">00:00</b></span>
        </div>
      </div>
    </div>

    <div class="titleBlock">
      <h1 class="title">ELIMINATOR</h1>
      <p class="subtitle">D√©gomme toutes les t√¢ches ‚Ä¢ D√©gomme tous les √©thorions en cours</p>
    </div>

    <!-- Big progress bar (distinct block) -->
    <section class="block" aria-label="Barre de progression globale">
      <div class="barTrack">
        <div class="barFill" id="bigFill"></div>
        <div class="barPct" id="bigPct">100%</div>
      </div>
    </section>

    <!-- Task block -->
    <section class="block" aria-label="T√¢che en cours">
      <h2 class="taskName" id="taskName">Aucune t√¢che</h2>

      <div class="taskSub" id="taskSub">
        <div class="pill" id="metaCat">Cat ‚Äî</div>
        <div class="pill" id="metaEst">Estim√© ‚Äî</div>
      </div>

      <div class="ethBox" id="ethBox">
        <div class="ethTop">
          <div>√âthorions <b id="ethNow">0</b>/<b id="ethStart">0</b></div>
          <div>Temps restant <b id="ethMinutes">0</b> min</div>
        </div>
        <div class="ethTrack">
          <div class="ethFill" id="ethFill"></div>
          <div class="ethTicks" id="ethTicks"></div>
        </div>
      </div>

      <div class="actionRow">
        <button class="rouletteBtn" id="btnRoulette" aria-label="Roulette">
          <div class="rouletteWheel" id="rouletteWheel"></div>
          <div class="rouletteLabel">ROULETTE</div>
        </button>

        <button class="smashBtn" id="btnSmash" aria-label="D√©gommer un √©thorion">
          <span>üß®</span>
          <span>D√©gommer 1 √©thorion</span>
        </button>
      </div>

      <div class="bottomBar">
        <button class="btn small" id="btnBottomMenu">Menu</button>
        <button class="btn small" id="btnBottomNote">Note</button>
        <button class="btn small ghost" id="btnBottomFocus">Focus</button>
      </div>

      <div class="focusExit" id="focusExit">
        <button class="btn primary" id="btnExitFocus">Quitter Focus</button>
      </div>
    </section>
  </div>

  <script>
  (() => {
    /* =========================
       Storage keys
       ========================= */
    const K = {
      state: "ELIMINATOR_STATE_V3",
      settings: "ELIMINATOR_SETTINGS_V3",
      notes: "ELIMINATOR_NOTES_V3",
      history: "ELIMINATOR_HISTORY_V3",
      kiff: "ELIMINATOR_KIFF_V3",
      habits: "ELIMINATOR_HABITS_V3"
    };

    /* =========================
       Tabs (drawer)
       (We keep your big list, but grouped/clean)
       ========================= */
    const TAB_DEFS = [
      { key:"inbox",    label:"Inbox" },
      { key:"liste",    label:"Liste" },
      { key:"kiff",     label:"Kiffance" },
      { key:"notes",    label:"Notes" },
      { key:"habits",   label:"Suivi des habitudes" },
      { key:"hist",     label:"Historique" },
      { key:"rapport",  label:"Rapport" },
      { key:"params",   label:"Param" }
    ];

    /* =========================
       Defaults
       ========================= */
    const DEFAULTS = {
      theme: "light",
      focus: 0,
      ethMinutesPer: 5,
      sortMode: "roulette",         // roulette | order | alpha | chrono
      activeCats: null,             // null => all active
      showMeta: 1,                  // can be used later (display modes)
      showTimeRemaining: 1,
      showCategory: 1
    };

    const DEFAULT_KIFF = {
      celebrations: [
        "TRIOMPHE ABSURDE. L‚ÄôHISTOIRE TE REGARDE.",
        "VICTOIRE IMP√âRIALE. LA LISTE A PEUR.",
        "CONQU√äTE TOTALE. LA PRODUCTIVIT√â PLEURE DE JOIE.",
        "TU ES UN CONQUISTADOR DU QUOTIDIEN.",
        "R√àGNE ABSOLU. LES T√ÇCHES SE RENDENT SANS CONDITIONS.",
        "D√âMOLITION NOBLE. ON T‚ÄôINSCRIT DANS LA L√âGENDE.",
        "GLOIRE. HONNEUR. ET UN BRIN DE D√âMESURE.",
        "C‚ÄôEST TROP EFFICACE POUR √äTRE L√âGAL (MAIS ON NE DIT RIEN).",
        "LE CHAOS RECULE. TU AVANCES. MAGISTRAL.",
        "TON NOM SERA CHUCHOT√â PAR LES CHECKLISTS ANCIENNES."
      ],
      encouragements: [
        "Un pas, une brique. Un √©thorion, un empire.",
        "Tu n‚Äôes pas en retard. Tu es en conqu√™te.",
        "La t√¢che r√©siste ? Parfait. Tu aussi.",
        "Simple, net, efficace. Comme un laser.",
        "Un √©thorion de moins, et le monde s‚Äôam√©liore."
      ],
      encouragementFrequencyMin: 0   // 0 = off (option)
    };

    const DEFAULT_HABITS = {
      slots: 8,                      // number of checkboxes per habit per day
      habits: [
        // {id, name, createdAt}
      ],
      marksByDay: {
        // "YYYY-MM-DD": { [habitId]: [0/1,...] }
      }
    };

    /* =========================
       Utils
       ========================= */
    const uid = () => Math.random().toString(16).slice(2) + "-" + Date.now().toString(16);
    const nowISO = () => new Date().toISOString();
    const todayKey = () => new Date().toISOString().slice(0,10);
    const clamp = (n,a,b) => Math.max(a, Math.min(b, n));
    const fmtMMSS = (ms) => {
      const s = Math.floor(ms/1000);
      const m = Math.floor(s/60);
      const r = s % 60;
      return String(m).padStart(2,"0")+":"+String(r).padStart(2,"0");
    };
    const escapeHTML = (s)=>String(s).replace(/[&<>"']/g, m=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;" }[m]));

    function loadJSON(key, fallback){
      try{
        const raw = localStorage.getItem(key);
        if(!raw) return fallback;
        return JSON.parse(raw);
      }catch(e){ return fallback; }
    }
    function saveJSON(key, val){ localStorage.setItem(key, JSON.stringify(val)); }

    /* =========================
       State
       ========================= */
    let settings = { ...DEFAULTS, ...(loadJSON(K.settings, null) || {}) };

    // Tasks:
    // task: {id, title, cat, ethStart, ethLeft, createdAt, pinned, doneAt?}
    // state: { tasks:[], done:[], currentId, startCounts:{tasks,eth}, timer:{taskId, elapsedMs, running} }
    let state = loadJSON(K.state, null);
    if(!state){
      state = {
        tasks: [],
        done: [],
        currentId: null,
        startCounts: { tasks: 0, eth: 0 },
        timer: { taskId: null, elapsedMs: 0, running: false }
      };
    }

    let notes = loadJSON(K.notes, []);
    let history = loadJSON(K.history, {}); // "YYYY-MM-DD": {ethSmashed, tasksDone, msWorked, exports:[]}
    let kiff = { ...DEFAULT_KIFF, ...(loadJSON(K.kiff, null) || {}) };
    let habits = { ...DEFAULT_HABITS, ...(loadJSON(K.habits, null) || {}) };

    function ensureDay(){
      const k = todayKey();
      if(!history[k]){
        history[k] = { ethSmashed:0, tasksDone:0, msWorked:0 };
      }
      if(!habits.marksByDay[k]) habits.marksByDay[k] = {};
    }

    /* =========================
       DOM
       ========================= */
    const body = document.body;

    const btnMenu = document.getElementById("btnMenu");
    const btnBottomMenu = document.getElementById("btnBottomMenu");
    const btnBottomNote = document.getElementById("btnBottomNote");
    const btnBottomFocus = document.getElementById("btnBottomFocus");

    const btnReset = document.getElementById("btnReset");
    const btnFocus = document.getElementById("btnFocus");
    const focusExit = document.getElementById("focusExit");
    const btnExitFocus = document.getElementById("btnExitFocus");

    const hudTasks = document.getElementById("hudTasks");
    const hudEth = document.getElementById("hudEth");
    const hudDone = document.getElementById("hudDone");
    const hudTimer = document.getElementById("hudTimer");

    const bigFill = document.getElementById("bigFill");
    const bigPct = document.getElementById("bigPct");

    const taskNameEl = document.getElementById("taskName");
    const taskSub = document.getElementById("taskSub");
    const metaCat = document.getElementById("metaCat");
    const metaEst = document.getElementById("metaEst");

    const ethBox = document.getElementById("ethBox");
    const ethNowEl = document.getElementById("ethNow");
    const ethStartEl = document.getElementById("ethStart");
    const ethMinutesEl = document.getElementById("ethMinutes");
    const ethFill = document.getElementById("ethFill");
    const ethTicks = document.getElementById("ethTicks");

    const btnRoulette = document.getElementById("btnRoulette");
    const rouletteWheel = document.getElementById("rouletteWheel");
    const btnSmash = document.getElementById("btnSmash");

    const drawerOverlay = document.getElementById("drawerOverlay");
    const btnDrawerClose = document.getElementById("btnDrawerClose");
    const drawerTabs = document.getElementById("drawerTabs");
    const drawerPanels = document.getElementById("drawerPanels");

    const themeLight = document.getElementById("themeLight");
    const themeDark = document.getElementById("themeDark");

    const celebrateOverlay = document.getElementById("celebrateOverlay");
    const celebrateTitle = document.getElementById("celebrateTitle");
    const celebrateSub = document.getElementById("celebrateSub");

    /* =========================
       Theme / Focus
       ========================= */
    function setTheme(theme){
      settings.theme = theme;
      body.setAttribute("data-theme", theme);
      themeLight.classList.toggle("active", theme==="light");
      themeDark.classList.toggle("active", theme==="dark");
      saveJSON(K.settings, settings);
    }
    function setFocus(on){
      settings.focus = on ? 1 : 0;
      body.setAttribute("data-focus", settings.focus);
      saveJSON(K.settings, settings);
    }

    /* =========================
       Drawer UI builders
       ========================= */
    function buildDrawer(){
      drawerTabs.innerHTML = "";
      drawerPanels.innerHTML = "";

      for(const t of TAB_DEFS){
        const tab = document.createElement("div");
        tab.className = "tab";
        tab.textContent = t.label;
        tab.dataset.key = t.key;
        tab.onclick = () => selectDrawerTab(t.key);
        drawerTabs.appendChild(tab);

        const panel = document.createElement("div");
        panel.id = "panel-"+t.key;
        panel.style.display = "none";
        drawerPanels.appendChild(panel);
      }

      // default tab
      selectDrawerTab("inbox");
    }

    function selectDrawerTab(key){
      [...drawerTabs.children].forEach(el => el.classList.toggle("active", el.dataset.key===key));
      [...drawerPanels.children].forEach(p => p.style.display = (p.id==="panel-"+key) ? "" : "none");

      // render content of that panel
      renderDrawerPanel(key);
    }

    function openDrawer(tabKey="inbox"){
      drawerOverlay.classList.add("show");
      selectDrawerTab(tabKey);
    }
    function closeDrawer(){
      drawerOverlay.classList.remove("show");
    }

    drawerOverlay.addEventListener("click", (e)=>{ if(e.target===drawerOverlay) closeDrawer(); });

    /* =========================
       Parsing: uppercase category headings + "task - 3"
       Rules you asked:
       - A line in ALL CAPS = category title (applies to following tasks until next ALL CAPS line)
       - Task line:
         "Nom t√¢che - 4" or "Nom t√¢che 4" => eth = 4
       - Priority may exist but optional (we store it if found)
       ========================= */
    function isAllCapsHeading(line){
      const s = line.trim();
      if(!s) return false;
      // Must contain letters, and no lowercase
      const hasLetter = /[A-Z√Ä-√ñ√ò-√û]/.test(s);
      const hasLower = /[a-z√†-√∂√∏-√ø]/.test(s);
      // If it's mostly caps and spaces/punct
      return hasLetter && !hasLower && s.length >= 3;
    }

    function normalizeCat(s){
      const x = String(s || "").trim();
      if(!x) return "Sans cat√©gorie";
      return x
        .replace(/\s{2,}/g, " ")
        .replace(/^#+\s*/,"")
        .trim();
    }

    function parseTaskLine(line, currentCat, ethDefault=1){
      let s = line.trim();
      if(!s) return null;

      // strip bullets
      s = s.replace(/^[-‚Ä¢*\u2022]\s+/, "").trim();
      if(!s) return null;

      // Priority detection (optional)
      // Examples accepted: "!","!!","prio:high","P1"
      let prio = null;
      if(/\bP1\b/i.test(s) || /\bprio\s*:\s*high\b/i.test(s) || /!!/.test(s)) prio = "high";
      else if(/\bP2\b/i.test(s) || /\bprio\s*:\s*med\b/i.test(s) || /!/.test(s)) prio = "med";

      // Eth: "- 3" or " 3" at end
      let eth = null;
      const mDash = s.match(/\s*-\s*(\d+)\s*$/);
      if(mDash) eth = parseInt(mDash[1],10);

      if(eth === null){
        const mEnd = s.match(/\s+(\d+)\s*$/);
        if(mEnd) eth = parseInt(mEnd[1],10);
      }

      // Clean title from eth tail if matched
      if(mDash) s = s.replace(/\s*-\s*\d+\s*$/,"").trim();
      else if(eth !== null) s = s.replace(/\s+\d+\s*$/,"").trim();

      if(!s) return null;

      const finalEth = clamp((Number.isFinite(eth) ? eth : ethDefault), 1, 999);

      return {
        id: uid(),
        title: s,
        cat: normalizeCat(currentCat),
        ethStart: finalEth,
        ethLeft: finalEth,
        pinned: false,
        prio,
        createdAt: nowISO()
      };
    }

    /* =========================
       Core: current task / selection
       ========================= */
    function recalcStartCountsIfNeeded(){
      if(state.startCounts.tasks === 0 && state.tasks.length > 0){
        state.startCounts.tasks = state.tasks.length;
        state.startCounts.eth = state.tasks.reduce((a,t)=>a+t.ethStart,0);
      }
    }

    function getActiveCatsSet(){
      const cats = [...new Set(state.tasks.map(t=>t.cat || "Sans cat√©gorie"))];
      if(!settings.activeCats || settings.activeCats.length===0){
        return new Set(cats);
      }
      return new Set(settings.activeCats);
    }

    function currentTask(){
      return state.tasks.find(t=>t.id===state.currentId) || null;
    }

    function ensureCurrent(){
      if(state.tasks.length===0){
        state.currentId = null;
        state.timer = { taskId:null, elapsedMs:0, running:false };
        saveJSON(K.state, state);
        return;
      }
      if(!state.currentId || !currentTask()){
        const t = pickNextTask();
        if(t){
          state.currentId = t.id;
          state.timer = { taskId: t.id, elapsedMs:0, running:true };
          saveJSON(K.state, state);
        }
      }
    }

    function pickNextTask(){
      const active = getActiveCatsSet();
      const pool = state.tasks.filter(t => active.has(t.cat || "Sans cat√©gorie"));
      if(pool.length===0) return state.tasks[0] || null;

      if(settings.sortMode==="alpha"){
        return [...pool].sort((a,b)=>a.title.localeCompare(b.title))[0];
      }
      if(settings.sortMode==="chrono"){
        return [...pool].sort((a,b)=>new Date(a.createdAt)-new Date(b.createdAt))[0];
      }
      if(settings.sortMode==="order"){
        return pool[0];
      }

      // roulette
      const bag = [];
      for(const t of pool){
        const w = t.pinned ? 3 : 1;
        for(let i=0;i<w;i++) bag.push(t);
      }
      return bag[Math.floor(Math.random()*bag.length)];
    }

    /* =========================
       Celebration
       ========================= */
    function showCelebration(subText){
      const phrase = kiff.celebrations[Math.floor(Math.random()*kiff.celebrations.length)] || "VICTOIRE";
      celebrateTitle.textContent = phrase;
      celebrateSub.textContent = subText || "";
      celebrateOverlay.classList.add("show");
      celebrateOverlay.setAttribute("aria-hidden","false");
    }
    function hideCelebration(){
      celebrateOverlay.classList.remove("show");
      celebrateOverlay.setAttribute("aria-hidden","true");
    }
    celebrateOverlay.addEventListener("click", hideCelebration);

    /* =========================
       Render main (FIXED bars)
       ========================= */
    function renderHUD(){
      const totalTasksStart = state.startCounts.tasks || (state.tasks.length + state.done.length);
      const totalEthStart = state.startCounts.eth || (state.tasks.reduce((a,t)=>a+t.ethStart,0) + state.done.reduce((a,t)=>a+t.ethStart,0));

      const tasksLeft = state.tasks.length;
      const ethLeft = state.tasks.reduce((a,t)=>a+t.ethLeft,0);
      const done = state.done.length;

      hudTasks.textContent = `${tasksLeft}/${totalTasksStart}`;
      hudEth.textContent = `${ethLeft}/${totalEthStart}`;
      hudDone.textContent = `${done}`;
    }

    function renderCurrent(){
      ensureCurrent();
      const t = currentTask();

      if(!t){
        taskNameEl.textContent = "Aucune t√¢che (Menu ‚Üí Inbox)";
        metaCat.textContent = "Cat ‚Äî";
        metaEst.textContent = "Estim√© ‚Äî";

        // Bars at 100% when empty
        bigFill.style.transform = "scaleX(1)";
        bigPct.textContent = "100%";
        ethNowEl.textContent = "0";
        ethStartEl.textContent = "0";
        ethMinutesEl.textContent = "0";
        ethFill.style.transform = "scaleX(1)";
        ethTicks.innerHTML = "";
        return;
      }

      taskNameEl.textContent = t.title;

      const minPer = settings.ethMinutesPer || 5;
      const estTotal = t.ethStart * minPer;
      metaCat.textContent = settings.showCategory ? `Cat ${t.cat}` : "Cat ‚Äî";
      metaEst.textContent = settings.showTimeRemaining ? `Estim√© ${estTotal} min` : "Estim√© ‚Äî";

      // IMPORTANT: bars must shrink with ethLeft
      const frac = (t.ethStart > 0) ? (t.ethLeft / t.ethStart) : 1;
      const f = clamp(frac, 0, 1);

      bigFill.style.transform = `scaleX(${f})`;
      bigPct.textContent = `${Math.round(f*100)}%`;

      ethNowEl.textContent = `${t.ethLeft}`;
      ethStartEl.textContent = `${t.ethStart}`;
      ethMinutesEl.textContent = `${t.ethLeft * minPer}`;

      ethFill.style.transform = `scaleX(${f})`;

      // ticks
      ethTicks.innerHTML = "";
      const n = clamp(t.ethStart, 1, 60);
      for(let i=0;i<n;i++){
        const sp = document.createElement("span");
        ethTicks.appendChild(sp);
      }
    }

    function renderAll(){
      ensureDay();
      recalcStartCountsIfNeeded();
      renderHUD();
      renderCurrent();
      saveJSON(K.settings, settings);
      saveJSON(K.state, state);
      saveJSON(K.notes, notes);
      saveJSON(K.history, history);
      saveJSON(K.kiff, kiff);
      saveJSON(K.habits, habits);
    }

    /* =========================
       Timer tick (elapsed on current task)
       ========================= */
    let lastTick = Date.now();
    function tick(){
      const now = Date.now();
      const dt = now - lastTick;
      lastTick = now;

      const t = currentTask();
      if(t && state.timer && state.timer.taskId===t.id && state.timer.running){
        state.timer.elapsedMs += dt;
        history[todayKey()].msWorked += dt;
        hudTimer.textContent = fmtMMSS(state.timer.elapsedMs);
      }else{
        hudTimer.textContent = "00:00";
      }

      // keep HUD live
      renderHUD();
      requestAnimationFrame(tick);
    }

    /* =========================
       Actions
       ========================= */
    function roulettePick(){
      btnRoulette.classList.add("spinning");
      setTimeout(()=>btnRoulette.classList.remove("spinning"), 920);

      const t = pickNextTask();
      if(!t){
        showCelebration("Aucune t√¢che active (filtre cat√©gories?)");
        return;
      }
      state.currentId = t.id;
      state.timer = { taskId: t.id, elapsedMs:0, running:true };
      renderAll();
    }

    function smashOne(){
      const t = currentTask();
      if(!t){
        showCelebration("Pas de t√¢che. Inbox d‚Äôabord.");
        return;
      }

      if(t.ethLeft > 0){
        t.ethLeft -= 1;
        history[todayKey()].ethSmashed += 1;

        if(t.ethLeft <= 0){
          t.ethLeft = 0;
          t.doneAt = nowISO();
          state.done.push(t);
          state.tasks = state.tasks.filter(x=>x.id!==t.id);
          history[todayKey()].tasksDone += 1;

          // choose next task
          state.currentId = null;
          state.timer = { taskId:null, elapsedMs:0, running:false };
          ensureCurrent();

          showCelebration("T√¢che termin√©e. L‚Äôennemi recule.");
        }else{
          showCelebration("+1 √©thorion d√©gomm√©");
        }

        renderAll(); // <-- FIX: update bars immediately
      }
    }

    function resetRun(){
      // Reset = reset "done" counter + define new startCounts on remaining tasks
      // DOES NOT restore ethLeft to ethStart (we can add an option if you want later)
      if(!confirm("Reset du run (compteur 'Faits' √† z√©ro). Les t√¢ches restent. Notes restent.")) return;

      state.done = [];
      state.startCounts.tasks = state.tasks.length;
      state.startCounts.eth = state.tasks.reduce((a,t)=>a+t.ethStart,0);

      // keep current task; reset its timer
      const t = currentTask();
      state.timer = t ? { taskId:t.id, elapsedMs:0, running:true } : { taskId:null, elapsedMs:0, running:false };

      renderAll();
    }

    /* =========================
       Drawer panels
       ========================= */
    function renderDrawerPanel(key){
      const panel = document.getElementById("panel-"+key);
      panel.innerHTML = "";

      if(key==="inbox") panel.appendChild(buildInboxPanel());
      if(key==="liste") panel.appendChild(buildListPanel());
      if(key==="kiff") panel.appendChild(buildKiffPanel());
      if(key==="notes") panel.appendChild(buildNotesPanel());
      if(key==="habits") panel.appendChild(buildHabitsPanel());
      if(key==="hist") panel.appendChild(buildHistPanel());
      if(key==="rapport") panel.appendChild(buildRapportPanel());
      if(key==="params") panel.appendChild(buildParamsPanel());
    }

    function mkCard(title, innerHTML){
      const c = document.createElement("div");
      c.className = "card";
      c.innerHTML = `<p class="cardTitle">${escapeHTML(title)}</p>` + innerHTML;
      return c;
    }

    /* --- Inbox panel: uppercase categories + task - 3 --- */
    function buildInboxPanel(){
      const wrap = document.createElement("div");

      const c1 = mkCard("Importer / coller une liste", `
        <textarea id="inboxText" placeholder="R√®gles :
- TITRE EN MAJUSCULE = cat√©gorie
- T√¢che - 3   => 3 √©thorions
- T√¢che 3     => 3 √©thorions
Exemple :

APPELS
Appeler Hugo - 2
Appeler Samira 3

QUI FONCE
Envoyer mail X - 1
"></textarea>

        <div class="row" style="margin-top:10px;">
          <input id="inboxDefaultEth" type="number" min="1" value="1" />
          <select id="inboxSortMode">
            <option value="roulette">Mode s√©lection: roulette</option>
            <option value="order">Mode s√©lection: ordre</option>
            <option value="alpha">Mode s√©lection: alpha</option>
            <option value="chrono">Mode s√©lection: chrono</option>
          </select>
        </div>

        <div class="row" style="margin-top:10px;">
          <button class="btn primary" id="btnImport">Importer</button>
          <button class="btn" id="btnClearInbox">Vider</button>
        </div>

        <div class="help" style="margin-top:10px;">
          Astuce : une cat√©gorie en majuscules s‚Äôapplique √† toutes les lignes suivantes jusqu‚Äô√† la prochaine cat√©gorie.
        </div>
      `);

      wrap.appendChild(c1);

      // Wire events after inserted
      setTimeout(() => {
        const inboxText = document.getElementById("inboxText");
        const inboxDefaultEth = document.getElementById("inboxDefaultEth");
        const inboxSortMode = document.getElementById("inboxSortMode");
        const btnImport = document.getElementById("btnImport");
        const btnClearInbox = document.getElementById("btnClearInbox");

        inboxSortMode.value = settings.sortMode;

        btnClearInbox.onclick = () => { inboxText.value = ""; };

        btnImport.onclick = () => {
          const raw = inboxText.value || "";
          const lines = raw.split(/\r?\n/);
          let currentCat = "Sans cat√©gorie";
          const ethDef = parseInt(inboxDefaultEth.value,10);
          const ethDefaultSafe = Number.isFinite(ethDef) && ethDef>0 ? ethDef : 1;

          const added = [];
          for(const line0 of lines){
            const line = line0.trim();
            if(!line) continue;

            if(isAllCapsHeading(line)){
              currentCat = normalizeCat(line);
              continue;
            }
            const t = parseTaskLine(line, currentCat, ethDefaultSafe);
            if(t) added.push(t);
          }

          if(added.length===0){
            showCelebration("Rien √† importer.");
            return;
          }

          state.tasks.push(...added);
          // reset start counts to include new tasks
          state.startCounts.tasks = state.tasks.length;
          state.startCounts.eth = state.tasks.reduce((a,t)=>a+t.ethStart,0);

          // apply sort mode choice
          settings.sortMode = inboxSortMode.value;
          saveJSON(K.settings, settings);

          ensureCurrent();
          renderAll();
          showCelebration(`${added.length} t√¢che(s) import√©e(s)`);
        };

      }, 0);

      return wrap;
    }

    /* --- Liste panel: minimal actions only (up/down/edit) + active cats --- */
    function buildListPanel(){
      const wrap = document.createElement("div");

      const cats = [...new Set(state.tasks.map(t=>t.cat || "Sans cat√©gorie"))].sort((a,b)=>a.localeCompare(b));
      const active = getActiveCatsSet();

      const cFilter = mkCard("Cat√©gories actives", `
        <div id="catFilterRow" class="row"></div>
        <div class="help" style="margin-top:10px;">
          Les cat√©gories inactives ne sont pas tir√©es par la roulette / s√©lection.
        </div>
      `);

      wrap.appendChild(cFilter);

      const cList = mkCard("T√¢ches", `<div id="taskList"></div>`);
      wrap.appendChild(cList);

      setTimeout(() => {
        const row = document.getElementById("catFilterRow");
        row.innerHTML = "";
        for(const c of cats){
          const b = document.createElement("button");
          b.className = "btn small";
          const on = active.has(c);
          b.textContent = (on ? "[x] " : "[ ] ") + c;
          b.onclick = () => {
            let next = settings.activeCats;
            if(!next || next.length===0) next = [...cats];
            else next = [...next];

            if(next.includes(c)) next = next.filter(x=>x!==c);
            else next.push(c);

            settings.activeCats = next;
            saveJSON(K.settings, settings);
            renderDrawerPanel("liste");
          };
          row.appendChild(b);
        }

        const list = document.getElementById("taskList");
        list.innerHTML = "";

        for(const t of state.tasks){
          const item = document.createElement("div");
          item.className = "taskItem";

          const left = document.createElement("div");
          left.className = "taskLeft";
          left.innerHTML = `
            <div class="name">${escapeHTML(t.title)}</div>
            <div class="sub">${escapeHTML(t.cat)} ¬∑ eth ${t.ethLeft}/${t.ethStart}</div>
          `;

          const act = document.createElement("div");
          act.className = "taskAct";

          const up = document.createElement("button");
          up.className = "iconBtn";
          up.textContent = "‚Üë";
          up.onclick = () => { moveTask(t.id, -1); renderDrawerPanel("liste"); renderAll(); };

          const down = document.createElement("button");
          down.className = "iconBtn";
          down.textContent = "‚Üì";
          down.onclick = () => { moveTask(t.id, +1); renderDrawerPanel("liste"); renderAll(); };

          const edit = document.createElement("button");
          edit.className = "iconBtn";
          edit.textContent = "edit";
          edit.onclick = () => {
            const nv = prompt("Modifier le titre :", t.title);
            if(nv===null) return;
            const cleaned = nv.trim();
            if(!cleaned) return;
            t.title = cleaned;
            renderDrawerPanel("liste");
            renderAll();
          };

          const del = document.createElement("button");
          del.className = "iconBtn";
          del.textContent = "del";
          del.onclick = () => {
            if(!confirm("Supprimer cette t√¢che ?")) return;
            deleteTask(t.id);
            renderDrawerPanel("liste");
            renderAll();
          };

          act.appendChild(up);
          act.appendChild(down);
          act.appendChild(edit);
          act.appendChild(del);

          item.appendChild(left);
          item.appendChild(act);
          list.appendChild(item);
        }

        if(state.tasks.length===0){
          const empty = document.createElement("div");
          empty.className = "help";
          empty.textContent = "Liste vide. Inbox pour importer.";
          list.appendChild(empty);
        }
      }, 0);

      return wrap;
    }

    function moveTask(id, dir){
      const idx = state.tasks.findIndex(x=>x.id===id);
      if(idx<0) return;
      const newIdx = clamp(idx + dir, 0, state.tasks.length-1);
      if(newIdx===idx) return;
      const [x] = state.tasks.splice(idx,1);
      state.tasks.splice(newIdx,0,x);
      saveJSON(K.state, state);
    }

    function deleteTask(id){
      state.tasks = state.tasks.filter(x=>x.id!==id);
      if(state.currentId===id){
        state.currentId = null;
        state.timer = { taskId:null, elapsedMs:0, running:false };
        ensureCurrent();
      }
      saveJSON(K.state, state);
    }

    /* --- Kiffance panel: restore + perfect --- */
    function buildKiffPanel(){
      const wrap = document.createElement("div");

      const c1 = mkCard("C√©l√©brations", `
        <div class="help">Ces phrases alimentent le grand √©cran de victoire.</div>
        <textarea id="kiffCelebrations" placeholder="Une phrase par ligne"></textarea>
        <div class="row" style="margin-top:10px;">
          <button class="btn primary" id="btnSaveKiff">Enregistrer</button>
          <button class="btn" id="btnTestKiff">Tester</button>
          <button class="btn" id="btnResetKiff">R√©initialiser</button>
        </div>
      `);

      const c2 = mkCard("Encouragements (option)", `
        <div class="help">Optionnel. (On garde √ßa pr√™t, m√™me si affichage d√©sactiv√© par d√©faut.)</div>
        <textarea id="kiffEncouragements" placeholder="Une phrase par ligne"></textarea>
        <div class="row" style="margin-top:10px;">
          <input id="kiffFreq" type="number" min="0" step="1" />
          <div class="help" style="flex:2;">Fr√©quence (minutes). 0 = off.</div>
        </div>
      `);

      wrap.appendChild(c1);
      wrap.appendChild(c2);

      setTimeout(() => {
        const taC = document.getElementById("kiffCelebrations");
        const taE = document.getElementById("kiffEncouragements");
        const freq = document.getElementById("kiffFreq");

        taC.value = (kiff.celebrations || []).join("\n");
        taE.value = (kiff.encouragements || []).join("\n");
        freq.value = String(kiff.encouragementFrequencyMin ?? 0);

        document.getElementById("btnSaveKiff").onclick = () => {
          kiff.celebrations = (taC.value||"").split(/\r?\n/).map(s=>s.trim()).filter(Boolean);
          kiff.encouragements = (taE.value||"").split(/\r?\n/).map(s=>s.trim()).filter(Boolean);
          kiff.encouragementFrequencyMin = parseInt(freq.value,10) || 0;
          saveJSON(K.kiff, kiff);
          showCelebration("Kiffance sauvegard√©e.");
        };

        document.getElementById("btnTestKiff").onclick = () => {
          showCelebration("Test de c√©l√©bration.");
        };

        document.getElementById("btnResetKiff").onclick = () => {
          if(!confirm("R√©initialiser la banque Kiffance ?")) return;
          kiff = JSON.parse(JSON.stringify(DEFAULT_KIFF));
          saveJSON(K.kiff, kiff);
          renderDrawerPanel("kiff");
          showCelebration("Kiffance r√©initialis√©e.");
        };
      }, 0);

      return wrap;
    }

    /* --- Notes panel (persist even resets) --- */
    function buildNotesPanel(){
      const wrap = document.createElement("div");

      const c1 = mkCard("Ajouter une note", `
        <textarea id="noteText" placeholder="Note persistante (ne dispara√Æt pas au reset)"></textarea>
        <div class="row" style="margin-top:10px;">
          <button class="btn primary" id="btnAddNote">Ajouter</button>
          <button class="btn" id="btnExportNotes">Exporter notes</button>
          <button class="btn" id="btnClearNotes">Effacer notes</button>
        </div>
      `);

      const c2 = mkCard("Notes sauvegard√©es", `<div class="noteGrid" id="notesGrid"></div>`);

      wrap.appendChild(c1);
      wrap.appendChild(c2);

      setTimeout(() => {
        const noteText = document.getElementById("noteText");
        document.getElementById("btnAddNote").onclick = () => {
          const txt = (noteText.value||"").trim();
          if(!txt) return;
          notes.push({ id: uid(), at: nowISO(), text: txt });
          saveJSON(K.notes, notes);
          noteText.value = "";
          renderDrawerPanel("notes");
          showCelebration("Note captur√©e.");
        };

        document.getElementById("btnClearNotes").onclick = () => {
          if(!confirm("Effacer toutes les notes ?")) return;
          notes = [];
          saveJSON(K.notes, notes);
          renderDrawerPanel("notes");
          showCelebration("Notes effac√©es.");
        };

        document.getElementById("btnExportNotes").onclick = () => {
          exportJSON({ exportedAt: nowISO(), notes }, `eliminator_notes_${todayKey()}.json`);
        };

        const grid = document.getElementById("notesGrid");
        const arr = [...notes].sort((a,b)=>new Date(b.at)-new Date(a.at));
        grid.innerHTML = "";
        for(const n of arr){
          const d = document.createElement("div");
          d.className = "note";
          d.innerHTML = `
            <div class="stamp">${escapeHTML(new Date(n.at).toLocaleString())}</div>
            <div class="txt">${escapeHTML(n.text)}</div>
          `;
          grid.appendChild(d);
        }
        if(arr.length===0){
          const empty = document.createElement("div");
          empty.className = "help";
          empty.textContent = "Aucune note.";
          grid.appendChild(empty);
        }
      }, 0);

      return wrap;
    }

    /* --- Habits panel: tracked per day + used in report --- */
    function buildHabitsPanel(){
      const wrap = document.createElement("div");

      const c1 = mkCard("Param√®tres habitudes", `
        <div class="row">
          <input id="habitSlots" type="number" min="3" max="20" />
          <button class="btn primary" id="btnSaveHabitSlots">Enregistrer</button>
        </div>
        <div class="help" style="margin-top:10px;">
          Nombre de cases par habitude et par jour. (ex: 8 verres d‚Äôeau)
        </div>
      `);

      const c2 = mkCard("Ajouter une habitude", `
        <div class="row">
          <input id="habitName" placeholder="Ex: boire des verres d‚Äôeau" />
          <button class="btn primary" id="btnAddHabit">Ajouter</button>
        </div>
      `);

      const c3 = mkCard("Aujourd‚Äôhui", `<div id="habitsList"></div>`);

      wrap.appendChild(c1);
      wrap.appendChild(c2);
      wrap.appendChild(c3);

      setTimeout(() => {
        ensureDay();

        const slotsInput = document.getElementById("habitSlots");
        slotsInput.value = String(habits.slots || 8);

        document.getElementById("btnSaveHabitSlots").onclick = () => {
          const n = parseInt(slotsInput.value,10);
          habits.slots = clamp(Number.isFinite(n)?n:8, 3, 20);
          saveJSON(K.habits, habits);
          renderDrawerPanel("habits");
          showCelebration("Habitudes param√©tr√©es.");
        };

        document.getElementById("btnAddHabit").onclick = () => {
          const nm = (document.getElementById("habitName").value||"").trim();
          if(!nm) return;
          habits.habits.push({ id: uid(), name: nm, createdAt: nowISO() });
          saveJSON(K.habits, habits);
          renderDrawerPanel("habits");
          showCelebration("Habitude ajout√©e.");
        };

        const list = document.getElementById("habitsList");
        list.innerHTML = "";

        const day = todayKey();
        const marks = habits.marksByDay[day] || (habits.marksByDay[day] = {});
        const slots = habits.slots || 8;

        for(const h of habits.habits){
          if(!marks[h.id]) marks[h.id] = Array.from({length: slots}, ()=>0);

          const filled = marks[h.id].reduce((a,x)=>a+(x?1:0),0);
          const pct = Math.round((filled/slots)*100);

          const item = document.createElement("div");
          item.className = "habitItem";

          const top = document.createElement("div");
          top.className = "habitTop";
          top.innerHTML = `
            <div>
              <p class="habitName">${escapeHTML(h.name)}</p>
            </div>
            <div class="habitMeta">${filled}/${slots} ¬∑ ${pct}%</div>
          `;

          const checks = document.createElement("div");
          checks.className = "habitChecks";

          for(let i=0;i<slots;i++){
            const c = document.createElement("div");
            c.className = "check" + (marks[h.id][i] ? " on" : "");
            c.textContent = marks[h.id][i] ? "x" : "";
            c.onclick = () => {
              marks[h.id][i] = marks[h.id][i] ? 0 : 1;
              habits.marksByDay[day] = marks;
              saveJSON(K.habits, habits);
              renderDrawerPanel("habits");
            };
            checks.appendChild(c);
          }

          const row = document.createElement("div");
          row.className = "row";
          row.style.marginTop = "10px";
          row.innerHTML = `
            <button class="btn small" id="btnHabitReset_${h.id}">Reset</button>
            <button class="btn small" id="btnHabitDel_${h.id}">Supprimer</button>
          `;

          item.appendChild(top);
          item.appendChild(checks);
          item.appendChild(row);
          list.appendChild(item);

          setTimeout(() => {
            const r = document.getElementById(`btnHabitReset_${h.id}`);
            const d = document.getElementById(`btnHabitDel_${h.id}`);

            r.onclick = () => {
              marks[h.id] = Array.from({length: slots}, ()=>0);
              saveJSON(K.habits, habits);
              renderDrawerPanel("habits");
            };

            d.onclick = () => {
              if(!confirm("Supprimer cette habitude ?")) return;
              habits.habits = habits.habits.filter(x=>x.id!==h.id);
              // remove from all days
              for(const dayKey of Object.keys(habits.marksByDay)){
                if(habits.marksByDay[dayKey] && habits.marksByDay[dayKey][h.id]){
                  delete habits.marksByDay[dayKey][h.id];
                }
              }
              saveJSON(K.habits, habits);
              renderDrawerPanel("habits");
            };
          },0);
        }

        if(habits.habits.length===0){
          const empty = document.createElement("div");
          empty.className = "help";
          empty.textContent = "Aucune habitude. Ajoute-en une ci-dessus.";
          list.appendChild(empty);
        }
      }, 0);

      return wrap;
    }

    /* --- Historique panel: daily/weekly/monthly views + export done/remaining --- */
    function buildHistPanel(){
      const wrap = document.createElement("div");

      const c1 = mkCard("Exports rapides", `
        <div class="row">
          <button class="btn primary" id="btnExportToday">Exporter aujourd‚Äôhui</button>
          <button class="btn" id="btnExportRun">Exporter run (faits + restants)</button>
        </div>
        <div class="row" style="margin-top:10px;">
          <button class="btn" id="btnExportWeek">Exporter semaine</button>
          <button class="btn" id="btnExportMonth">Exporter mois</button>
        </div>
      `);

      const c2 = mkCard("R√©sum√© (aujourd‚Äôhui)", `<div class="help" id="histSummary"></div>`);

      wrap.appendChild(c1);
      wrap.appendChild(c2);

      setTimeout(() => {
        ensureDay();
        const day = todayKey();
        const h = history[day];

        // Habits summary today
        const habToday = summarizeHabits(day);

        document.getElementById("histSummary").textContent =
`Date: ${day}
√âthorions d√©gomm√©s: ${h.ethSmashed}
T√¢ches termin√©es: ${h.tasksDone}
Temps cumul√© (approx): ${fmtMMSS(h.msWorked)}
Habitudes (aujourd‚Äôhui):
${habToday.text}`;

        document.getElementById("btnExportToday").onclick = () => {
          exportJSON(buildDailyReport(day), `eliminator_journal_${day}.json`);
        };

        document.getElementById("btnExportRun").onclick = () => {
          exportJSON(buildRunExport(), `eliminator_run_${todayKey()}.json`);
        };

        document.getElementById("btnExportWeek").onclick = () => {
          exportJSON(buildRangeExport(7), `eliminator_semaine_${todayKey()}.json`);
        };

        document.getElementById("btnExportMonth").onclick = () => {
          exportJSON(buildRangeExport(30), `eliminator_mois_${todayKey()}.json`);
        };
      }, 0);

      return wrap;
    }

    /* --- Rapport panel: daily/weekly/monthly text view + export --- */
    function buildRapportPanel(){
      const wrap = document.createElement("div");

      const c1 = mkCard("Rapport (texte)", `
        <div class="row">
          <select id="repRange">
            <option value="day">Journalier</option>
            <option value="week">Hebdomadaire</option>
            <option value="month">Mensuel</option>
          </select>
          <button class="btn primary" id="btnGenRep">G√©n√©rer</button>
          <button class="btn" id="btnExportRep">Exporter</button>
        </div>
        <textarea id="repText" style="margin-top:10px; min-height:240px;"></textarea>
      `);

      wrap.appendChild(c1);

      setTimeout(() => {
        const repRange = document.getElementById("repRange");
        const repText = document.getElementById("repText");

        function gen(){
          const r = repRange.value;
          if(r==="day"){
            const day = todayKey();
            repText.value = buildReportText([day]);
          }else if(r==="week"){
            repText.value = buildReportText(lastNDays(7));
          }else{
            repText.value = buildReportText(lastNDays(30));
          }
        }

        document.getElementById("btnGenRep").onclick = gen;

        document.getElementById("btnExportRep").onclick = () => {
          const r = repRange.value;
          const name = r==="day" ? "journal" : (r==="week" ? "semaine" : "mois");
          exportText(repText.value || "", `eliminator_rapport_${name}_${todayKey()}.txt`);
        };

        gen();
      }, 0);

      return wrap;
    }

    /* --- Params panel: display modes + eth minutes + sort mode --- */
    function buildParamsPanel(){
      const wrap = document.createElement("div");

      const c1 = mkCard("Affichage", `
        <div class="row">
          <select id="sortMode">
            <option value="roulette">S√©lection: roulette</option>
            <option value="order">S√©lection: ordre</option>
            <option value="alpha">S√©lection: alpha</option>
            <option value="chrono">S√©lection: chrono</option>
          </select>
          <select id="ethMinutesPer">
            <option value="5">1 √©thorion = 5 min</option>
            <option value="10">1 √©thorion = 10 min</option>
            <option value="15">1 √©thorion = 15 min</option>
          </select>
        </div>

        <div class="row" style="margin-top:10px;">
          <button class="btn small" id="toggleMeta">Meta on/off</button>
          <button class="btn small" id="toggleCat">Cat on/off</button>
          <button class="btn small" id="toggleTime">Estim√© on/off</button>
        </div>

        <div class="help" style="margin-top:10px;">
          Objectif: minimal vitr√©. (Ici tu choisis ce qui est visible en mode normal.)
        </div>
      `);

      const c2 = mkCard("Actions", `
        <div class="row">
          <button class="btn" id="btnResetRun">Reset run</button>
          <button class="btn" id="btnNukeTasks">Tout effacer (t√¢ches + stats) (notes conserv√©es)</button>
        </div>
      `);

      wrap.appendChild(c1);
      wrap.appendChild(c2);

      setTimeout(() => {
        const sortMode = document.getElementById("sortMode");
        const ethMinutesPer = document.getElementById("ethMinutesPer");

        sortMode.value = settings.sortMode;
        ethMinutesPer.value = String(settings.ethMinutesPer || 5);

        sortMode.onchange = () => {
          settings.sortMode = sortMode.value;
          saveJSON(K.settings, settings);
        };
        ethMinutesPer.onchange = () => {
          settings.ethMinutesPer = parseInt(ethMinutesPer.value,10) || 5;
          saveJSON(K.settings, settings);
          renderAll();
        };

        document.getElementById("toggleMeta").onclick = () => {
          settings.showMeta = settings.showMeta ? 0 : 1;
          taskSub.style.display = settings.showMeta ? "" : "none";
          saveJSON(K.settings, settings);
        };
        document.getElementById("toggleCat").onclick = () => {
          settings.showCategory = settings.showCategory ? 0 : 1;
          saveJSON(K.settings, settings);
          renderAll();
        };
        document.getElementById("toggleTime").onclick = () => {
          settings.showTimeRemaining = settings.showTimeRemaining ? 0 : 1;
          saveJSON(K.settings, settings);
          renderAll();
        };

        document.getElementById("btnResetRun").onclick = resetRun;

        document.getElementById("btnNukeTasks").onclick = () => {
          if(!confirm("Effacer t√¢ches + stats (notes conserv√©es) ?")) return;
          state = {
            tasks: [],
            done: [],
            currentId: null,
            startCounts: { tasks: 0, eth: 0 },
            timer: { taskId:null, elapsedMs:0, running:false }
          };
          history = {};
          saveJSON(K.state, state);
          saveJSON(K.history, history);
          renderAll();
          showCelebration("Nettoyage total. Notes intactes.");
        };
      }, 0);

      return wrap;
    }

    /* =========================
       Reports helpers
       ========================= */
    function lastNDays(n){
      const out = [];
      for(let i=0;i<n;i++){
        const d = new Date();
        d.setDate(d.getDate()-i);
        out.push(d.toISOString().slice(0,10));
      }
      return out;
    }

    function summarizeHabits(day){
      const slots = habits.slots || 8;
      const marks = (habits.marksByDay && habits.marksByDay[day]) ? habits.marksByDay[day] : {};
      if(!habits.habits || habits.habits.length===0){
        return { text: "- aucune habitude d√©finie", items: [] };
      }
      const items = [];
      for(const h of habits.habits){
        const arr = marks[h.id] || Array.from({length: slots}, ()=>0);
        const done = arr.reduce((a,x)=>a+(x?1:0),0);
        const pct = Math.round((done/slots)*100);
        items.push({ name:h.name, done, slots, pct });
      }
      const text = items.map(it => `- ${it.name}: ${it.done}/${it.slots} (${it.pct}%)`).join("\n");
      return { text, items };
    }

    function buildDailyReport(day){
      ensureDay();
      const h = history[day] || { ethSmashed:0, tasksDone:0, msWorked:0 };
      const hab = summarizeHabits(day);
      return {
        day,
        stats: h,
        habits: hab.items,
        run_export: buildRunExport()
      };
    }

    function buildRunExport(){
      // Export: tasks done + remaining (what you requested)
      const doneTasks = [...state.done].map(t => ({
        title: t.title, cat: t.cat, ethStart: t.ethStart, doneAt: t.doneAt || null
      }));
      const remainingTasks = [...state.tasks].map(t => ({
        title: t.title, cat: t.cat, ethStart: t.ethStart, ethLeft: t.ethLeft, createdAt: t.createdAt
      }));

      return {
        exportedAt: nowISO(),
        tasks_done_count: state.done.length,
        tasks_remaining_count: state.tasks.length,
        tasks_done: doneTasks,
        tasks_remaining: remainingTasks
      };
    }

    function buildRangeExport(nDays){
      const days = lastNDays(nDays);
      const daily = [];
      for(const d of days){
        daily.push(buildDailyReport(d));
      }
      return { exportedAt: nowISO(), range_days: days, daily };
    }

    function buildReportText(days){
      const lines = [];
      lines.push(`ELIMINATOR ‚Äî RAPPORT (${days.length} jour(s))`);
      lines.push(`G√©n√©r√©: ${new Date().toLocaleString()}`);
      lines.push("");

      let eth=0, tasks=0, ms=0;
      for(const d of days){
        const h = history[d];
        if(!h) continue;
        eth += (h.ethSmashed||0);
        tasks += (h.tasksDone||0);
        ms += (h.msWorked||0);
      }

      lines.push(`Total √©thorions d√©gomm√©s: ${eth}`);
      lines.push(`Total t√¢ches termin√©es: ${tasks}`);
      lines.push(`Temps cumul√© (approx): ${fmtMMSS(ms)}`);
      lines.push("");

      // Habits overview (today only detailed; for weekly/monthly give average)
      if(habits.habits && habits.habits.length>0){
        lines.push("Habitudes (aper√ßu):");
        const slots = habits.slots || 8;
        for(const h of habits.habits){
          let doneSum=0, denom=0;
          for(const d of days){
            const marks = (habits.marksByDay && habits.marksByDay[d]) ? habits.marksByDay[d][h.id] : null;
            if(marks){
              doneSum += marks.reduce((a,x)=>a+(x?1:0),0);
              denom += marks.length;
            }
          }
          if(denom===0){
            lines.push(`- ${h.name}: aucun pointage`);
          }else{
            const pct = Math.round((doneSum/denom)*100);
            lines.push(`- ${h.name}: ${doneSum}/${denom} (${pct}%)`);
          }
        }
        lines.push("");
      }

      // Today detail
      const today = todayKey();
      lines.push(`D√©tail du jour (${today}):`);
      const h0 = history[today] || {ethSmashed:0,tasksDone:0,msWorked:0};
      lines.push(`- √âthorions: ${h0.ethSmashed}`);
      lines.push(`- T√¢ches: ${h0.tasksDone}`);
      lines.push(`- Temps: ${fmtMMSS(h0.msWorked)}`);
      const habToday = summarizeHabits(today);
      lines.push(`- Habitudes:\n${habToday.text}`);
      lines.push("");

      // Run (current)
      lines.push("Run actuel:");
      lines.push(`- T√¢ches restantes: ${state.tasks.length}`);
      lines.push(`- T√¢ches faites: ${state.done.length}`);
      lines.push(`- √âthorions restants: ${state.tasks.reduce((a,t)=>a+t.ethLeft,0)}`);
      lines.push("");

      return lines.join("\n");
    }

    function exportJSON(obj, filename){
      const blob = new Blob([JSON.stringify(obj,null,2)], {type:"application/json"});
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    }

    function exportText(text, filename){
      const blob = new Blob([text], {type:"text/plain"});
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    }

    /* =========================
       Wiring main buttons
       ========================= */
    btnMenu.onclick = () => openDrawer("inbox");
    btnBottomMenu.onclick = () => openDrawer("inbox");
    btnDrawerClose.onclick = closeDrawer;

    themeLight.onclick = () => setTheme("light");
    themeDark.onclick = () => setTheme("dark");

    btnReset.onclick = resetRun;

    btnFocus.onclick = () => setFocus(!(settings.focus===1));
    btnBottomFocus.onclick = () => setFocus(!(settings.focus===1));
    btnExitFocus.onclick = () => setFocus(0);

    btnBottomNote.onclick = () => openDrawer("notes");

    btnRoulette.onclick = roulettePick;
    btnSmash.onclick = smashOne;

    /* =========================
       Init
       ========================= */
    function applySettings(){
      setTheme(settings.theme || "light");
      setFocus(settings.focus===1);

      // apply meta visibility
      taskSub.style.display = settings.showMeta ? "" : "none";
    }

    ensureDay();
    buildDrawer();
    applySettings();
    recalcStartCountsIfNeeded();
    ensureCurrent();
    renderAll();
    tick();

  })();
  </script>
</body>
</html>
